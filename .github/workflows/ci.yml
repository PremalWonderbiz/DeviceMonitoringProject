name: Device Monitoring Monorepo CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # -------------------------------
  # Detect what changed
  # -------------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.filter.outputs.backend }}
      ui_changed: ${{ steps.filter.outputs.ui }}
      viz_changed: ${{ steps.filter.outputs.viz }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changes in backend and frontend
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'Backend/**'
            ui:
              - 'Frontend/device_monitoring_frontend/**'
            viz:
              - 'Frontend/device-monitoring-viz/**'

  # -------------------------------
  # Build & Test .NET Backend Services
  # -------------------------------
  backend-ci:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.backend_changed == 'true' }}
    runs-on: ubuntu-latest
  
    steps:
      - uses: actions/checkout@v4
  
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
  
      - name: Restore all backend projects
        run: |
          dotnet restore Backend/DeviceMonitoringProject
          dotnet restore Backend/AlarmService
          dotnet restore Backend/GatewayService/GatewayService
  
      - name: Build all backend projects
        run: |
          dotnet build Backend/DeviceMonitoringProject --no-restore --configuration Release
          dotnet build Backend/AlarmService --no-restore --configuration Release
          dotnet build Backend/GatewayService/GatewayService --no-restore --configuration Release
  
      - name: Run tests (if any)
        run: |
          for proj in Backend/*/*/*Tests.csproj; do
            if [ -f "$proj" ]; then
              dotnet test "$proj" --no-build --configuration Release
            fi
          done

  # -------------------------------
  # Frontend CI – device-monitoring-ui
  # -------------------------------
  ui-ci:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ui_changed == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 22.14.0
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0

      - name: Install dependencies
        working-directory: Frontend/device_monitoring_frontend
        run: npm install

      # - name: Lint (optional)
      #   working-directory: Frontend/device_monitoring_frontend
      #   run: npm run lint --if-present

      - name: Run tests (optional)
        working-directory: Frontend/device_monitoring_frontend
        run: npm test --if-present

      - name: Build Next.js app
        working-directory: Frontend/device_monitoring_frontend
        run: npm run build

  # -------------------------------
  # Frontend CI – device-monitoring-viz
  # -------------------------------
  viz-ci:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.viz_changed == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 22.14.0
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0

      - name: Install dependencies
        working-directory: Frontend/device-monitoring-viz
        run: npm install

      # - name: Lint (optional)
      #   working-directory: Frontend/device-monitoring-viz
      #   run: npm run lint --if-present

      - name: Build Viz Frontend
        working-directory: Frontend/device-monitoring-viz
        run: npm run build

  sonar-scan:
    needs: [detect-changes, backend-ci, ui-ci, viz-ci]
    runs-on: ubuntu-latest
    if: >
      always() && (
        needs.detect-changes.outputs.backend_changed == 'true' ||
        needs.detect-changes.outputs.ui_changed == 'true' ||
        needs.detect-changes.outputs.viz_changed == 'true'
      )
  
    env:
      SONAR_TOKEN: "sqp_ed60defccf6aee1511fdc50af1003312eb2a5d6e"
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
  
      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: ./
          args: >
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}
            -Dsonar.organization=premalwonderbiz
            -Dsonar.projectKey=PremalWonderbiz_DeviceMonitoringProject_9168aabf-fb1d-4707-8bae-a3bd072df572
            -Dsonar.projectName=DeviceMonitoringProject
            -Dsonar.projectVersion=1.0
            -Dsonar.modules=DeviceMonitoringProject,AlarmService,GatewayService,UI,Viz
            -DDeviceMonitoringProject.sonar.projectBaseDir=Backend/DeviceMonitoringProject
            -DAlarmService.sonar.projectBaseDir=Backend/AlarmService
            -DGatewayService.sonar.projectBaseDir=Backend/GatewayService/GatewayService
            -DUI.sonar.projectBaseDir=Frontend/device_monitoring_frontend
            -DViz.sonar.projectBaseDir=Frontend/device-monitoring-viz
            -Dsonar.sources=Backend,Frontend
            -Dsonar.exclusions=**/bin/**,**/obj/**,**/node_modules/**,**/.next/**,**/dist/**
            -Dsonar.coverage.exclusions=**Tests*.cs,**/Program.cs,**/Startup.cs,**/MainWindow.xaml.cs,**/Animations/**,**/Views/**,**/Windows/**,**/Models/**,**/Repositories/**,**/CustomAttributes/**
            -Dsonar.cs.opencover.reportsPaths=Backend/**/TestResults/*.opencover*.xml
            -Dsonar.javascript.lcov.reportPaths=Frontend/**/coverage/lcov.info
            -Dsonar.typescript.tsconfigPath=Frontend/**/tsconfig.json








