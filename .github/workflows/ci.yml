name: Device Monitoring Monorepo CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # -------------------------------
  # Detect what changed
  # -------------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.filter.outputs.backend }}
      ui_changed: ${{ steps.filter.outputs.ui }}
      viz_changed: ${{ steps.filter.outputs.viz }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changes in backend and frontend
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'Backend/**'
            ui:
              - 'Frontend/device_monitoring_frontend/**'
            viz:
              - 'Frontend/device-monitoring-viz/**'

  # -------------------------------
  # Build & Test .NET Backend Services
  # -------------------------------
  backend-ci:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.backend_changed == 'true' }}
    runs-on: ubuntu-latest
  
    steps:
      - uses: actions/checkout@v4
  
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
  
      - name: Restore all backend projects
        run: |
          dotnet restore Backend/DeviceMonitoringProject
          dotnet restore Backend/AlarmService
          dotnet restore Backend/GatewayService/GatewayService
  
      - name: Build all backend projects
        run: |
          dotnet build Backend/DeviceMonitoringProject --no-restore --configuration Release
          dotnet build Backend/AlarmService --no-restore --configuration Release
          dotnet build Backend/GatewayService/GatewayService --no-restore --configuration Release
  
      - name: Run tests (if any)
        run: |
          for proj in Backend/*/*/*Tests.csproj; do
            if [ -f "$proj" ]; then
              dotnet test "$proj" --no-build --configuration Release
            fi
          done

  # -------------------------------
  # Frontend CI – device-monitoring-ui
  # -------------------------------
  ui-ci:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ui_changed == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 22.14.0
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0

      - name: Install dependencies
        working-directory: Frontend/device_monitoring_frontend
        run: npm install

      # - name: Lint (optional)
      #   working-directory: Frontend/device_monitoring_frontend
      #   run: npm run lint --if-present

      - name: Run tests (optional)
        working-directory: Frontend/device_monitoring_frontend
        run: npm test --if-present

      - name: Build Next.js app
        working-directory: Frontend/device_monitoring_frontend
        run: npm run build

  # -------------------------------
  # Frontend CI – device-monitoring-viz
  # -------------------------------
  viz-ci:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.viz_changed == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 22.14.0
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0

      - name: Install dependencies
        working-directory: Frontend/device-monitoring-viz
        run: npm install

      # - name: Lint (optional)
      #   working-directory: Frontend/device-monitoring-viz
      #   run: npm run lint --if-present

      - name: Build Viz Frontend
        working-directory: Frontend/device-monitoring-viz
        run: npm run build

  sonar-scan:
    needs: [detect-changes,backend-ci, ui-ci, viz-ci]   # wait for all builds
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.viz_changed == 'true' }}
    steps:
      - uses: actions/checkout@v4

      # Set up Java for SonarScanner
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      # Install SonarScanner CLI
      - name: Install SonarScanner
        run: |
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.9.3.731-linux.zip
          unzip sonar-scanner-cli-4.9.3.731-linux.zip
          mv sonar-scanner-4.9.3.731-linux sonar-scanner

      # Run SonarQube Scan
      - name: Run SonarQube Scanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          ./sonar-scanner/bin/sonar-scanner \
            -Dsonar.projectKey=PremalWonderbiz_DeviceMonitoringProject_9168aabf-fb1d-4707-8bae-a3bd072df572 \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN

