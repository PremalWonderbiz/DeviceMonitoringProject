name: Detect Services & Projects

on:
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest

    outputs:
      backend_services: ${{ steps.backend_valid.outputs.backend_services }}
      changed_backend: ${{ steps.backend_changed.outputs }}
      frontend_projects: ${{ steps.frontend_valid.outputs.frontend_projects }}
      changed_frontend: ${{ steps.frontend_changed.outputs }}

    steps:
      # ----------------------------------------
      # Checkout
      # ----------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------
      # 1. Load unified config
      # ----------------------------------------
      - name: Load project configuration
        id: config
        run: |
          CONFIG="Configurations/projects.json"

          BACKEND=$(jq -c '.backend' "$CONFIG")
          FRONTEND=$(jq -c '.frontend' "$CONFIG")

          echo "backend=$BACKEND" >> "$GITHUB_OUTPUT"
          echo "frontend=$FRONTEND" >> "$GITHUB_OUTPUT"

          echo "Loaded backend entries: $BACKEND"
          echo "Loaded frontend entries: $FRONTEND"

      # ----------------------------------------
      # 2. Validate backend services (.sln required)
      # ----------------------------------------
      - name: Validate backend services
        id: backend_valid
        run: |
          VALID=()

          for service in $(echo '${{ steps.config.outputs.backend }}' | jq -r '.[]'); do
            if ls "$service"/*.sln >/dev/null 2>&1; then
              echo "VALID backend: $service"
              VALID+=("$service")
            else
              echo "INVALID backend (no .sln): $service"
            fi
          done

          JSON=$(printf "%s\n" "${VALID[@]}" | jq -R . | jq -s -c .)
          echo "backend_services=$JSON" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # 3. Build backend filters for paths-filter
      # ----------------------------------------
      - name: Build backend YAML filters
        id: backend_filter_yaml
        run: |
          SERVICES=$(echo '${{ steps.backend_valid.outputs.backend_services }}' | jq -r '.[]')
          echo "Building backend filters..."

          FILTERS=""
          for s in $SERVICES; do
            NAME=$(basename "$s")
            FILTERS="$FILTERS
            $NAME:
              - \"$s/**\""
                    done
          
                    FILTERS_ESCAPED=$(echo "$FILTERS" | sed 's/%/%25/g; s/\n/%0A/g; s/\r/%0D/g')
                    echo "filters=$FILTERS_ESCAPED" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # 4. Detect backend changes
      # ----------------------------------------
      - name: Detect changed backend services
        id: backend_changed
        uses: dorny/paths-filter@v2
        with:
          filters: |
            ${{ steps.backend_filter_yaml.outputs.filters }}

      # ----------------------------------------
      # 5. Validate frontend projects (package.json required)
      # ----------------------------------------
      - name: Validate frontend projects
        id: frontend_valid
        run: |
          VALID=()

          for project in $(echo '${{ steps.config.outputs.frontend }}' | jq -r '.[]'); do
            if [ -f "$project/package.json" ]; then
              echo "VALID frontend: $project"
              VALID+=("$project")
            else
              echo "INVALID frontend (no package.json): $project"
            fi
          done

          JSON=$(printf "%s\n" "${VALID[@]}" | jq -R . | jq -s -c .)
          echo "frontend_projects=$JSON" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # 6. Build frontend filters for paths-filter
      # ----------------------------------------
      - name: Build frontend YAML filters
        id: frontend_filter_yaml
        run: |
          PROJECTS=$(echo '${{ steps.frontend_valid.outputs.frontend_projects }}' | jq -r '.[]')
          echo "Building frontend filters..."

          FILTERS=""
          for p in $PROJECTS; do
            NAME=$(basename "$p")
            FILTERS="$FILTERS
            $NAME:
              - \"$p/**\""
                    done
          
                    FILTERS_ESCAPED=$(echo "$FILTERS" | sed 's/%/%25/g; s/\n/%0A/g; s/\r/%0D/g')
                    echo "filters=$FILTERS_ESCAPED" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # 7. Detect frontend changes
      # ----------------------------------------
      - name: Detect changed frontend projects
        id: frontend_changed
        uses: dorny/paths-filter@v2
        with:
          filters: |
            ${{ steps.frontend_filter_yaml.outputs.filters }}

      # ----------------------------------------
      # 8. Summary
      # ----------------------------------------
      - name: Summary
        run: |
          echo "======================================="
          echo "        BACKEND SERVICES (VALID)       "
          echo "======================================="
          echo '${{ steps.backend_valid.outputs.backend_services }}'
          echo

          echo "======================================="
          echo "       BACKEND CHANGES DETECTED        "
          echo "======================================="
          echo '${{ steps.backend_changed.outputs }}'
          echo

          echo "======================================="
          echo "       FRONTEND PROJECTS (VALID)       "
          echo "======================================="
          echo '${{ steps.frontend_valid.outputs.frontend_projects }}'
          echo

          echo "======================================="
          echo "      FRONTEND CHANGES DETECTED        "
          echo "======================================="
          echo '${{ steps.frontend_changed.outputs }}'
