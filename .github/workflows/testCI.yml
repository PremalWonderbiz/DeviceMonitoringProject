name: Detect Services & Projects

on:
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest

    outputs:
      backend_services: ${{ steps.backend_valid.outputs.backend_services }}
      changed_backend: ${{ steps.backend_changed.outputs }}
      frontend_projects: ${{ steps.frontend_valid.outputs.frontend_projects }}
      changed_frontend: ${{ steps.frontend_changed.outputs }}

    steps:
      # ---------------------------------------------------------
      # Checkout
      # ---------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4


      # ---------------------------------------------------------
      # Load JSON config
      # ---------------------------------------------------------
      - name: Load project configuration
        id: config
        run: |
          CONFIG="Configurations/projects.json"

          echo "backend=$(jq -c '.backend' "$CONFIG")" >> "$GITHUB_OUTPUT"
          echo "frontend=$(jq -c '.frontend' "$CONFIG")" >> "$GITHUB_OUTPUT"


      # ---------------------------------------------------------
      # Validate backend services + build filters
      # ---------------------------------------------------------
      - name: Validate backend & build filters
        id: backend_valid
        run: |
          SERVICES=$(echo '${{ steps.config.outputs.backend }}' | jq -r '.[]')

          VALID_LIST=()

          echo "" > backend_filters.yml

          for s in $SERVICES; do
            if ls "$s"/*.sln >/dev/null 2>&1; then
              NAME=$(basename "$s")
              echo "$NAME:" >> backend_filters.yml
              echo "  - \"$s/**\"" >> backend_filters.yml
              VALID_LIST+=("$s")
            else
              echo "[SKIP] Backend invalid (no .sln): $s"
            fi
          done

          printf "%s\n" "${VALID_LIST[@]}" | jq -R . | jq -s -c . > backend_services.json

          echo "backend_services=$(cat backend_services.json)" >> "$GITHUB_OUTPUT"

          echo "filters<<EOF" >> "$GITHUB_OUTPUT"
          cat backend_filters.yml >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"


      # ---------------------------------------------------------
      # Detect backend changes
      # ---------------------------------------------------------
      - name: Detect changed backend services
        id: backend_changed
        uses: dorny/paths-filter@v2
        with:
          list-files: shell
          filters: ${{ steps.backend_valid.outputs.filters }}


      # ---------------------------------------------------------
      # Validate frontend projects + build filters
      # ---------------------------------------------------------
      - name: Validate frontend & build filters
        id: frontend_valid
        run: |
          PROJECTS=$(echo '${{ steps.config.outputs.frontend }}' | jq -r '.[]')

          VALID_LIST=()

          echo "" > frontend_filters.yml

          for p in $PROJECTS; do
            if [ -f "$p/package.json" ]; then
              NAME=$(basename "$p")
              echo "$NAME:" >> frontend_filters.yml
              echo "  - \"$p/**\"" >> frontend_filters.yml
              VALID_LIST+=("$p")
            else
              echo "[SKIP] Frontend invalid (no package.json): $p"
            fi
          done

          printf "%s\n" "${VALID_LIST[@]}" | jq -R . | jq -s -c . > frontend_projects.json

          echo "frontend_projects=$(cat frontend_projects.json)" >> "$GITHUB_OUTPUT"

          echo "filters<<EOF" >> "$GITHUB_OUTPUT"
          cat frontend_filters.yml >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"


      # ---------------------------------------------------------
      # Detect frontend changes
      # ---------------------------------------------------------
      - name: Detect changed frontend projects
        id: frontend_changed
        uses: dorny/paths-filter@v2
        with:
          list-files: shell
          filters: ${{ steps.frontend_valid.outputs.filters }}


      # ---------------------------------------------------------
      # Summary
      # ---------------------------------------------------------
      - name: Summary
        run: |
          echo "================ BACKEND SERVICES ================"
          echo '${{ steps.backend_valid.outputs.backend_services }}'

          echo "================ BACKEND CHANGES ================="
          echo '${{ steps.backend_changed.outputs }}'

          echo "================ FRONTEND PROJECTS ==============="
          echo '${{ steps.frontend_valid.outputs.frontend_projects }}'

          echo "================ FRONTEND CHANGES ================"
          echo '${{ steps.frontend_changed.outputs }}'
