name: Detect Services & Projects

on:
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest

    outputs:
      backend_services: ${{ steps.backend_valid.outputs.backend_services }}
      changed_backend: ${{ steps.backend_changed.outputs.changed_backend }}
      frontend_projects: ${{ steps.frontend_valid.outputs.frontend_projects }}
      changed_frontend: ${{ steps.frontend_changed.outputs.changed_frontend }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4


      ###########################################################
      # 1) LOAD CONFIGURATION (SIMPLE)
      ###########################################################
      - name: Load config
        id: config
        run: |
          CONFIG="config/projects.json"

          BACKEND=$(jq -c '.backend' "$CONFIG")
          FRONTEND=$(jq -c '.frontend' "$CONFIG")

          echo "backend=$BACKEND" >> "$GITHUB_OUTPUT"
          echo "frontend=$FRONTEND" >> "$GITHUB_OUTPUT"


      ###########################################################
      # 2) VALIDATE BACKEND SERVICES (must contain .sln)
      ###########################################################
      - name: Validate backend services
        id: backend_valid
        run: |
          VALID=()

          for service in $(echo '${{ steps.config.outputs.backend }}' | jq -r '.[]'); do
            if ls "$service"/*.sln >/dev/null 2>&1; then
              echo "VALID backend: $service"
              VALID+=("$service")
            else
              echo "INVALID backend (no .sln): $service"
            fi
          done

          JSON=$(printf "%s\n" "${VALID[@]}" | jq -R . | jq -s -c .)
          echo "backend_services=$JSON" >> "$GITHUB_OUTPUT"


      ###########################################################
      # 3) DETECT CHANGED BACKEND (paths-filter)
      ###########################################################
      - name: Detect changed backend services
        id: backend_changed
        uses: dorny/paths-filter@v2
        with:
          filters: |
            ${{ steps.backend_valid.outputs.backend_services }}


      ###########################################################
      # 4) VALIDATE FRONTEND PROJECTS (must contain package.json)
      ###########################################################
      - name: Validate frontend projects
        id: frontend_valid
        run: |
          VALID=()

          for project in $(echo '${{ steps.config.outputs.frontend }}' | jq -r '.[]'); do
            if [ -f "$project/package.json" ]; then
              echo "VALID frontend: $project"
              VALID+=("$project")
            else
              echo "INVALID frontend (no package.json): $project"
            fi
          done

          JSON=$(printf "%s\n" "${VALID[@]}" | jq -R . | jq -s -c .)
          echo "frontend_projects=$JSON" >> "$GITHUB_OUTPUT"


      ###########################################################
      # 5) DETECT CHANGED FRONTEND (paths-filter)
      ###########################################################
      - name: Detect changed frontend projects
        id: frontend_changed
        uses: dorny/paths-filter@v2
        with:
          filters: |
            ${{ steps.frontend_valid.outputs.frontend_projects }}


      ###########################################################
      # 6) SUMMARY
      ###########################################################
      - name: Summary
        run: |
          echo "=== Backend Services (Valid) ==="
          echo '${{ steps.backend_valid.outputs.backend_services }}'
          echo
          echo "=== Changed Backend ==="
          echo '${{ steps.backend_changed.outputs }}'
          echo
          echo "=== Frontend Projects (Valid) ==="
          echo '${{ steps.frontend_valid.outputs.frontend_projects }}'
          echo
          echo "=== Changed Frontend ==="
          echo '${{ steps.frontend_changed.outputs }}'
