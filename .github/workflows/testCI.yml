name: Detect Services & Projects

on:
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest

    outputs:
      backend_services: ${{ steps.backend_valid.outputs.backend_services }}
      changed_backend: ${{ steps.backend_changed.outputs }}
      frontend_projects: ${{ steps.frontend_valid.outputs.frontend_projects }}
      changed_frontend: ${{ steps.frontend_changed.outputs }}

    steps:
      # ----------------------------------------
      # Checkout
      # ----------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------
      # Load unified config
      # ----------------------------------------
      - name: Load project configuration
        id: config
        run: |
          CONFIG="Configurations/projects.json"

          echo "backend=$(jq -c '.backend' "$CONFIG")" >> "$GITHUB_OUTPUT"
          echo "frontend=$(jq -c '.frontend' "$CONFIG")" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # Validate backend services (.sln required)
      # ----------------------------------------
      - name: Validate backend services
        id: backend_valid
        run: |
          VALID=()

          for service in $(echo '${{ steps.config.outputs.backend }}' | jq -r '.[]'); do
            if ls "$service"/*.sln >/dev/null 2>&1; then
              VALID+=("$service")
            else
              echo "Skipping backend (no .sln): $service"
            fi
          done

          printf "%s\n" "${VALID[@]}" | jq -R . | jq -s -c . > backend.json
          echo "backend_services=$(cat backend.json)" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # Build backend filters
      # ----------------------------------------
      - name: Build backend YAML filters
        id: backend_filter_yaml
        run: |
          SERVICES=$(jq -r '.[]' <<< '${{ steps.backend_valid.outputs.backend_services }}')

          echo "Building backend filters..."
          {
            for s in $SERVICES; do
              NAME=$(basename "$s")
              echo "$NAME:"
              echo "  - \"$s/**\""
            done
          } > backend_filters.yml

          echo "filters<<EOF" >> "$GITHUB_OUTPUT"
          cat backend_filters.yml >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # Detect backend changes
      # ----------------------------------------
      - name: Detect changed backend services
        id: backend_changed
        uses: dorny/paths-filter@v2
        with:
          list-files: shell
          filters: ${{ steps.backend_filter_yaml.outputs.filters }}

      # ----------------------------------------
      # Validate frontend (package.json required)
      # ----------------------------------------
      - name: Validate frontend projects
        id: frontend_valid
        run: |
          VALID=()

          for project in $(echo '${{ steps.config.outputs.frontend }}' | jq -r '.[]'); do
            if [ -f "$project/package.json" ]; then
              VALID+=("$project")
            else
              echo "Skipping frontend (no package.json): $project"
            fi
          done

          printf "%s\n" "${VALID[@]}" | jq -R . | jq -s -c . > frontend.json
          echo "frontend_projects=$(cat frontend.json)" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # Build frontend filters
      # ----------------------------------------
      - name: Build frontend YAML filters
        id: frontend_filter_yaml
        run: |
          PROJECTS=$(jq -r '.[]' <<< '${{ steps.frontend_valid.outputs.frontend_projects }}')

          echo "Building frontend filters..."
          {
            for p in $PROJECTS; do
              NAME=$(basename "$p")
              echo "$NAME:"
              echo "  - \"$p/**\""
            done
          } > frontend_filters.yml

          echo "filters<<EOF" >> "$GITHUB_OUTPUT"
          cat frontend_filters.yml >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # ----------------------------------------
      # Detect frontend changes
      # ----------------------------------------
      - name: Detect changed frontend projects
        id: frontend_changed
        uses: dorny/paths-filter@v2
        with:
          list-files: shell
          filters: ${{ steps.frontend_filter_yaml.outputs.filters }}

      # ----------------------------------------
      # Summary
      # ----------------------------------------
      - name: Summary
        run: |
          echo "======================================="
          echo " BACKEND SERVICES (VALID)"
          echo "======================================="
          echo '${{ steps.backend_valid.outputs.backend_services }}'
          echo

          echo "======================================="
          echo " BACKEND CHANGES DETECTED"
          echo "======================================="
          echo '${{ steps.backend_changed.outputs }}'
          echo

          echo "======================================="
          echo " FRONTEND PROJECTS (VALID)"
          echo "======================================="
          echo '${{ steps.frontend_valid.outputs.frontend_projects }}'
          echo

          echo "======================================="
          echo " FRONTEND CHANGES DETECTED"
          echo "======================================="
          echo '${{ steps.frontend_changed.outputs }}'
