name: Detect C# Services

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  detect-services:
    runs-on: ubuntu-latest

    outputs:
      services: ${{ steps.detect.outputs.services }}
      changed_services: ${{ steps.changed.outputs.changed_services }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # DETECT ONLY ROOT SERVICE FOLDERS
      # Criteria:
      #   - Folder containing "*.sln"
      #   - OR folder containing "*API.csproj"
      # ----------------------------------------------------------
      - name: Detect root service folders
        id: detect
        run: |
          echo "Detecting service root folders..."

          # Find root service folders
          SERVICES=$( \
            find Backend -type f \( -name "*.sln" -o -name "*API.csproj" \) \
            -printf '%h\n' | sort -u \
          )

          echo "Detected root folders:"
          echo "$SERVICES"

          # Convert to compact JSON array
          JSON=$(printf '%s\n' "$SERVICES" | jq -R . | jq -s -c .)

          echo "services=$JSON" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------
      # DETECT WHICH SERVICES CHANGED
      # ----------------------------------------------------------
      - name: Detect changed services
        id: changed
        run: |
          echo "Detecting changed services..."

          # Changed files between base & head
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD || echo "")

          echo "Files changed:"
          echo "$FILES"

          CHANGED=()

          for service in $(echo '${{ steps.detect.outputs.services }}' | jq -r '.[]'); do
            if echo "$FILES" | grep -q "^${service}/"; then
              CHANGED+=("$service")
            fi
          done

          # JSON output
          JSON=$(printf '%s\n' "${CHANGED[@]}" | jq -R . | jq -s -c .)

          echo "changed_services=$JSON" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          echo "All services: ${{ steps.detect.outputs.services }}"
          echo "Changed services: ${{ steps.changed.outputs.changed_services }}"
