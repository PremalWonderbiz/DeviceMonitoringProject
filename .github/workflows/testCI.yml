name: Detect C# Services

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'staging'
      version:
        description: 'Version to deploy'
        required: false
        default: '1.0.0'
      
jobs:
  detect-services:
    runs-on: ubuntu-latest

    outputs:
      services: ${{ steps.detect.outputs.services }}
      changed_services: ${{ steps.changed.outputs.changed_services }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # STEP 1: Detect REAL service root folders
      # Rules:
      #   - Must contain API/, Application/, Domain/, Infrastructure/
      #   - Exclude nested folders like API/, API/API, API/Application, etc.
      # ----------------------------------------------------------
      - name: Detect service roots
        id: detect
        run: |
          echo "Detecting root service folders..."

          ROOTS=()

          # Any folder that contains the four clean architecture layers
          while IFS= read -r dir; do
            if [ -d "$dir/API" ] && [ -d "$dir/Application" ] && [ -d "$dir/Domain" ] && [ -d "$dir/Infrastructure" ]; then
              ROOTS+=("$dir")
            fi
          done < <(find Backend -maxdepth 3 -type d)

          echo "Detected service roots:"
          printf '%s\n' "${ROOTS[@]}"

          JSON=$(printf '%s\n' "${ROOTS[@]}" | jq -R . | jq -s -c .)
          echo "services=$JSON" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------
      # STEP 2 â€” Detect changed services
      # ----------------------------------------------------------
      - name: Detect changed services
        id: changed
        run: |
          echo "Detecting changed services..."

          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD || echo "")

          echo "Files changed:"
          echo "$FILES"

          CHANGED=()

          for service in $(echo '${{ steps.detect.outputs.services }}' | jq -r '.[]'); do
            if echo "$FILES" | grep -q "^${service}/"; then
              CHANGED+=("$service")
            fi
          done

          JSON=$(printf '%s\n' "${CHANGED[@]}" | jq -R . | jq -s -c .)
          echo "changed_services=$JSON" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          echo "All services:"
          echo '${{ steps.detect.outputs.services }}'
          echo "Changed services:"
          echo '${{ steps.changed.outputs.changed_services }}'
