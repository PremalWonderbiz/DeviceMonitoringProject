name: Detect Services & Projects

on:
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest

    outputs:
      backend_services: ${{ steps.backend_valid.outputs.backend_services }}
      changed_backend: ${{ steps.backend_changed.outputs }}
      frontend_projects: ${{ steps.frontend_valid.outputs.frontend_projects }}
      changed_frontend: ${{ steps.frontend_changed.outputs }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4


      ###########################################################
      # 1) LOAD PROJECT CONFIG
      ###########################################################
      - name: Load config
        id: config
        run: |
          CONFIG="Configurations/projects.json"

          BACKEND=$(jq -c '.backend' "$CONFIG")
          FRONTEND=$(jq -c '.frontend' "$CONFIG")

          echo "backend=$BACKEND" >> "$GITHUB_OUTPUT"
          echo "frontend=$FRONTEND" >> "$GITHUB_OUTPUT"

          echo "Backend from config: $BACKEND"
          echo "Frontend from config: $FRONTEND"


      ###########################################################
      # 2) VALIDATE BACKEND SERVICES (.sln check)
      ###########################################################
      - name: Validate backend services
        id: backend_valid
        run: |
          VALID=()

          for service in $(echo '${{ steps.config.outputs.backend }}' | jq -r '.[]'); do
            if ls "$service"/*.sln >/dev/null 2>&1; then
              echo "VALID backend: $service"
              VALID+=("$service")
            else
              echo "INVALID backend (no .sln): $service"
            fi
          done

          JSON=$(printf "%s\n" "${VALID[@]}" | jq -R . | jq -s -c .)
          echo "backend_services=$JSON" >> "$GITHUB_OUTPUT"


      ###########################################################
      # 3) BUILD YAML FILTER FILE FOR BACKEND (paths-filter)
      ###########################################################
      - name: Build backend path filters
        id: backend_filters
        run: |
          SERVICES=$(echo '${{ steps.backend_valid.outputs.backend_services }}' | jq -r '.[]')

          echo "filters:" > backend-filters.yml
          for s in $SERVICES; do
            NAME=$(basename "$s")
            echo "  $NAME:" >> backend-filters.yml
            echo "    - \"$s/**\"" >> backend-filters.yml
          done

          echo "Generated backend-filters.yml:"
          cat backend-filters.yml


      ###########################################################
      # 4) DETECT BACKEND CHANGES USING paths-filter
      ###########################################################
      - name: Detect changed backend services
        id: backend_changed
        uses: dorny/paths-filter@v2
        with:
          config: backend-filters.yml


      ###########################################################
      # 5) VALIDATE FRONTEND PROJECTS (package.json check)
      ###########################################################
      - name: Validate frontend projects
        id: frontend_valid
        run: |
          VALID=()

          for project in $(echo '${{ steps.config.outputs.frontend }}' | jq -r '.[]'); do
            if [ -f "$project/package.json" ]; then
              echo "VALID frontend: $project"
              VALID+=("$project")
            else
              echo "INVALID frontend (no package.json): $project"
            fi
          done

          JSON=$(printf "%s\n" "${VALID[@]}" | jq -R . | jq -s -c .)
          echo "frontend_projects=$JSON" >> "$GITHUB_OUTPUT"


      ###########################################################
      # 6) BUILD YAML FILTER FILE FOR FRONTEND (paths-filter)
      ###########################################################
      - name: Build frontend path filters
        id: frontend_filters
        run: |
          PROJECTS=$(echo '${{ steps.frontend_valid.outputs.frontend_projects }}' | jq -r '.[]')

          echo "filters:" > frontend-filters.yml
          for p in $PROJECTS; do
            NAME=$(basename "$p")
            echo "  $NAME:" >> frontend-filters.yml
            echo "    - \"$p/**\"" >> frontend-filters.yml
          done

          echo "Generated frontend-filters.yml:"
          cat frontend-filters.yml


      ###########################################################
      # 7) DETECT FRONTEND CHANGES USING paths-filter
      ###########################################################
      - name: Detect changed frontend projects
        id: frontend_changed
        uses: dorny/paths-filter@v2
        with:
          config: frontend-filters.yml


      ###########################################################
      # 8) SUMMARY
      ###########################################################
      - name: Summary
        run: |
          echo "=== BACKEND VALID SERVICES ==="
          echo '${{ steps.backend_valid.outputs.backend_services }}'
          echo
          echo "=== BACKEND CHANGES ==="
          echo '${{ steps.backend_changed.outputs }}'
          echo
          echo "=== FRONTEND VALID PROJECTS ==="
          echo '${{ steps.frontend_valid.outputs.frontend_projects }}'
          echo
          echo "=== FRONTEND CHANGES ==="
          echo '${{ steps.frontend_changed.outputs }}'
