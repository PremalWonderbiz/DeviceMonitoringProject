Î
§C:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\DeviceStatePersistenceService .cs
	namespace 	
Infrastructure
 
. 
Services !
{ 
public 

class )
DeviceStatePersistenceService .
:/ 0
BackgroundService1 B
{ 
private 
readonly 
DeviceStateCache )
_deviceStateCache* ;
;; <
private 
readonly 
ILogger  
<  !)
DeviceStatePersistenceService! >
>> ?
_logger@ G
;G H
private 
readonly 
TimeSpan !
	_interval" +
=, -
TimeSpan. 6
.6 7
FromSeconds7 B
(B C
$numC F
)F G
;G H
public )
DeviceStatePersistenceService ,
(, -
DeviceStateCache 
deviceStateCache -
,- .
ILogger 
< )
DeviceStatePersistenceService 1
>1 2
logger3 9
)9 :
{ 	
_deviceStateCache 
= 
deviceStateCache  0
;0 1
_logger 
= 
logger 
; 
} 	
	protected 
override 
async  
Task! %
ExecuteAsync& 2
(2 3
CancellationToken3 D
stoppingTokenE R
)R S
{ 	
_logger 
. 
LogInformation "
(" #
$str# N
)N O
;O P
while 
( 
! 
stoppingToken !
.! "#
IsCancellationRequested" 9
)9 :
{   
await!! 
_deviceStateCache!! '
.!!' (
PersistToDiskAsync!!( :
(!!: ;
)!!; <
;!!< =
await"" 
Task"" 
."" 
Delay""  
(""  !
	_interval""! *
,""* +
stoppingToken"", 9
)""9 :
;"": ;
}## 
}$$ 	
public&& 
override&& 
async&& 
Task&& "
	StopAsync&&# ,
(&&, -
CancellationToken&&- >
cancellationToken&&? P
)&&P Q
{'' 	
_logger(( 
.(( 
LogInformation(( "
(((" #
$str((# i
)((i j
;((j k
await)) 
_deviceStateCache)) #
.))# $
PersistToDiskAsync))$ 6
())6 7
)))7 8
;))8 9
_logger** 
.** 
LogInformation** "
(**" #
$str**# :
)**: ;
;**; <
await++ 
base++ 
.++ 
	StopAsync++  
(++  !
cancellationToken++! 2
)++2 3
;++3 4
},, 	
}-- 
}.. ¿∂
ìC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\DeviceService.cs
	namespace 	
Infrastructure
 
. 
Services !
;! "
public 
class 
DeviceService 
: 
IDeviceService +
{ 
private 
readonly 
ILogger 
< 
DeviceService *
>* +
_logger, 3
;3 4
private 
readonly 
IDynamicDataHelper '
_dynamicDataHelper( :
;: ;
private 
readonly  
IDeviceServiceHelper ) 
_deviceServiceHelper* >
;> ?
private 
readonly #
IAlarmEvaluationService ,#
_alarmEvaluationService- D
;D E
private 
readonly 
DeviceStateCache %
_deviceStateCache& 7
;7 8
private 
readonly 
IAlarmToggleService (
_alarmToggleService) <
;< =
private 
readonly 
bool 
_useDatabase &
;& '
private 
readonly 
DeviceDbContext $

_dbContext% /
;/ 0
private   
static   
readonly   
List    
<    !
Func  ! %
<  % &
DeviceMetadata  & 4
,  4 5
string  6 <
>  < =
>  = >
_searchSequence  ? N
=  O P
new  Q T
(  T U
)  U V
{!! 
d"" 	
=>""
 
d"" 
."" 
Name"" 
,"" 
d## 	
=>##
 
d## 
.## 
Type## 
,## 
d$$ 	
=>$$
 
d$$ 
.$$ 
Status$$ 
,$$ 
d%% 	
=>%%
 
d%% 
.%% 
MacId%% 
,%% 
d&& 	
=>&&
 
d&& 
.&& 
Connectivity&& 
,&& 
d'' 	
=>''
 
d'' 
.'' 
FileName'' 
}(( 
;(( 
private++ 
static++ 
readonly++ 

Dictionary++ &
<++& '
string++' -
,++- .
int++/ 2
>++2 3
connectivityOrder++4 E
=++F G
new++H K
(++K L
)++L M
{,, 
{-- 	
$str--
 
,-- 
$num-- 
}-- 
,-- 
{.. 	
$str..
 
,.. 
$num.. 
}.. 
,.. 
{// 	
$str//
 
,// 
$num// 
}// 
}00 
;00 
private22 
List22 
<22 
DeviceMetadata22 
>22  

GetDevices22! +
(22+ ,
)22, -
{33 
return44 
_deviceStateCache44  
.44  !
GetAllStates44! -
(44- .
)44. /
.55 
Select55 
(55 
state55 
=>55 
{66 
var77 
root77 
=77 
state77  
.77  !
Value77! &
.77& '
Root77' +
;77+ ,
var88 
lastUpdated88 
=88  !
state88" '
.88' (
Value88( -
.88- .
LastUpdated88. 9
;889 :
return99 
new99 
DeviceMetadata99 )
{:: 
Name;; 
=;; 
root;; 
[;;  
$str;;  &
];;& '
?;;' (
.;;( )
GetValue;;) 1
<;;1 2
string;;2 8
>;;8 9
(;;9 :
);;: ;
??;;< >
$str;;? H
,;;H I
Type<< 
=<< 
root<< 
[<<  
$str<<  &
]<<& '
?<<' (
.<<( )
GetValue<<) 1
<<<1 2
string<<2 8
><<8 9
(<<9 :
)<<: ;
??<<< >
$str<<? H
,<<H I
Status== 
=== 
root== !
[==! "
$str==" *
]==* +
?==+ ,
.==, -
GetValue==- 5
<==5 6
string==6 <
>==< =
(=== >
)==> ?
??==@ B
$str==C L
,==L M
MacId>> 
=>> 
state>> !
.>>! "
Key>>" %
,>>% &
Connectivity??  
=??! "
root??# '
[??' (
$str??( 6
]??6 7
???7 8
.??8 9
GetValue??9 A
<??A B
string??B H
>??H I
(??I J
)??J K
????L N
$str??O X
,??X Y
FileName@@ 
=@@ 
root@@ #
[@@# $
$str@@$ .
]@@. /
?@@/ 0
.@@0 1
GetValue@@1 9
<@@9 :
string@@: @
>@@@ A
(@@A B
)@@B C
??@@D F
$str@@G I
,@@I J
LastUpdatedAA 
=AA  !
lastUpdatedAA" -
}BB 
;BB 
}CC 
)CC 
.DD 
ToListDD 
(DD 
)DD 
;DD 
}EE 
privateHH 
readonlyHH 
stringHH 
_dataDirectoryHH *
=HH+ ,
PathHH- 1
.HH1 2
CombineHH2 9
(HH9 :
	DirectoryHH: C
.HHC D
	GetParentHHD M
(HHM N
	DirectoryHHN W
.HHW X
GetCurrentDirectoryHHX k
(HHk l
)HHl m
)HHm n
!HHn o
.HHo p
FullNameHHp x
,HHx y
$str	HHz ä
,
HHä ã
$str
HHå í
)
HHí ì
;
HHì î
publicMM 

DeviceServiceMM 
(MM  
IDeviceServiceHelperNN 
deviceServiceHelperNN 0
,NN0 1
ILoggerOO 
<OO 
DeviceServiceOO 
>OO 
loggerOO %
,OO% &
IDynamicDataHelperPP 
dynamicDataHelperPP ,
,PP, -#
IAlarmEvaluationServiceQQ "
alarmEvaluationServiceQQ  6
,QQ6 7
DeviceStateCacheRR 
deviceStateCacheRR )
,RR) *
IAlarmToggleServiceSS 
alarmToggleServiceSS .
,SS. /
IOptionsTT 
<TT  
DeviceStorageOptionsTT %
>TT% &
optionsTT' .
,TT. /
DeviceDbContextUU 
	dbContextUU !
)UU! "
{VV 
_loggerWW 
=WW 
loggerWW 
;WW 
_dynamicDataHelperXX 
=XX 
dynamicDataHelperXX .
;XX. /#
_alarmEvaluationServiceYY 
=YY  !"
alarmEvaluationServiceYY" 8
;YY8 9 
_deviceServiceHelperZZ 
=ZZ 
deviceServiceHelperZZ 2
;ZZ2 3
_deviceStateCache[[ 
=[[ 
deviceStateCache[[ ,
;[[, -
_alarmToggleService\\ 
=\\ 
alarmToggleService\\ 0
;\\0 1
_useDatabase]] 
=]] 
options]] 
.]] 
Value]] $
.]]$ %
UseDatabase]]% 0
;]]0 1

_dbContext^^ 
=^^ 
	dbContext^^ 
;^^ 
}__ 
publicaa 

asyncaa 
Taskaa 
<aa 
boolaa 
>aa 1
%GenerateAndSendLiveUpdatesDevicesDataaa A
(aaA B
)aaB C
{bb 
throwcc 
newcc #
NotImplementedExceptioncc )
(cc) *
)cc* +
;cc+ ,
}dd 
publicff 

Listff 
<ff 
DeviceMetadataff 
>ff )
GetAllDeviceMetadataPaginatedff  =
(ff= >
Listff> B
<ffB C
DeviceMetadataffC Q
>ffQ R
metadataffS [
,ff[ \
intff] `

pageNumberffa k
=ffl m
$numffn o
,ffo p
intffq t
pageSizeffu }
=ff~ 
$num
ffÄ Ç
)
ffÇ É
{gg 
returnhh 
metadatahh 
.hh 
Skiphh 
(hh 
(hh 

pageNumberhh (
-hh) *
$numhh+ ,
)hh, -
*hh. /
pageSizehh0 8
)hh8 9
.hh9 :
Takehh: >
(hh> ?
pageSizehh? G
)hhG H
.hhH I
ToListhhI O
(hhO P
)hhP Q
;hhQ R
}ii 
publickk 
/
#DeviceMetadataPaginatedandSortedDtokk .2
&GetAllDeviceMetadataPaginatedandSortedkk/ U
(kkU V%
DeviceTopLevelSortOptionskkV o
sortRequestkkp {
,kk{ |
List	kk} Å
<
kkÅ Ç
DeviceMetadata
kkÇ ê
>
kkê ë
filteredData
kkí û
=
kkü †
null
kk° •
)
kk• ¶
{ll 
varmm 
metaDatamm 
=mm 
filteredDatamm #
ismm$ &
notmm' *
nullmm+ /
?nn 
filteredDatann 
.nn 
AsQueryablenn 
(nn 
)nn  
:oo 

GetDevicesoo 
(oo 
)oo 
.oo 
AsQueryableoo 
(oo 
)oo  
;oo  !
IOrderedQueryableqq 
<qq 
DeviceMetadataqq (
>qq( )
orderedqq* 1
;qq1 2
ifss 

(ss 
sortRequestss 
.ss 
Sortingss 
==ss  "
nullss# '
||ss( *
!ss+ ,
sortRequestss, 7
.ss7 8
Sortingss8 ?
.ss? @
Anyss@ C
(ssC D
)ssD E
)ssE F
{tt 	
ordereduu 
=uu 
metaDatauu 
.uu 
OrderByDescendinguu 0
(uu0 1
duu1 2
=>uu3 5
duu6 7
.uu7 8
LastUpdateduu8 C
)uuC D
;uuD E
}vv 	
elseww 
{xx 	
IOrderedQueryableyy 
<yy 
DeviceMetadatayy ,
>yy, -
?yy- .
tempyy/ 3
=yy4 5
nullyy6 :
;yy: ;
foreach{{ 
({{ 
var{{ 
sort{{ 
in{{  
sortRequest{{! ,
.{{, -
Sorting{{- 4
){{4 5
{|| 
string}} 
id}} 
=}} 
sort}}  
.}}  !
Id}}! #
;}}# $
bool~~ 
desc~~ 
=~~ 
sort~~  
.~~  !
Desc~~! %
;~~% &
temp
ÄÄ 
=
ÄÄ 
temp
ÄÄ 
==
ÄÄ 
null
ÄÄ #
?
ÅÅ 
SortInitial
ÅÅ !
(
ÅÅ! "
metaData
ÅÅ" *
,
ÅÅ* +
id
ÅÅ, .
,
ÅÅ. /
desc
ÅÅ0 4
)
ÅÅ4 5
:
ÇÇ 
SortThen
ÇÇ 
(
ÇÇ 
temp
ÇÇ #
,
ÇÇ# $
id
ÇÇ% '
,
ÇÇ' (
desc
ÇÇ) -
)
ÇÇ- .
;
ÇÇ. /
}
ÉÉ 
ordered
ÖÖ 
=
ÖÖ 
temp
ÖÖ 
!
ÖÖ 
;
ÖÖ 
}
ÜÜ 	
var
àà 
metadataPaginated
àà 
=
àà +
GetAllDeviceMetadataPaginated
àà  =
(
àà= >
ordered
ââ 
.
ââ 
ToList
ââ 
(
ââ 
)
ââ 
,
ââ 
sortRequest
ää 
.
ää 

PageNumber
ää "
,
ää" #
sortRequest
ãã 
.
ãã 
PageSize
ãã  
)
åå 	
;
åå	 

return
éé 
new
éé 1
#DeviceMetadataPaginatedandSortedDto
éé 6
(
éé6 7
)
éé7 8
{
èè 	

TotalCount
êê 
=
êê 
metaData
êê !
.
êê! "
Count
êê" '
(
êê' (
)
êê( )
,
êê) *
DeviceMetadata
ëë 
=
ëë 
metadataPaginated
ëë .
}
íí 	
;
íí	 

}
îî 
private
ññ 
IOrderedQueryable
ññ 
<
ññ 
DeviceMetadata
ññ ,
>
ññ, -
SortInitial
ññ. 9
(
ññ9 :

IQueryable
ññ: D
<
ññD E
DeviceMetadata
ññE S
>
ññS T
data
ññU Y
,
ññY Z
string
ññ[ a
id
ññb d
,
ññd e
bool
ññf j
desc
ññk o
)
ñño p
{
óó 
var
òò 
keySelector
òò 
=
òò  
GetSortKeySelector
òò ,
(
òò, -
id
òò- /
)
òò/ 0
;
òò0 1
return
ôô 
ApplyOrdering
ôô 
(
ôô 
data
ôô !
,
ôô! "
keySelector
ôô# .
,
ôô. /
desc
ôô0 4
,
ôô4 5
isThen
ôô6 <
:
ôô< =
false
ôô> C
)
ôôC D
;
ôôD E
}
öö 
private
úú 
IOrderedQueryable
úú 
<
úú 
DeviceMetadata
úú ,
>
úú, -
SortThen
úú. 6
(
úú6 7
IOrderedQueryable
úú7 H
<
úúH I
DeviceMetadata
úúI W
>
úúW X
data
úúY ]
,
úú] ^
string
úú_ e
id
úúf h
,
úúh i
bool
úúj n
desc
úúo s
)
úús t
{
ùù 
var
ûû 
keySelector
ûû 
=
ûû  
GetSortKeySelector
ûû ,
(
ûû, -
id
ûû- /
)
ûû/ 0
;
ûû0 1
return
üü 
ApplyOrdering
üü 
(
üü 
data
üü !
,
üü! "
keySelector
üü# .
,
üü. /
desc
üü0 4
,
üü4 5
isThen
üü6 <
:
üü< =
true
üü> B
)
üüB C
;
üüC D
}
†† 
private
¢¢ 

Expression
¢¢ 
<
¢¢ 
Func
¢¢ 
<
¢¢ 
DeviceMetadata
¢¢ *
,
¢¢* +
object
¢¢, 2
>
¢¢2 3
>
¢¢3 4 
GetSortKeySelector
¢¢5 G
(
¢¢G H
string
¢¢H N
id
¢¢O Q
)
¢¢Q R
{
££ 
return
§§ 
id
§§ 
switch
§§ 
{
•• 	
$str
¶¶ 
=>
¶¶ 
u
¶¶ 
=>
¶¶ 
u
¶¶ 
.
¶¶ 
Name
¶¶ !
,
¶¶! "
$str
ßß 
=>
ßß 
u
ßß 
=>
ßß 
u
ßß 
.
ßß 
Type
ßß !
,
ßß! "
$str
®® 
=>
®® 
u
®® 
=>
®® 
u
®® 
.
®® 
Status
®® %
,
®®% &
$str
©© 
=>
©© 
u
©© 
=>
©© 
u
©© 
.
©© 
MacId
©© #
,
©©# $
$str
™™ 
=>
™™ 
u
™™ 
=>
™™  "
connectivityOrder
™™# 4
.
™™4 5
ContainsKey
™™5 @
(
™™@ A
u
™™A B
.
™™B C
Connectivity
™™C O
)
™™O P
?
´´$ %
connectivityOrder
´´& 7
[
´´7 8
u
´´8 9
.
´´9 :
Connectivity
´´: F
]
´´F G
:
¨¨$ %
int
¨¨& )
.
¨¨) *
MaxValue
¨¨* 2
,
¨¨2 3
$str
≠≠ 
=>
≠≠ 
u
≠≠ 
=>
≠≠ !
u
≠≠" #
.
≠≠# $
LastUpdated
≠≠$ /
,
≠≠/ 0
_
ÆÆ 
=>
ÆÆ 
u
ÆÆ 
=>
ÆÆ 
u
ÆÆ 
.
ÆÆ 
Name
ÆÆ 
}
ØØ 	
;
ØØ	 

}
∞∞ 
private
≤≤ 
static
≤≤ 
IOrderedQueryable
≤≤ $
<
≤≤$ %
DeviceMetadata
≤≤% 3
>
≤≤3 4
ApplyOrdering
≤≤5 B
<
≤≤B C
T
≤≤C D
>
≤≤D E
(
≤≤E F

IQueryable
≥≥ 
<
≥≥ 
DeviceMetadata
≥≥ !
>
≥≥! "
data
≥≥# '
,
≥≥' (

Expression
¥¥ 
<
¥¥ 
Func
¥¥ 
<
¥¥ 
DeviceMetadata
¥¥ &
,
¥¥& '
T
¥¥( )
>
¥¥) *
>
¥¥* +
keySelector
¥¥, 7
,
¥¥7 8
bool
µµ 
desc
µµ 
,
µµ 
bool
∂∂ 
isThen
∂∂ 
)
∂∂ 
{
∑∑ 
if
∏∏ 

(
∏∏ 
isThen
∏∏ 
&&
∏∏ 
data
∏∏ 
is
∏∏ 
IOrderedQueryable
∏∏ /
<
∏∏/ 0
DeviceMetadata
∏∏0 >
>
∏∏> ?
ordered
∏∏@ G
)
∏∏G H
return
ππ 
desc
ππ 
?
ππ 
ordered
ππ !
.
ππ! "
ThenByDescending
ππ" 2
(
ππ2 3
keySelector
ππ3 >
)
ππ> ?
:
ππ@ A
ordered
ππB I
.
ππI J
ThenBy
ππJ P
(
ππP Q
keySelector
ππQ \
)
ππ\ ]
;
ππ] ^
return
ªª 
desc
ªª 
?
ªª 
data
ªª 
.
ªª 
OrderByDescending
ªª ,
(
ªª, -
keySelector
ªª- 8
)
ªª8 9
:
ªª: ;
data
ªª< @
.
ªª@ A
OrderBy
ªªA H
(
ªªH I
keySelector
ªªI T
)
ªªT U
;
ªªU V
}
ºº 
public
øø 
1
#DeviceMetadataPaginatedandSortedDto
øø .0
"GetSearchedDeviceMetadataPaginated
øø/ Q
(
øøQ R'
DeviceTopLevelSortOptions
øøR k
sortRequest
øøl w
,
øøw x
string
øøy 
inputøøÄ Ö
=øøÜ á
$strøøà ä
)øøä ã
{
¿¿ 
var
¡¡ 
filteredList
¡¡ 
=
¡¡ 
string
¡¡ !
.
¡¡! " 
IsNullOrWhiteSpace
¡¡" 4
(
¡¡4 5
input
¡¡5 :
)
¡¡: ;
?
¬¬ 	

GetDevices
¬¬
 
(
¬¬ 
)
¬¬ 
:
√√ 	

GetDevices
√√
 
(
√√ 
)
√√ 
.
√√ 
Where
√√ 
(
√√ 
d
√√ 
=>
√√ !
MatchesSearch
√√" /
(
√√/ 0
d
√√0 1
,
√√1 2
input
√√3 8
)
√√8 9
)
√√9 :
.
√√: ;
ToList
√√; A
(
√√A B
)
√√B C
;
√√C D
if
≈≈ 

(
≈≈ 
filteredList
≈≈ 
.
≈≈ 
Count
≈≈ 
<=
≈≈ !
$num
≈≈" #
)
≈≈# $
{
∆∆ 	
return
«« 
new
«« 1
#DeviceMetadataPaginatedandSortedDto
«« :
{
»» 

TotalCount
…… 
=
…… 
filteredList
…… )
.
……) *
Count
……* /
,
……/ 0
DeviceMetadata
   
=
    
filteredList
  ! -
}
ÀÀ 
;
ÀÀ 
}
ÃÃ 	
return
ŒŒ 4
&GetAllDeviceMetadataPaginatedandSorted
ŒŒ 5
(
ŒŒ5 6
sortRequest
ŒŒ6 A
,
ŒŒA B
filteredList
ŒŒC O
)
ŒŒO P
;
ŒŒP Q
}
œœ 
private
—— 
bool
—— 
MatchesSearch
—— 
(
—— 
DeviceMetadata
—— -
device
——. 4
,
——4 5
string
——6 <
input
——= B
)
——B C
{
““ 
input
”” 
=
”” 
input
”” 
.
”” 
ToLowerInvariant
”” &
(
””& '
)
””' (
;
””( )
foreach
’’ 
(
’’ 
var
’’ 
selector
’’ 
in
’’  
_searchSequence
’’! 0
)
’’0 1
{
÷÷ 	
var
◊◊ 
value
◊◊ 
=
◊◊ 
selector
◊◊  
(
◊◊  !
device
◊◊! '
)
◊◊' (
;
◊◊( )
if
ÿÿ 
(
ÿÿ 
!
ÿÿ 
string
ÿÿ 
.
ÿÿ  
IsNullOrWhiteSpace
ÿÿ *
(
ÿÿ* +
value
ÿÿ+ 0
)
ÿÿ0 1
&&
ÿÿ2 4
value
ŸŸ 
.
ŸŸ 
ToLowerInvariant
ŸŸ &
(
ŸŸ& '
)
ŸŸ' (
.
ŸŸ( )
Contains
ŸŸ) 1
(
ŸŸ1 2
input
ŸŸ2 7
)
ŸŸ7 8
)
ŸŸ8 9
{
⁄⁄ 
return
€€ 
true
€€ 
;
€€ 
}
‹‹ 
}
›› 	
return
ﬂﬂ 
false
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 
public
„„ 


Dictionary
„„ 
<
„„ 
string
„„ 
,
„„ 
string
„„ $
>
„„$ %#
GetMacIdToFileNameMap
„„& ;
(
„„; <
)
„„< =
{
‰‰ 
return
ÂÂ 

GetDevices
ÂÂ 
(
ÂÂ 
)
ÂÂ 
.
ÂÂ 
ToDictionary
ÂÂ (
(
ÂÂ( )
d
ÂÂ) *
=>
ÂÂ+ -
d
ÂÂ. /
.
ÂÂ/ 0
MacId
ÂÂ0 5
,
ÂÂ5 6
d
ÂÂ7 8
=>
ÂÂ9 ;
d
ÂÂ< =
.
ÂÂ= >
FileName
ÂÂ> F
,
ÂÂF G
StringComparer
ÂÂH V
.
ÂÂV W
OrdinalIgnoreCase
ÂÂW h
)
ÂÂh i
;
ÂÂi j
}
ÊÊ 
public
ËË 

async
ËË 
Task
ËË 
<
ËË 
DeviceDetails
ËË #
>
ËË# $+
GetPropertyPanelDataForDevice
ËË% B
(
ËËB C
string
ËËC I
deviceId
ËËJ R
)
ËËR S
{
ÈÈ 
var
ÎÎ 
state
ÎÎ 
=
ÎÎ 
_deviceStateCache
ÎÎ %
.
ÎÎ% &
GetAllStates
ÎÎ& 2
(
ÎÎ2 3
)
ÎÎ3 4
.
ÎÎ4 5
TryGetValue
ÎÎ5 @
(
ÎÎ@ A
deviceId
ÎÎA I
,
ÎÎI J
out
ÎÎK N
var
ÎÎO R
deviceState
ÎÎS ^
)
ÎÎ^ _
?
ÎÎ` a
deviceState
ÎÎb m
:
ÎÎn o
null
ÎÎp t
;
ÎÎt u
if
ÌÌ 

(
ÌÌ 
state
ÌÌ 
?
ÌÌ 
.
ÌÌ 
Root
ÌÌ 
==
ÌÌ 
null
ÌÌ 
)
ÌÌ  
{
ÓÓ 	
_logger
ÔÔ 
.
ÔÔ 
LogError
ÔÔ 
(
ÔÔ 
$str
ÔÔ R
,
ÔÔR S
deviceId
ÔÔT \
)
ÔÔ\ ]
;
ÔÔ] ^
throw
 
new
 
	Exception
 
(
  
$str
  C
)
C D
;
D E
}
ÒÒ 	
try
ÛÛ 
{
ÙÙ 	
var
ıı 
json
ıı 
=
ıı 
state
ıı 
.
ıı 
Root
ıı !
.
ıı! "
ToJsonString
ıı" .
(
ıı. /
)
ıı/ 0
;
ıı0 1
return
ˆˆ 
JsonSerializer
ˆˆ !
.
ˆˆ! "
Deserialize
ˆˆ" -
<
ˆˆ- .
DeviceDetails
ˆˆ. ;
>
ˆˆ; <
(
ˆˆ< =
json
ˆˆ= A
,
ˆˆA B
new
ˆˆC F#
JsonSerializerOptions
ˆˆG \
{
˜˜ )
PropertyNameCaseInsensitive
¯¯ +
=
¯¯, -
true
¯¯. 2
}
˘˘ 
)
˘˘ 
!
˘˘ 
;
˘˘ 
}
˙˙ 	
catch
˚˚ 
(
˚˚ 
	Exception
˚˚ 
ex
˚˚ 
)
˚˚ 
{
¸¸ 	
_logger
˝˝ 
.
˝˝ 
LogError
˝˝ 
(
˝˝ 
ex
˝˝ 
,
˝˝  
$str
˝˝! R
,
˝˝R S
deviceId
˝˝T \
)
˝˝\ ]
;
˝˝] ^
throw
˛˛ 
new
˛˛ 
	Exception
˛˛ 
(
˛˛  
$str
˛˛  @
)
˛˛@ A
;
˛˛A B
}
ˇˇ 	
}
ÄÄ 
public
ÇÇ 

async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
bool
ÇÇ 
>
ÇÇ 0
"SimulateTopLevelChangeForOneDevice
ÇÇ >
(
ÇÇ> ?
)
ÇÇ? @
{
ÉÉ 
int
ÑÑ 
index
ÑÑ 
=
ÑÑ #
RandomNumberGenerator
ÑÑ )
.
ÑÑ) *
GetInt32
ÑÑ* 2
(
ÑÑ2 3

GetDevices
ÑÑ3 =
(
ÑÑ= >
)
ÑÑ> ?
.
ÑÑ? @
Count
ÑÑ@ E
)
ÑÑE F
;
ÑÑF G
var
ÜÜ 
device
ÜÜ 
=
ÜÜ 

GetDevices
ÜÜ 
(
ÜÜ  
)
ÜÜ  !
[
ÜÜ! "
index
ÜÜ" '
]
ÜÜ' (
;
ÜÜ( )
var
àà 
rootSnapshot
àà 
=
àà 
_deviceStateCache
àà ,
.
àà, -
GetDeviceState
àà- ;
(
àà; <
device
àà< B
.
ààB C
MacId
ààC H
)
ààH I
;
ààI J
if
ââ 

(
ââ 
rootSnapshot
ââ 
==
ââ 
null
ââ  
)
ââ  !
return
ââ" (
false
ââ) .
;
ââ. /
var
ãã 
previousTop
ãã 
=
ãã "
_deviceServiceHelper
ãã .
.
ãã. / 
ExtractTopLevelDto
ãã/ A
(
ããA B
device
ããB H
.
ããH I
MacId
ããI N
,
ããN O
rootSnapshot
ããP \
.
ãã\ ]
	DeepClone
ãã] f
(
ããf g
)
ããg h
)
ããh i
;
ããi j
bool
çç 

wasUpdated
çç 
=
çç 
false
çç 
;
çç  
await
èè 
_deviceStateCache
èè 
.
èè  
WithLock
èè  (
(
èè( )
device
èè) /
.
èè/ 0
MacId
èè0 5
,
èè5 6
async
èè7 <
(
èè= >
rootNode
èè> F
)
èèF G
=>
èèH J
{
êê 	
string
ëë 
?
ëë 
previousStatus
ëë "
=
ëë# $
rootNode
ëë% -
[
ëë- .
$str
ëë. 6
]
ëë6 7
?
ëë7 8
.
ëë8 9
GetValue
ëë9 A
<
ëëA B
string
ëëB H
>
ëëH I
(
ëëI J
)
ëëJ K
;
ëëK L
string
íí 
?
íí "
previousConnectivity
íí (
=
íí) *
rootNode
íí+ 3
[
íí3 4
$str
íí4 B
]
ííB C
?
ííC D
.
ííD E
GetValue
ííE M
<
ííM N
string
ííN T
>
ííT U
(
ííU V
)
ííV W
;
ííW X
var
îî 
	newStatus
îî 
=
îî  
_dynamicDataHelper
îî .
.
îî. /
GetRandomStatus
îî/ >
(
îî> ?
)
îî? @
;
îî@ A
var
ïï 
newConnectivity
ïï 
=
ïï  ! 
_dynamicDataHelper
ïï" 4
.
ïï4 5#
GetRandomConnectivity
ïï5 J
(
ïïJ K
)
ïïK L
;
ïïL M
bool
óó 
statusChanged
óó 
=
óó  
	newStatus
óó! *
!=
óó+ -
previousStatus
óó. <
;
óó< =
bool
òò !
connectivityChanged
òò $
=
òò% &
newConnectivity
òò' 6
!=
òò7 9"
previousConnectivity
òò: N
;
òòN O
if
öö 
(
öö 
!
öö 
statusChanged
öö 
&&
öö !
!
öö" #!
connectivityChanged
öö# 6
)
öö6 7
{
õõ 
return
úú 
;
úú 
}
ùù 
if
üü 
(
üü 
statusChanged
üü 
)
üü 
rootNode
üü '
[
üü' (
$str
üü( 0
]
üü0 1
=
üü2 3
	newStatus
üü4 =
;
üü= >
if
†† 
(
†† !
connectivityChanged
†† #
)
††# $
rootNode
††% -
[
††- .
$str
††. <
]
††< =
=
††> ?
newConnectivity
††@ O
;
††O P
var
¢¢ 
now
¢¢ 
=
¢¢ 
DateTime
¢¢ 
.
¢¢ 
UtcNow
¢¢ %
;
¢¢% &
rootNode
££ 
[
££ 
$str
££ "
]
££" #
=
££$ %
now
££& )
.
££) *
ToString
££* 2
(
££2 3
$str
££3 6
)
££6 7
;
££7 8
_deviceStateCache
§§ 
.
§§ 
UpdateLastUpdated
§§ /
(
§§/ 0
device
§§0 6
.
§§6 7
MacId
§§7 <
,
§§< =
now
§§> A
)
§§A B
;
§§B C
var
¶¶ 

currentTop
¶¶ 
=
¶¶ "
_deviceServiceHelper
¶¶ 1
.
¶¶1 2 
ExtractTopLevelDto
¶¶2 D
(
¶¶D E
device
¶¶E K
.
¶¶K L
MacId
¶¶L Q
,
¶¶Q R
rootNode
¶¶S [
)
¶¶[ \
;
¶¶\ ]
if
®® 
(
®® !
_alarmToggleService
®® #
.
®®# $
IsAlarmEnabled
®®$ 2
)
®®2 3
{
©© 
await
™™ %
_alarmEvaluationService
™™ -
.
™™- .
EvaluateTopAsync
™™. >
(
™™> ?

currentTop
™™? I
,
™™I J
previousTop
™™K V
)
™™V W
;
™™W X
}
´´ 
var
≠≠ 
updatedDevice
≠≠ 
=
≠≠ 
new
≠≠  #
DeviceMetadata
≠≠$ 2
{
ÆÆ 
MacId
ØØ 
=
ØØ 
device
ØØ 
.
ØØ 
MacId
ØØ $
,
ØØ$ %
Name
∞∞ 
=
∞∞ 
rootNode
∞∞ 
[
∞∞  
$str
∞∞  &
]
∞∞& '
?
∞∞' (
.
∞∞( )
GetValue
∞∞) 1
<
∞∞1 2
string
∞∞2 8
>
∞∞8 9
(
∞∞9 :
)
∞∞: ;
??
∞∞< >
$str
∞∞? H
,
∞∞H I
Type
±± 
=
±± 
rootNode
±± 
[
±±  
$str
±±  &
]
±±& '
?
±±' (
.
±±( )
GetValue
±±) 1
<
±±1 2
string
±±2 8
>
±±8 9
(
±±9 :
)
±±: ;
??
±±< >
$str
±±? H
,
±±H I
FileName
≤≤ 
=
≤≤ 
rootNode
≤≤ #
[
≤≤# $
$str
≤≤$ .
]
≤≤. /
?
≤≤/ 0
.
≤≤0 1
GetValue
≤≤1 9
<
≤≤9 :
string
≤≤: @
>
≤≤@ A
(
≤≤A B
)
≤≤B C
??
≤≤D F
$str
≤≤G I
,
≤≤I J
Status
≥≥ 
=
≥≥ 
rootNode
≥≥ !
[
≥≥! "
$str
≥≥" *
]
≥≥* +
?
≥≥+ ,
.
≥≥, -
GetValue
≥≥- 5
<
≥≥5 6
string
≥≥6 <
>
≥≥< =
(
≥≥= >
)
≥≥> ?
??
≥≥@ B
	newStatus
≥≥C L
,
≥≥L M
Connectivity
¥¥ 
=
¥¥ 
rootNode
¥¥ '
[
¥¥' (
$str
¥¥( 6
]
¥¥6 7
?
¥¥7 8
.
¥¥8 9
GetValue
¥¥9 A
<
¥¥A B
string
¥¥B H
>
¥¥H I
(
¥¥I J
)
¥¥J K
??
¥¥L N
newConnectivity
¥¥O ^
,
¥¥^ _
LastUpdated
µµ 
=
µµ 
now
µµ !
}
∂∂ 
;
∂∂ 
var
∏∏ 
updatedFields
∏∏ 
=
∏∏ 
new
∏∏  #
List
∏∏$ (
<
∏∏( )
string
∏∏) /
>
∏∏/ 0
(
∏∏0 1
)
∏∏1 2
;
∏∏2 3
if
ππ 
(
ππ 
statusChanged
ππ 
)
ππ 
updatedFields
ππ ,
.
ππ, -
Add
ππ- 0
(
ππ0 1
$str
ππ1 9
)
ππ9 :
;
ππ: ;
if
∫∫ 
(
∫∫ !
connectivityChanged
∫∫ #
)
∫∫# $
updatedFields
∫∫% 2
.
∫∫2 3
Add
∫∫3 6
(
∫∫6 7
$str
∫∫7 E
)
∫∫E F
;
∫∫F G
await
ºº "
_deviceServiceHelper
ºº &
.
ºº& '&
BroadcastTopLevelSummary
ºº' ?
(
ºº? @
new
ºº@ C
List
ººD H
<
ººH I
(
ººI J
DeviceMetadata
ººJ X
,
ººX Y
List
ººZ ^
<
ºº^ _
string
ºº_ e
>
ººe f
)
ººf g
>
ººg h
{
ººi j
(
ººk l
updatedDevice
ººl y
,
ººy z
updatedFieldsºº{ à
)ººà â
}ººä ã
)ººã å
;ººå ç

wasUpdated
ææ 
=
ææ 
true
ææ 
;
ææ 
}
øø 	
)
øø	 

;
øø
 
return
¡¡ 

wasUpdated
¡¡ 
;
¡¡ 
}
¬¬ 
public
ƒƒ 

async
ƒƒ 
Task
ƒƒ 
<
ƒƒ 
bool
ƒƒ 
>
ƒƒ 5
'SimulateDynamicPropertiesUpdateForBatch
ƒƒ C
(
ƒƒC D
)
ƒƒD E
{
≈≈ 
var
∆∆ "
updatedDeviceDetails
∆∆  
=
∆∆! "
new
∆∆# &
List
∆∆' +
<
∆∆+ ,
(
∆∆, -
string
∆∆- 3
MacId
∆∆4 9
,
∆∆9 :
string
∆∆; A
	EventName
∆∆B K
,
∆∆K L
JsonElement
∆∆M X
DetailPayload
∆∆Y f
)
∆∆f g
>
∆∆g h
(
∆∆h i
)
∆∆i j
;
∆∆j k
foreach
»» 
(
»» 
var
»» 
device
»» 
in
»» 

GetDevices
»» )
(
»») *
)
»»* +
)
»»+ ,
{
…… 	
var
   
root
   
=
   
_deviceStateCache
   (
.
  ( )
GetDeviceState
  ) 7
(
  7 8
device
  8 >
.
  > ?
MacId
  ? D
)
  D E
;
  E F
if
ÀÀ 
(
ÀÀ 
root
ÀÀ 
==
ÀÀ 
null
ÀÀ 
)
ÀÀ 
continue
ÀÀ &
;
ÀÀ& '
await
ÕÕ 
_deviceStateCache
ÕÕ #
.
ÕÕ# $
WithLock
ÕÕ$ ,
(
ÕÕ, -
device
ÕÕ- 3
.
ÕÕ3 4
MacId
ÕÕ4 9
,
ÕÕ9 :
async
ÕÕ; @
(
ÕÕA B
root
ÕÕB F
)
ÕÕF G
=>
ÕÕH J
{
ŒŒ 
var
œœ 
previousDynamic
œœ #
=
œœ$ %"
_deviceServiceHelper
œœ& :
.
œœ: ;
ExtractDynamicDto
œœ; L
(
œœL M
device
œœM S
.
œœS T
MacId
œœT Y
,
œœY Z
root
œœ[ _
.
œœ_ `
	DeepClone
œœ` i
(
œœi j
)
œœj k
)
œœk l
;
œœl m
var
–– 
updatedNode
–– 
=
––  !"
_deviceServiceHelper
––" 6
.
––6 7%
UpdateDynamicProperties
––7 N
(
––N O
root
––O S
[
––S T
$str
––T g
]
––g h
,
––h i
root
––j n
[
––n o
$str––o É
]––É Ñ
)––Ñ Ö
;––Ö Ü
var
““ 
currentDynamic
““ "
=
““# $"
_deviceServiceHelper
““% 9
.
““9 :
ExtractDynamicDto
““: K
(
““K L
device
““L R
.
““R S
MacId
““S X
,
““X Y
root
““Z ^
)
““^ _
;
““_ `
if
‘‘ 
(
‘‘ !
_alarmToggleService
‘‘ '
.
‘‘' (
IsAlarmEnabled
‘‘( 6
)
‘‘6 7
{
’’ 
await
÷÷ %
_alarmEvaluationService
÷÷ 1
.
÷÷1 2"
EvaluateDynamicAsync
÷÷2 F
(
÷÷F G
previousDynamic
÷÷G V
,
÷÷V W
currentDynamic
÷÷X f
)
÷÷f g
;
÷÷g h
}
◊◊ 
if
ŸŸ 
(
ŸŸ 
updatedNode
ŸŸ 
is
ŸŸ  "
not
ŸŸ# &
null
ŸŸ' +
)
ŸŸ+ ,
{
⁄⁄ 
var
‹‹ 
jsonElement
‹‹ #
=
‹‹$ %
JsonDocument
‹‹& 2
.
‹‹2 3
Parse
‹‹3 8
(
‹‹8 9
updatedNode
‹‹9 D
.
‹‹D E
ToJsonString
‹‹E Q
(
‹‹Q R
)
‹‹R S
)
‹‹S T
.
‹‹T U
RootElement
‹‹U `
.
‹‹` a
Clone
‹‹a f
(
‹‹f g
)
‹‹g h
;
‹‹h i"
updatedDeviceDetails
ﬁﬁ (
.
ﬁﬁ( )
Add
ﬁﬁ) ,
(
ﬁﬁ, -
(
ﬁﬁ- .
MacId
ﬂﬂ 
:
ﬂﬂ 
device
ﬂﬂ %
.
ﬂﬂ% &
MacId
ﬂﬂ& +
,
ﬂﬂ+ ,
	EventName
‡‡ !
:
‡‡! "
$"
‡‡# %
$str
‡‡% 2
{
‡‡2 3
device
‡‡3 9
.
‡‡9 :
MacId
‡‡: ?
}
‡‡? @
"
‡‡@ A
,
‡‡A B
DetailPayload
·· %
:
··% &
jsonElement
··' 2
)
‚‚ 
)
‚‚ 
;
‚‚ 
}
„„ 
}
‰‰ 
)
‰‰ 
;
‰‰ 
}
ÂÂ 	
await
ÁÁ "
_deviceServiceHelper
ÁÁ "
.
ÁÁ" #*
BroadcastDeviceDetailUpdates
ÁÁ# ?
(
ÁÁ? @"
updatedDeviceDetails
ÁÁ@ T
)
ÁÁT U
;
ÁÁU V
return
ËË 
true
ËË 
;
ËË 
}
ÈÈ 
public
ÎÎ 

async
ÎÎ 
Task
ÎÎ 
<
ÎÎ 
List
ÎÎ 
<
ÎÎ !
DevicesNameMacIdDto
ÎÎ .
>
ÎÎ. /
>
ÎÎ/ 0%
GetDevicesNameMacIdList
ÎÎ1 H
(
ÎÎH I
)
ÎÎI J
{
ÏÏ 
return
ÌÌ 

GetDevices
ÌÌ 
(
ÌÌ 
)
ÌÌ 
.
ÌÌ 
Select
ÌÌ "
(
ÌÌ" #
d
ÌÌ# $
=>
ÌÌ% '
new
ÌÌ( +!
DevicesNameMacIdDto
ÌÌ, ?
{
ÓÓ 	

DeviceName
ÔÔ 
=
ÔÔ 
d
ÔÔ 
.
ÔÔ 
Name
ÔÔ 
,
ÔÔ  
DeviceMacId
 
=
 
d
 
.
 
MacId
 !
}
ÒÒ 	
)
ÒÒ	 

.
ÒÒ
 
ToList
ÒÒ 
(
ÒÒ 
)
ÒÒ 
;
ÒÒ 
}
ÚÚ 
public
ÙÙ 

async
ÙÙ 
Task
ÙÙ 
<
ÙÙ 1
#DeviceMetadataPaginatedandSortedDto
ÙÙ 9
>
ÙÙ9 :+
GetAllDataRefereshedFromCache
ÙÙ; X
(
ÙÙX Y'
DeviceTopLevelSortOptions
ÙÙY r
request
ÙÙs z
,
ÙÙz {
stringÙÙ| Ç
inputÙÙÉ à
=ÙÙâ ä
$strÙÙã ç
)ÙÙç é
{
ıı 
await
ˆˆ %
refreshDeviceStateCache
ˆˆ %
(
ˆˆ% &
)
ˆˆ& '
;
ˆˆ' (
if
¯¯ 

(
¯¯ 
input
¯¯ 
!=
¯¯ 
$str
¯¯  
)
¯¯  !
return
˘˘ 0
"GetSearchedDeviceMetadataPaginated
˘˘ 5
(
˘˘5 6
request
˘˘6 =
,
˘˘= >
input
˘˘? D
)
˘˘D E
;
˘˘E F
return
˚˚ 4
&GetAllDeviceMetadataPaginatedandSorted
˚˚ 5
(
˚˚5 6
request
˚˚6 =
)
˚˚= >
;
˚˚> ?
}
¸¸ 
public
ˇˇ 

async
ˇˇ 
Task
ˇˇ 
<
ˇˇ 
string
ˇˇ 
>
ˇˇ 

UploadFile
ˇˇ (
(
ˇˇ( )
	IFormFile
ˇˇ) 2
file
ˇˇ3 7
)
ˇˇ7 8
{
ÄÄ 
if
ÇÇ 

(
ÇÇ 
file
ÇÇ 
==
ÇÇ 
null
ÇÇ 
||
ÇÇ 
file
ÇÇ  
.
ÇÇ  !
Length
ÇÇ! '
==
ÇÇ( *
$num
ÇÇ+ ,
)
ÇÇ, -
throw
ÉÉ 
new
ÉÉ 
	Exception
ÉÉ 
(
ÉÉ  
$str
ÉÉ  3
)
ÉÉ3 4
;
ÉÉ4 5
string
ÜÜ 
fileContent
ÜÜ 
=
ÜÜ 
await
ÜÜ ""
ReadFileContentAsync
ÜÜ# 7
(
ÜÜ7 8
file
ÜÜ8 <
)
ÜÜ< =
;
ÜÜ= >
JsonDocument
ââ 
jsonDoc
ââ 
=
ââ 
ParseJsonDocument
ââ 0
(
ââ0 1
fileContent
ââ1 <
)
ââ< =
;
ââ= >
JsonElement
ää 
root
ää 
=
ää 
jsonDoc
ää "
.
ää" #
RootElement
ää# .
;
ää. /
var
çç 
(
çç 
	macIdProp
çç 
,
çç 
staticProps
çç #
,
çç# $
dynamicProps
çç% 1
,
çç1 2

alarmRules
çç3 =
)
çç= >
=
çç? @&
ValidateAndExtractFields
ççA Y
(
ççY Z
root
ççZ ^
,
çç^ _
file
çç` d
.
ççd e
FileName
ççe m
)
ççm n
;
ççn o
var
êê 
deviceState
êê 
=
êê 
new
êê 
DeviceState
êê )
{
ëë 	
Root
íí 
=
íí 
JsonNode
íí 
.
íí 
Parse
íí !
(
íí! "
fileContent
íí" -
)
íí- .
!
íí. /
,
íí/ 0
LastUpdated
ìì 
=
ìì 
DateTime
ìì "
.
ìì" #
UtcNow
ìì# )
}
îî 	
;
îî	 

if
óó 

(
óó 
_useDatabase
óó 
)
óó 
{
òò 	
await
ôô $
InsertDeviceInDatabase
ôô (
(
ôô( )
root
ôô) -
,
ôô- .
	macIdProp
ôô/ 8
,
ôô8 9
staticProps
ôô: E
,
ôôE F
dynamicProps
ôôG S
,
ôôS T
deviceState
ôôU `
.
ôô` a
LastUpdated
ôôa l
)
ôôl m
;
ôôm n
}
öö 	
else
õõ 
{
úú 	
await
ùù "
SaveDeviceFileToDisk
ùù &
(
ùù& '
file
ùù' +
.
ùù+ ,
FileName
ùù, 4
,
ùù4 5
fileContent
ùù6 A
)
ùùA B
;
ùùB C
}
ûû 	
var
°° 
rulesToSend
°° 
=
°° 
ParseAlarmRules
°° )
(
°°) *

alarmRules
°°* 4
)
°°4 5
;
°°5 6
await
¢¢ %
_alarmEvaluationService
¢¢ %
.
¢¢% &
AddAlarmRules
¢¢& 3
(
¢¢3 4
	macIdProp
¢¢4 =
.
¢¢= >
ToString
¢¢> F
(
¢¢F G
)
¢¢G H
,
¢¢H I
rulesToSend
¢¢J U
)
¢¢U V
;
¢¢V W
await
•• 
_deviceStateCache
•• 
.
••  
	LoadAsync
••  )
(
••) *
)
••* +
;
••+ ,
return
ßß 
$str
ßß +
;
ßß+ ,
}
®® 
private
≠≠ 
async
≠≠ 
Task
≠≠ 
<
≠≠ 
string
≠≠ 
>
≠≠ "
ReadFileContentAsync
≠≠ 3
(
≠≠3 4
	IFormFile
≠≠4 =
file
≠≠> B
)
≠≠B C
{
ÆÆ 
using
ØØ 
var
ØØ 
reader
ØØ 
=
ØØ 
new
ØØ 
StreamReader
ØØ +
(
ØØ+ ,
file
ØØ, 0
.
ØØ0 1
OpenReadStream
ØØ1 ?
(
ØØ? @
)
ØØ@ A
)
ØØA B
;
ØØB C
return
∞∞ 
await
∞∞ 
reader
∞∞ 
.
∞∞ 
ReadToEndAsync
∞∞ *
(
∞∞* +
)
∞∞+ ,
;
∞∞, -
}
±± 
private
∂∂ 
JsonDocument
∂∂ 
ParseJsonDocument
∂∂ *
(
∂∂* +
string
∂∂+ 1
fileContent
∂∂2 =
)
∂∂= >
{
∑∑ 
try
∏∏ 
{
ππ 	
return
∫∫ 
JsonDocument
∫∫ 
.
∫∫  
Parse
∫∫  %
(
∫∫% &
fileContent
∫∫& 1
)
∫∫1 2
;
∫∫2 3
}
ªª 	
catch
ºº 
(
ºº 
JsonException
ºº 
)
ºº 
{
ΩΩ 	
throw
ææ 
new
ææ 
	Exception
ææ 
(
ææ  
$str
ææ  D
)
ææD E
;
ææE F
}
øø 	
}
¿¿ 
private
∆∆ 
(
∆∆ 
JsonElement
∆∆ 
	macIdProp
∆∆ "
,
∆∆" #
JsonElement
∆∆$ /
staticProps
∆∆0 ;
,
∆∆; <
JsonElement
∆∆= H
dynamicProps
∆∆I U
,
∆∆U V
JsonElement
∆∆W b

alarmRules
∆∆c m
)
∆∆m n&
ValidateAndExtractFields
««  
(
««  !
JsonElement
««! ,
root
««- 1
,
««1 2
string
««3 9
uploadedFileName
««: J
)
««J K
{
»» 
if
…… 

(
…… 
!
…… 
root
…… 
.
…… 
TryGetProperty
……  
(
……  !
$str
……! '
,
……' (
out
……) ,
_
……- .
)
……. /
||
……0 2
!
   
root
   
.
   
TryGetProperty
    
(
    !
$str
  ! '
,
  ' (
out
  ) ,
_
  - .
)
  . /
||
  0 2
!
ÀÀ 
root
ÀÀ 
.
ÀÀ 
TryGetProperty
ÀÀ  
(
ÀÀ  !
$str
ÀÀ! (
,
ÀÀ( )
out
ÀÀ* -
var
ÀÀ. 1
	macIdProp
ÀÀ2 ;
)
ÀÀ; <
||
ÀÀ= ?
!
ÃÃ 
root
ÃÃ 
.
ÃÃ 
TryGetProperty
ÃÃ  
(
ÃÃ  !
$str
ÃÃ! 3
,
ÃÃ3 4
out
ÃÃ5 8
var
ÃÃ9 <
staticProps
ÃÃ= H
)
ÃÃH I
||
ÃÃJ L
!
ÕÕ 
root
ÕÕ 
.
ÕÕ 
TryGetProperty
ÕÕ  
(
ÕÕ  !
$str
ÕÕ! 4
,
ÕÕ4 5
out
ÕÕ6 9
var
ÕÕ: =
dynamicProps
ÕÕ> J
)
ÕÕJ K
||
ÕÕL N
!
ŒŒ 
root
ŒŒ 
.
ŒŒ 
TryGetProperty
ŒŒ  
(
ŒŒ  !
$str
ŒŒ! -
,
ŒŒ- .
out
ŒŒ/ 2
var
ŒŒ3 6

alarmRules
ŒŒ7 A
)
ŒŒA B
)
ŒŒB C
{
œœ 	
throw
–– 
new
–– 
	Exception
–– 
(
––  
$str––  ê
)––ê ë
;––ë í
}
—— 	
if
‘‘ 

(
‘‘ 
staticProps
‘‘ 
.
‘‘ 
	ValueKind
‘‘ !
!=
‘‘" $
JsonValueKind
‘‘% 2
.
‘‘2 3
Object
‘‘3 9
||
‘‘: <
dynamicProps
‘‘= I
.
‘‘I J
	ValueKind
‘‘J S
!=
‘‘T V
JsonValueKind
‘‘W d
.
‘‘d e
Object
‘‘e k
)
‘‘k l
throw
’’ 
new
’’ 
	Exception
’’ 
(
’’  
$str
’’  b
)
’’b c
;
’’c d
return
◊◊ 
(
◊◊ 
	macIdProp
◊◊ 
,
◊◊ 
staticProps
◊◊ &
,
◊◊& '
dynamicProps
◊◊( 4
,
◊◊4 5

alarmRules
◊◊6 @
)
◊◊@ A
;
◊◊A B
}
ÿÿ 
private
›› 
async
›› 
Task
›› $
InsertDeviceInDatabase
›› -
(
››- .
JsonElement
ﬁﬁ 
root
ﬁﬁ 
,
ﬁﬁ 
JsonElement
ﬂﬂ 
	macIdProp
ﬂﬂ 
,
ﬂﬂ 
JsonElement
‡‡ 
staticProps
‡‡ 
,
‡‡  
JsonElement
·· 
dynamicProps
··  
,
··  !
DateTime
‚‚ 
lastUpdated
‚‚ 
)
‚‚ 
{
„„ 
var
‰‰ 
macId
‰‰ 
=
‰‰ 
	macIdProp
‰‰ 
.
‰‰ 
	GetString
‰‰ '
(
‰‰' (
)
‰‰( )
;
‰‰) *
var
ÊÊ 
device
ÊÊ 
=
ÊÊ 
await
ÊÊ 

_dbContext
ÊÊ %
.
ÊÊ% &
Devices
ÊÊ& -
.
ÊÊ- .!
FirstOrDefaultAsync
ÊÊ. A
(
ÊÊA B
d
ÊÊB C
=>
ÊÊD F
d
ÊÊG H
.
ÊÊH I
MacId
ÊÊI N
==
ÊÊO Q
macId
ÊÊR W
)
ÊÊW X
;
ÊÊX Y
if
ÁÁ 

(
ÁÁ 
device
ÁÁ 
!=
ÁÁ 
null
ÁÁ 
)
ÁÁ 
{
ËË 	
throw
ÈÈ 
new
ÈÈ 
	Exception
ÈÈ 
(
ÈÈ  
$"
ÈÈ  "
$str
ÈÈ" 6
{
ÈÈ6 7
device
ÈÈ7 =
.
ÈÈ= >
Name
ÈÈ> B
}
ÈÈB C
$strÈÈC à
"ÈÈà â
)ÈÈâ ä
;ÈÈä ã
}
ÍÍ 	
else
ÎÎ 
{
ÏÏ 	
device
ÓÓ 
=
ÓÓ 
new
ÓÓ 
Device
ÓÓ 
{
ÔÔ 
MacId
 
=
 
macId
 
,
 
Name
ÒÒ 
=
ÒÒ 
root
ÒÒ 
.
ÒÒ 
GetProperty
ÒÒ '
(
ÒÒ' (
$str
ÒÒ( .
)
ÒÒ. /
.
ÒÒ/ 0
	GetString
ÒÒ0 9
(
ÒÒ9 :
)
ÒÒ: ;
,
ÒÒ; <
Type
ÚÚ 
=
ÚÚ 
root
ÚÚ 
.
ÚÚ 
GetProperty
ÚÚ '
(
ÚÚ' (
$str
ÚÚ( .
)
ÚÚ. /
.
ÚÚ/ 0
	GetString
ÚÚ0 9
(
ÚÚ9 :
)
ÚÚ: ;
,
ÚÚ; <
Status
ÛÛ 
=
ÛÛ 
root
ÛÛ 
.
ÛÛ 
GetProperty
ÛÛ )
(
ÛÛ) *
$str
ÛÛ* 2
)
ÛÛ2 3
.
ÛÛ3 4
	GetString
ÛÛ4 =
(
ÛÛ= >
)
ÛÛ> ?
,
ÛÛ? @
Connectivity
ÙÙ 
=
ÙÙ 
root
ÙÙ #
.
ÙÙ# $
GetProperty
ÙÙ$ /
(
ÙÙ/ 0
$str
ÙÙ0 >
)
ÙÙ> ?
.
ÙÙ? @
	GetString
ÙÙ@ I
(
ÙÙI J
)
ÙÙJ K
,
ÙÙK L
LastUpdated
ıı 
=
ıı 
lastUpdated
ıı )
,
ıı) *
StaticProperties
ˆˆ  
=
ˆˆ! "
staticProps
ˆˆ# .
.
ˆˆ. /

GetRawText
ˆˆ/ 9
(
ˆˆ9 :
)
ˆˆ: ;
,
ˆˆ; <
DynamicProperties
˜˜ !
=
˜˜" #
dynamicProps
˜˜$ 0
.
˜˜0 1

GetRawText
˜˜1 ;
(
˜˜; <
)
˜˜< =
,
˜˜= >!
TopLevelObservables
¯¯ #
=
¯¯$ %
root
¯¯& *
.
¯¯* +
TryGetProperty
¯¯+ 9
(
¯¯9 :
$str
¯¯: O
,
¯¯O P
out
¯¯Q T
var
¯¯U X
topObs2
¯¯Y `
)
¯¯` a
?
¯¯b c
topObs2
¯¯d k
.
¯¯k l

GetRawText
¯¯l v
(
¯¯v w
)
¯¯w x
:
¯¯y z
$str
¯¯{ 
,¯¯ Ä 
DynamicObservables
˘˘ "
=
˘˘# $
root
˘˘% )
.
˘˘) *
TryGetProperty
˘˘* 8
(
˘˘8 9
$str
˘˘9 M
,
˘˘M N
out
˘˘O R
var
˘˘S V
dynObs2
˘˘W ^
)
˘˘^ _
?
˘˘` a
dynObs2
˘˘b i
.
˘˘i j

GetRawText
˘˘j t
(
˘˘t u
)
˘˘u v
:
˘˘w x
$str
˘˘y }
}
˙˙ 
;
˙˙ 
await
˚˚ 

_dbContext
˚˚ 
.
˚˚ 
Devices
˚˚ $
.
˚˚$ %
AddAsync
˚˚% -
(
˚˚- .
device
˚˚. 4
)
˚˚4 5
;
˚˚5 6
}
¸¸ 	
await
˛˛ 

_dbContext
˛˛ 
.
˛˛ 
SaveChangesAsync
˛˛ )
(
˛˛) *
)
˛˛* +
;
˛˛+ ,
}
ˇˇ 
private
ÑÑ 
async
ÑÑ 
Task
ÑÑ "
SaveDeviceFileToDisk
ÑÑ +
(
ÑÑ+ ,
string
ÑÑ, 2
fileName
ÑÑ3 ;
,
ÑÑ; <
string
ÑÑ= C
fileContent
ÑÑD O
)
ÑÑO P
{
ÖÖ 
if
ÜÜ 

(
ÜÜ 
!
ÜÜ 
	Directory
ÜÜ 
.
ÜÜ 
Exists
ÜÜ 
(
ÜÜ 
_dataDirectory
ÜÜ ,
)
ÜÜ, -
)
ÜÜ- .
	Directory
áá 
.
áá 
CreateDirectory
áá %
(
áá% &
_dataDirectory
áá& 4
)
áá4 5
;
áá5 6
var
ââ 
filePath
ââ 
=
ââ 
Path
ââ 
.
ââ 
Combine
ââ #
(
ââ# $
_dataDirectory
ââ$ 2
,
ââ2 3
fileName
ââ4 <
)
ââ< =
;
ââ= >
if
ää 

(
ää 
File
ää 
.
ää 
Exists
ää 
(
ää 
filePath
ää  
)
ää  !
)
ää! "
throw
ãã 
new
ãã 
	Exception
ãã 
(
ãã  
$"
ãã  "
$str
ãã" S
{
ããS T
fileName
ããT \
}
ãã\ ]
$str
ãã] y
"
ããy z
)
ããz {
;
ãã{ |
await
çç 
File
çç 
.
çç 
WriteAllTextAsync
çç $
(
çç$ %
filePath
çç% -
,
çç- .
fileContent
çç/ :
)
çç: ;
;
çç; <
}
éé 
private
êê 
async
êê 
Task
êê 
<
êê 
bool
êê 
>
êê %
refreshDeviceStateCache
êê 4
(
êê4 5
)
êê5 6
{
ëë 
await
íí 
_deviceStateCache
íí 
.
íí   
PersistToDiskAsync
íí  2
(
íí2 3
)
íí3 4
;
íí4 5
await
ìì 
_deviceStateCache
ìì 
.
ìì  
	LoadAsync
ìì  )
(
ìì) *
)
ìì* +
;
ìì+ ,
return
ïï 
true
ïï 
;
ïï 
}
ññ 
private
òò 
List
òò 
<
òò 
AlarmRuleDto
òò 
>
òò 
ParseAlarmRules
òò .
(
òò. /
JsonElement
òò/ :
alarmRulesElement
òò; L
)
òòL M
{
ôô 
var
öö 
rules
öö 
=
öö 
new
öö 
List
öö 
<
öö 
AlarmRuleDto
öö )
>
öö) *
(
öö* +
)
öö+ ,
;
öö, -
foreach
úú 
(
úú 
var
úú 
ruleJson
úú 
in
úú  
alarmRulesElement
úú! 2
.
úú2 3
EnumerateArray
úú3 A
(
úúA B
)
úúB C
)
úúC D
{
ùù 	
var
ûû 
rule
ûû 
=
ûû 
new
ûû 
AlarmRuleDto
ûû '
{
üü 
	FieldPath
†† 
=
†† 
ruleJson
†† $
.
††$ %
GetProperty
††% 0
(
††0 1
$str
††1 <
)
††< =
.
††= >
	GetString
††> G
(
††G H
)
††H I
!
††I J
,
††J K
Operator
°° 
=
°° 
ruleJson
°° #
.
°°# $
GetProperty
°°$ /
(
°°/ 0
$str
°°0 :
)
°°: ;
.
°°; <
	GetString
°°< E
(
°°E F
)
°°F G
!
°°G H
,
°°H I
ThresholdValue
¢¢ 
=
¢¢  
ruleJson
¢¢! )
.
¢¢) *
GetProperty
¢¢* 5
(
¢¢5 6
$str
¢¢6 F
)
¢¢F G
.
¢¢G H
	GetString
¢¢H Q
(
¢¢Q R
)
¢¢R S
!
¢¢S T
,
¢¢T U
Severity
££ 
=
££ 
ruleJson
££ #
.
££# $
GetProperty
££$ /
(
££/ 0
$str
££0 :
)
££: ;
.
££; <
	GetString
££< E
(
££E F
)
££F G
!
££G H
,
££H I
MessageTemplate
§§ 
=
§§  !
ruleJson
§§" *
.
§§* +
GetProperty
§§+ 6
(
§§6 7
$str
§§7 H
)
§§H I
.
§§I J
	GetString
§§J S
(
§§S T
)
§§T U
!
§§U V
}
•• 
;
•• 
rules
ßß 
.
ßß 
Add
ßß 
(
ßß 
rule
ßß 
)
ßß 
;
ßß 
}
®® 	
return
™™ 
rules
™™ 
;
™™ 
}
´´ 
public
≠≠ 
1
#DeviceMetadataPaginatedandSortedDto
≠≠ ."
GetAllDeviceMetadata
≠≠/ C
(
≠≠C D
)
≠≠D E
{
ÆÆ 
var
ØØ 
metaData
ØØ 
=
ØØ 

GetDevices
ØØ !
(
ØØ! "
)
ØØ" #
.
ØØ# $
AsQueryable
ØØ$ /
(
ØØ/ 0
)
ØØ0 1
;
ØØ1 2
return
≥≥ 
new
≥≥ 1
#DeviceMetadataPaginatedandSortedDto
≥≥ 6
(
≥≥6 7
)
≥≥7 8
{
¥¥ 	

TotalCount
µµ 
=
µµ 
metaData
µµ !
.
µµ! "
Count
µµ" '
(
µµ' (
)
µµ( )
,
µµ) *
DeviceMetadata
∂∂ 
=
∂∂ 
metaData
∂∂ %
.
∂∂% &
ToList
∂∂& ,
(
∂∂, -
)
∂∂- .
}
∑∑ 	
;
∑∑	 

}
∏∏ 
}ππ õ"
ùC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\DeviceLiveDataBgService.cs
	namespace 	
Infrastructure
 
. 
Services !
{ 
public 

class #
DeviceLiveDataBgService (
:) *
BackgroundService+ <
{ 
private 
readonly 
ILogger  
<  !#
DeviceLiveDataBgService! 8
>8 9
_logger: A
;A B
private 
readonly 
DeviceStateCache )
_deviceStateCache* ;
;; <
private 
readonly  
IServiceScopeFactory -
_scopeFactory. ;
;; <
private 
DateTime "
_lastDynamicUpdateTime /
=0 1
DateTime2 :
.: ;
UtcNow; A
;A B
public #
DeviceLiveDataBgService &
(& '
DeviceStateCache' 7
deviceStateCache8 H
,H I 
IServiceScopeFactoryJ ^
scopeFactory_ k
,k l
ILoggerm t
<t u$
DeviceLiveDataBgService	u å
>
å ç
logger
é î
)
î ï
{ 	
_deviceStateCache 
= 
deviceStateCache  0
;0 1
_logger 
= 
logger 
; 
_scopeFactory 
= 
scopeFactory (
;( )
} 	
	protected 
override 
async  
Task! %
ExecuteAsync& 2
(2 3
CancellationToken3 D
stoppingTokenE R
)R S
{ 	
_logger 
. 
LogInformation "
(" #
$str# H
)H I
;I J
using   
(   
var   
scope   
=   
_scopeFactory   ,
.  , -
CreateScope  - 8
(  8 9
)  9 :
)  : ;
{!! 
var"" 
deviceService"" !
=""" #
scope""$ )
."") *
ServiceProvider""* 9
.""9 :
GetRequiredService"": L
<""L M
IDeviceService""M [
>""[ \
(""\ ]
)""] ^
;""^ _
await## 
_deviceStateCache## '
.##' (
	LoadAsync##( 1
(##1 2
)##2 3
;##3 4
while%% 
(%% 
!%% 
stoppingToken%% %
.%%% &#
IsCancellationRequested%%& =
)%%= >
{&& 
await'' 
deviceService'' '
.''' (.
"SimulateTopLevelChangeForOneDevice''( J
(''J K
)''K L
;''L M
if)) 
()) 
()) 
DateTime)) !
.))! "
UtcNow))" (
-))) *"
_lastDynamicUpdateTime))+ A
)))A B
.))B C
TotalSeconds))C O
>=))P R
$num))S U
)))U V
{** 
await++ 
deviceService++ +
.+++ ,3
'SimulateDynamicPropertiesUpdateForBatch++, S
(++S T
)++T U
;++U V"
_lastDynamicUpdateTime,, .
=,,/ 0
DateTime,,1 9
.,,9 :
UtcNow,,: @
;,,@ A
}-- 
await00 
Task00 
.00 
Delay00 $
(00$ %
TimeSpan00% -
.00- .
FromSeconds00. 9
(009 :
$num00: <
)00< =
,00= >
stoppingToken00? L
)00L M
;00M N
}11 
}22 
_logger44 
.44 
LogInformation44 "
(44" #
$str44# H
)44H I
;44I J
}55 	
public77 
override77 
Task77 
	StopAsync77 &
(77& '
CancellationToken77' 8
cancellationToken779 J
)77J K
{88 	
Console99 
.99 
	WriteLine99 
(99 
$str99 =
)99= >
;99> ?
return:: 
base:: 
.:: 
	StopAsync:: !
(::! "
cancellationToken::" 3
)::3 4
;::4 5
};; 	
}<< 
}== ˙
òC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\AlarmToggleService.cs
	namespace 	
Infrastructure
 
. 
Services !
{		 
public

 

class

 
AlarmToggleService

 #
:

$ %
IAlarmToggleService

& 9
{ 
private 
bool 

_isEnabled 
=  !
false" '
;' (
public 
bool 
IsAlarmEnabled "
=># %

_isEnabled& 0
;0 1
public 
void 
SetAlarmEnabled #
(# $
bool$ (
enabled) 0
)0 1
{ 	

_isEnabled 
= 
enabled  
;  !
} 	
} 
} ë'
úC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\AlarmEvaluationService.cs
	namespace 	
Infrastructure
 
. 
Services !
{ 
public		 

class		 "
AlarmEvaluationService		 '
:		( )#
IAlarmEvaluationService		* A
{

 
private 
readonly 

HttpClient #
_httpClient$ /
;/ 0
private 
readonly 
ILogger  
<  !"
AlarmEvaluationService! 7
>7 8
_logger9 @
;@ A
public "
AlarmEvaluationService %
(% &

HttpClient& 0

httpClient1 ;
,; <
ILogger= D
<D E"
AlarmEvaluationServiceE [
>[ \
logger] c
)c d
{ 	
_httpClient 
= 

httpClient $
;$ %
_logger 
= 
logger 
; 
} 	
public 
async 
Task 
EvaluateTopAsync *
(* +!
TopLevelDeviceDataDto+ @
previousA I
,I J!
TopLevelDeviceDataDtoK `
currenta h
)h i
{ 	
var 
request 
= 
new 
{ 
Type 
= 
$str !
,! "
Previous 
= 
previous #
,# $
Current 
= 
current !
} 
; 
await 
SendRequestAsync "
(" #
request# *
,* +
$str, D
)D E
;E F
} 	
public   
async   
Task    
EvaluateDynamicAsync   .
(  . / 
DynamicDeviceDataDto  / C
previous  D L
,  L M 
DynamicDeviceDataDto  N b
current  c j
)  j k
{!! 	
var"" 
request"" 
="" 
new"" 
{## 
Type$$ 
=$$ 
$str$$  
,$$  !
Previous%% 
=%% 
previous%% #
,%%# $
Current&& 
=&& 
current&& !
}'' 
;'' 
await)) 
SendRequestAsync)) "
())" #
request))# *
,))* +
$str)), H
)))H I
;))I J
}** 	
public,, 
async,, 
Task,, 
AddAlarmRules,, '
(,,' (
string,,( .
deviceMacId,,/ :
,,,: ;
List,,< @
<,,@ A
AlarmRuleDto,,A M
>,,M N

alarmRules,,O Y
),,Y Z
{-- 	
await.. 
SendRequestAsync.. "
(.." #

alarmRules..# -
,..- .
$"../ 1
$str..1 J
{..J K
deviceMacId..K V
}..V W
"..W X
)..X Y
;..Y Z
}// 	
private11 
async11 
Task11 
SendRequestAsync11 +
<11+ ,
T11, -
>11- .
(11. /
T11/ 0
payload111 8
,118 9
string11: @
endpoint11A I
)11I J
{22 	
var33 
json33 
=33 
JsonSerializer33 %
.33% &
	Serialize33& /
(33/ 0
payload330 7
,337 8
new339 <!
JsonSerializerOptions33= R
{44  
PropertyNamingPolicy55 $
=55% &
JsonNamingPolicy55' 7
.557 8
	CamelCase558 A
}66 
)66 
;66 
var88 
content88 
=88 
new88 
StringContent88 +
(88+ ,
json88, 0
,880 1
Encoding882 :
.88: ;
UTF888; ?
,88? @
$str88A S
)88S T
;88T U
try:: 
{;; 
var<< 
response<< 
=<< 
await<< $
_httpClient<<% 0
.<<0 1
	PostAsync<<1 :
(<<: ;
endpoint<<; C
,<<C D
content<<E L
)<<L M
;<<M N
if== 
(== 
!== 
response== 
.== 
IsSuccessStatusCode== 1
)==1 2
{>> 
_logger?? 
.?? 

LogWarning?? &
(??& '
$str??' `
,??` a
response??b j
.??j k

StatusCode??k u
)??u v
;??v w
}@@ 
}AA 
catchBB 
(BB 
	ExceptionBB 
exBB 
)BB  
{CC 
_loggerDD 
.DD 
LogErrorDD  
(DD  !
exDD! #
,DD# $
$strDD% O
)DDO P
;DDP Q
}EE 
}FF 	
}GG 
}HH í
èC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\RealTime\DeviceHub.cs”
òC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Persistence\DeviceDbContext.cs
	namespace		 	
Infrastructure		
 
.		 
Persistence		 $
{

 
public 

class 
DeviceDbContext  
:! "
	DbContext# ,
{ 
public 
DeviceDbContext 
( 
DbContextOptions /
</ 0
DeviceDbContext0 ?
>? @
optionsA H
)H I
: 
base 
( 
options 
) 
{ 
} 
public 
DbSet 
< 
Device 
> 
Devices $
{% &
get' *
;* +
set, /
;/ 0
}1 2
=3 4
default5 <
!< =
;= >
} 
} ¡ñ
ñC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Helpers\DynamicDataHelper.cs
	namespace 	
Infrastructure
 
. 
Helpers  
{ 
public		 

class		 
DynamicDataHelper		 "
:		# $
IDynamicDataHelper		% 7
{

 
private 
static 
readonly 
string  &
[& '
]' (
statuses) 1
=2 3
{4 5
$str6 >
,> ?
$str@ I
}J K
;K L
private 
static 
readonly 
string  &
[& '
]' (
conns) .
=/ 0
{1 2
$str3 8
,8 9
$str: B
,B C
$strD J
}K L
;L M
string 
IDynamicDataHelper !
.! "
GetRandomStatus" 1
(1 2
)2 3
{ 	
int 
index 
= !
RandomNumberGenerator -
.- .
GetInt32. 6
(6 7
statuses7 ?
.? @
Length@ F
)F G
;G H
return 
statuses 
[ 
index !
]! "
;" #
} 	
string 
IDynamicDataHelper !
.! "!
GetRandomConnectivity" 7
(7 8
)8 9
{ 	
int 
index 
= !
RandomNumberGenerator -
.- .
GetInt32. 6
(6 7
conns7 <
.< =
Length= C
)C D
;D E
return 
conns 
[ 
index 
] 
;  
} 	
public 
JsonNode .
"GenerateDynamicDataFromObservables :
(: ;
JsonNode; C
?C D
currentDataE P
,P Q
JsonNodeR Z
?Z [
dynamicObservables\ n
)n o
{ 	
if 
( 
dynamicObservables "
is# %
not& )

JsonObject* 4
observableMap5 B
)B C
return 
currentData "
;" #
try 
{   
foreach!! 
(!! 
var!! 
(!! 
	fieldName!! '
,!!' (
observableDef!!) 6
)!!6 7
in!!8 :
observableMap!!; H
)!!H I
{"" 
if## 
(## 
observableDef## %
is##& (
not##) ,

JsonObject##- 7
defObj##8 >
)##> ?
continue$$  
;$$  !
if&& 
(&& 
defObj&& 
.&& 
TryGetPropertyValue&& 2
(&&2 3
$str&&3 9
,&&9 :
out&&; >
var&&? B
typeNode&&C K
)&&K L
&&&&M O
typeNode&&P X
!=&&Y [
null&&\ `
)&&` a
{'' 
var(( 
type((  
=((! "
typeNode((# +
.((+ ,
GetValue((, 4
<((4 5
string((5 ;
>((; <
(((< =
)((= >
;((> ?
var)) 
generatedValue)) *
=))+ ,
GenerateValue))- :
()): ;
type)); ?
,))? @
defObj))A G
)))G H
;))H I
currentData** #
[**# $
	fieldName**$ -
]**- .
=**/ 0
generatedValue**1 ?
;**? @
}++ 
else,, 
{-- 
var.. 
existingChild.. )
=..* +
currentData.., 7
[..7 8
	fieldName..8 A
]..A B
as..C E
JsonNode..F N
??..O Q
new..R U

JsonObject..V `
(..` a
)..a b
;..b c
var// 
updatedChild// (
=//) *.
"GenerateDynamicDataFromObservables//+ M
(//M N
existingChild//N [
,//[ \
defObj//] c
)//c d
;//d e
currentData00 #
[00# $
	fieldName00$ -
]00- .
=00/ 0
updatedChild001 =
;00= >
}11 
}22 
}33 
catch44 
(44 
	Exception44 
)44 
{55 
return66 
null66 
;66 
}77 
return99 
currentData99 
;99 
}:: 	
private<< 
JsonNode<< 
GenerateValue<< &
(<<& '
string<<' -
type<<. 2
,<<2 3

JsonObject<<4 >
def<<? B
)<<B C
{== 	
double>> 
min>> 
=>> 
def>> 
.>> 
TryGetPropertyValue>> 0
(>>0 1
$str>>1 6
,>>6 7
out>>8 ;
var>>< ?
minNode>>@ G
)>>G H
?>>I J
minNode>>K R
?>>R S
.>>S T
GetValue>>T \
<>>\ ]
double>>] c
>>>c d
(>>d e
)>>e f
??>>g i
$num>>j k
:>>l m
$num>>n o
;>>o p
double?? 
max?? 
=?? 
def?? 
.?? 
TryGetPropertyValue?? 0
(??0 1
$str??1 6
,??6 7
out??8 ;
var??< ?
maxNode??@ G
)??G H
???I J
maxNode??K R
???R S
.??S T
GetValue??T \
<??\ ]
double??] c
>??c d
(??d e
)??e f
????g i
$num??j m
:??n o
$num??p s
;??s t
int@@ 
count@@ 
=@@ 
def@@ 
.@@ 
TryGetPropertyValue@@ /
(@@/ 0
$str@@0 7
,@@7 8
out@@9 <
var@@= @
	countNode@@A J
)@@J K
?@@L M
	countNode@@N W
?@@W X
.@@X Y
GetValue@@Y a
<@@a b
int@@b e
>@@e f
(@@f g
)@@g h
??@@i k
$num@@l m
:@@n o
$num@@p q
;@@q r
intBB 
SecureNextIntBB 
(BB 
intBB !
maxExclusiveBB" .
)BB. /
=>BB0 2!
RandomNumberGeneratorBB3 H
.BBH I
GetInt32BBI Q
(BBQ R
maxExclusiveBBR ^
)BB^ _
;BB_ `
doubleCC 
SecureNextDoubleCC #
(CC# $
)CC$ %
=>CC& (!
RandomNumberGeneratorCC) >
.CC> ?
GetInt32CC? G
(CCG H
intCCH K
.CCK L
MaxValueCCL T
)CCT U
/CCV W
(CCX Y
doubleCCY _
)CC_ `
intCC` c
.CCc d
MaxValueCCd l
;CCl m
switchEE 
(EE 
typeEE 
)EE 
{FF 
caseGG 
$strGG 
:GG 
returnHH 
	JsonValueHH $
.HH$ %
CreateHH% +
(HH+ ,
SecureNextIntHH, 9
(HH9 :
(HH: ;
intHH; >
)HH> ?
maxHH? B
-HHC D
(HHE F
intHHF I
)HHI J
minHHJ M
+HHN O
$numHHP Q
)HHQ R
+HHS T
(HHU V
intHHV Y
)HHY Z
minHHZ ]
)HH] ^
;HH^ _
caseJJ 
$strJJ 
:JJ 
returnKK 
	JsonValueKK $
.KK$ %
CreateKK% +
(KK+ ,
MathKK, 0
.KK0 1
RoundKK1 6
(KK6 7
minKK7 :
+KK; <
SecureNextDoubleKK= M
(KKM N
)KKN O
*KKP Q
(KKR S
maxKKS V
-KKW X
minKKY \
)KK\ ]
,KK] ^
$numKK_ `
)KK` a
)KKa b
;KKb c
caseMM 
$strMM !
:MM! "
returnNN 
	JsonValueNN $
.NN$ %
CreateNN% +
(NN+ ,
$"NN, .
{NN. /
SecureNextIntNN/ <
(NN< =
$numNN= @
)NN@ A
}NNA B
$strNNB C
"NNC D
)NND E
;NNE F
casePP 
$strPP 
:PP 
returnQQ 
	JsonValueQQ $
.QQ$ %
CreateQQ% +
(QQ+ ,
SecureNextDoubleQQ, <
(QQ< =
)QQ= >
<QQ? @
$numQQA D
)QQD E
;QQE F
caseSS 
$strSS 
:SS 
ifTT 
(TT 
defTT 
.TT 
TryGetPropertyValueTT /
(TT/ 0
$strTT0 8
,TT8 9
outTT: =
varTT> A

valuesNodeTTB L
)TTL M
&&TTN P

valuesNodeTTQ [
isTT\ ^
	JsonArrayTT_ h
valArrTTi o
&&TTp r
valArrTTs y
.TTy z
CountTTz 
>
TTÄ Å
$num
TTÇ É
)
TTÉ Ñ
returnUU 
	JsonValueUU (
.UU( )
CreateUU) /
(UU/ 0
valArrUU0 6
[UU6 7
SecureNextIntUU7 D
(UUD E
valArrUUE K
.UUK L
CountUUL Q
)UUQ R
]UUR S
?UUS T
.UUT U
ToStringUUU ]
(UU] ^
)UU^ _
)UU_ `
;UU` a
returnVV 
	JsonValueVV $
.VV$ %
CreateVV% +
(VV+ ,
$strVV, 5
)VV5 6
;VV6 7
caseXX 
$strXX 
:XX 
returnYY 
	JsonValueYY $
.YY$ %
CreateYY% +
(YY+ ,
$"YY, .
{YY. /
SecureNextIntYY/ <
(YY< =
$numYY= ?
)YY? @
}YY@ A
$strYYA H
{YYH I
SecureNextIntYYI V
(YYV W
$numYYW Y
)YYY Z
}YYZ [
$strYY[ _
"YY_ `
)YY` a
;YYa b
case[[ 
$str[[  
:[[  !
return\\ 
	JsonValue\\ $
.\\$ %
Create\\% +
(\\+ ,
DateTime\\, 4
.\\4 5
UtcNow\\5 ;
.\\; <
ToString\\< D
(\\D E
$str\\E H
)\\H I
)\\I J
;\\J K
case^^ 
$str^^ 
:^^ 
return__ 
	JsonValue__ $
.__$ %
Create__% +
(__+ ,
$"__, .
$str__. 6
{__6 7
SecureNextInt__7 D
(__D E
$num__E H
)__H I
}__I J
$str__J K
{__K L
SecureNextInt__L Y
(__Y Z
$num__Z ]
)__] ^
+___ `
$num__a b
}__b c
"__c d
)__d e
;__e f
caseaa 
$straa 
:aa 
returnbb 
	JsonValuebb $
.bb$ %
Createbb% +
(bb+ ,
stringbb, 2
.bb2 3
Joinbb3 7
(bb7 8
$strbb8 ;
,bb; <

Enumerablebb= G
.bbG H
RangebbH M
(bbM N
$numbbN O
,bbO P
$numbbQ R
)bbR S
.bbS T
SelectbbT Z
(bbZ [
_bb[ \
=>bb] _
SecureNextIntbb` m
(bbm n
$numbbn q
)bbq r
.bbr s
ToStringbbs {
(bb{ |
$str	bb| Ä
)
bbÄ Å
)
bbÅ Ç
)
bbÇ É
)
bbÉ Ñ
;
bbÑ Ö
casedd 
$strdd 
:dd 
returnee 
	JsonValueee $
.ee$ %
Createee% +
(ee+ ,
$"ee, .
$stree. /
{ee/ 0
SecureNextIntee0 =
(ee= >
$numee> @
)ee@ A
+eeB C
$numeeD F
}eeF G
$streeG K
"eeK L
)eeL M
;eeM N
casegg 
$strgg !
:gg! "
returnhh 
	JsonValuehh $
.hh$ %
Createhh% +
(hh+ ,
$"hh, .
{hh. /
(hh/ 0
SecureNextDoublehh0 @
(hh@ A
)hhA B
*hhC D
$numhhE G
)hhG H
:hhH I
$strhhI K
}hhK L
$strhhL O
"hhO P
)hhP Q
;hhQ R
casejj 
$strjj 
:jj 
returnkk 
	JsonValuekk $
.kk$ %
Createkk% +
(kk+ ,
$strkk, ?
)kk? @
;kk@ A
casemm 
$strmm 
:mm 
{nn 
varoo 
listoo  
=oo! "
newoo# &
	JsonArrayoo' 0
(oo0 1
)oo1 2
;oo2 3
intpp 
arrCountpp $
=pp% &
defpp' *
.pp* +
TryGetPropertyValuepp+ >
(pp> ?
$strpp? F
,ppF G
outppH K
varppL O
arrCountNodeppP \
)pp\ ]
&&pp^ `
intppa d
.ppd e
TryParseppe m
(ppm n
arrCountNodeppn z
?ppz {
.pp{ |
ToString	pp| Ñ
(
ppÑ Ö
)
ppÖ Ü
,
ppÜ á
out
ppà ã
var
ppå è
c
ppê ë
)
ppë í
?
ppì î
c
ppï ñ
:
ppó ò
$num
ppô ö
;
ppö õ
ifrr 
(rr 
defrr 
.rr  
TryGetPropertyValuerr  3
(rr3 4
$strrr4 <
,rr< =
outrr> A
varrrB E
valNoderrF M
)rrM N
&&rrO Q
valNoderrR Y
isrrZ \
	JsonArrayrr] f

valTypeArrrrg q
&&rrr t

valTypeArrrru 
.	rr Ä
Count
rrÄ Ö
>
rrÜ á
$num
rrà â
)
rrâ ä
{ss 
vartt 
elementTypett  +
=tt, -

valTypeArrtt. 8
[tt8 9
$numtt9 :
]tt: ;
?tt; <
.tt< =
ToStringtt= E
(ttE F
)ttF G
??ttH J
$strttK P
;ttP Q
foruu 
(uu  !
intuu! $
iuu% &
=uu' (
$numuu) *
;uu* +
iuu, -
<uu. /
arrCountuu0 8
;uu8 9
iuu: ;
++uu; =
)uu= >
listvv  $
.vv$ %
Addvv% (
(vv( )
GenerateValuevv) 6
(vv6 7
elementTypevv7 B
,vvB C
defvvD G
)vvG H
)vvH I
;vvI J
returnww "
listww# '
;ww' (
}xx 
ifzz 
(zz 
defzz 
.zz  
TryGetPropertyValuezz  3
(zz3 4
$strzz4 ;
,zz; <
outzz= @
varzzA D
	itemsNodezzE N
)zzN O
&&zzP R
	itemsNodezzS \
iszz] _

JsonObjectzz` j
itemDefzzk r
)zzr s
{{{ 
for|| 
(||  !
int||! $
i||% &
=||' (
$num||) *
;||* +
i||, -
<||. /
arrCount||0 8
;||8 9
i||: ;
++||; =
)||= >
{}} 
var~~  #
element~~$ +
=~~, -
new~~. 1

JsonObject~~2 <
(~~< =
)~~= >
;~~> ?
foreach  '
(( )
var) ,
prop- 1
in2 4
itemDef5 <
)< =
{
ÄÄ  !
var
ÅÅ$ '
propName
ÅÅ( 0
=
ÅÅ1 2
prop
ÅÅ3 7
.
ÅÅ7 8
Key
ÅÅ8 ;
;
ÅÅ; <
if
ÇÇ$ &
(
ÇÇ' (
prop
ÇÇ( ,
.
ÇÇ, -
Value
ÇÇ- 2
is
ÇÇ3 5

JsonObject
ÇÇ6 @

propSchema
ÇÇA K
&&
ÇÇL N

propSchema
ÇÇO Y
.
ÇÇY Z!
TryGetPropertyValue
ÇÇZ m
(
ÇÇm n
$str
ÇÇn t
,
ÇÇt u
out
ÇÇv y
var
ÇÇz }
typeNodeÇÇ~ Ü
)ÇÇÜ á
)ÇÇá à
element
ÉÉ( /
[
ÉÉ/ 0
propName
ÉÉ0 8
]
ÉÉ8 9
=
ÉÉ: ;
GenerateValue
ÉÉ< I
(
ÉÉI J
typeNode
ÉÉJ R
!
ÉÉR S
.
ÉÉS T
ToString
ÉÉT \
(
ÉÉ\ ]
)
ÉÉ] ^
,
ÉÉ^ _

propSchema
ÉÉ` j
)
ÉÉj k
;
ÉÉk l
}
ÑÑ  !
list
ÖÖ  $
.
ÖÖ$ %
Add
ÖÖ% (
(
ÖÖ( )
element
ÖÖ) 0
)
ÖÖ0 1
;
ÖÖ1 2
}
ÜÜ 
return
áá "
list
áá# '
;
áá' (
}
àà 
for
ää 
(
ää 
int
ää  
i
ää! "
=
ää# $
$num
ää% &
;
ää& '
i
ää( )
<
ää* +
arrCount
ää, 4
;
ää4 5
i
ää6 7
++
ää7 9
)
ää9 :
list
ãã  
.
ãã  !
Add
ãã! $
(
ãã$ %
SecureNextInt
ãã% 2
(
ãã2 3
$num
ãã3 5
)
ãã5 6
+
ãã7 8
$num
ãã9 :
)
ãã: ;
;
ãã; <
return
çç 
list
çç #
;
çç# $
}
éé 
case
êê 
$str
êê 
:
êê 
if
ëë 
(
ëë 
def
ëë 
.
ëë !
TryGetPropertyValue
ëë /
(
ëë/ 0
$str
ëë0 8
,
ëë8 9
out
ëë: =
var
ëë> A
pickVals
ëëB J
)
ëëJ K
&&
ëëL N
pickVals
ëëO W
is
ëëX Z
	JsonArray
ëë[ d
pickArr
ëëe l
)
ëël m
{
íí 
var
ìì 
shuffled
ìì $
=
ìì% &
pickArr
ìì' .
.
ìì. /
OrderBy
ìì/ 6
(
ìì6 7
_
ìì7 8
=>
ìì9 ;
SecureNextInt
ìì< I
(
ììI J
int
ììJ M
.
ììM N
MaxValue
ììN V
)
ììV W
)
ììW X
.
ììX Y
Take
ììY ]
(
ìì] ^
count
ìì^ c
)
ììc d
;
ììd e
var
îî 
resultArray
îî '
=
îî( )
new
îî* -
	JsonArray
îî. 7
(
îî7 8
)
îî8 9
;
îî9 :
foreach
ïï 
(
ïï  !
var
ïï! $
item
ïï% )
in
ïï* ,
shuffled
ïï- 5
)
ïï5 6
resultArray
ññ '
.
ññ' (
Add
ññ( +
(
ññ+ ,
item
ññ, 0
?
ññ0 1
.
ññ1 2
	DeepClone
ññ2 ;
(
ññ; <
)
ññ< =
)
ññ= >
;
ññ> ?
return
óó 
resultArray
óó *
;
óó* +
}
òò 
return
ôô 
new
ôô 
	JsonArray
ôô (
(
ôô( )
)
ôô) *
;
ôô* +
case
õõ 
$str
õõ !
:
õõ! "
case
úú 
$str
úú  
:
úú  !
case
ùù 
$str
ùù  
:
ùù  !
return
ûû 
	JsonValue
ûû $
.
ûû$ %
Create
ûû% +
(
ûû+ ,
$str
ûû, B
)
ûûB C
;
ûûC D
default
†† 
:
†† 
return
°° 
	JsonValue
°° $
.
°°$ %
Create
°°% +
(
°°+ ,
$str
°°, >
)
°°> ?
;
°°? @
}
¢¢ 
}
££ 	
}
§§ 
}•• »à
òC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Helpers\DeviceServiceHelper.cs
	namespace 	
Infrastructure
 
. 
Helpers  
{ 
public 

class 
DeviceServiceHelper $
:% & 
IDeviceServiceHelper' ;
{ 
private 
readonly 
ILogger  
<  !
DeviceService! .
>. /
_logger0 7
;7 8
private 
readonly 
IDynamicDataHelper +
_dynamicDataHelper, >
;> ?
private 
readonly 

HttpClient #
_httpClient$ /
;/ 0
public 
DeviceServiceHelper "
(" #
ILogger# *
<* +
DeviceService+ 8
>8 9
logger: @
,@ A
IDynamicDataHelperB T
dynamicDataHelperU f
,f g

HttpClienth r

httpClients }
)} ~
{ 	
_logger 
= 
logger 
; 
_dynamicDataHelper 
=  
dynamicDataHelper! 2
;2 3
_httpClient 
= 

httpClient $
;$ %
} 	
public !
TopLevelDeviceDataDto $
ExtractTopLevelDto% 7
(7 8
string8 >
macId? D
,D E
JsonNodeF N
rootNodeO W
)W X
{ 	
return   
new   !
TopLevelDeviceDataDto   ,
{!! 
DeviceMacId"" 
="" 
macId"" #
,""# $
Status## 
=## 
rootNode## !
[##! "
$str##" *
]##* +
?##+ ,
.##, -
GetValue##- 5
<##5 6
string##6 <
>##< =
(##= >
)##> ?
??##@ B
$str##C L
,##L M
Connectivity$$ 
=$$ 
rootNode$$ '
[$$' (
$str$$( 6
]$$6 7
?$$7 8
.$$8 9
GetValue$$9 A
<$$A B
string$$B H
>$$H I
($$I J
)$$J K
??$$L N
$str$$O X
}%% 
;%% 
}&& 	
public((  
DynamicDeviceDataDto(( #
ExtractDynamicDto(($ 5
(((5 6
string((6 <
macId((= B
,((B C
JsonNode((D L
rootNode((M U
)((U V
{)) 	
return** 
new**  
DynamicDeviceDataDto** +
{++ 
DeviceMacId,, 
=,, 
macId,, #
,,,# $
DynamicProperties-- !
=--" #
JsonDocument--$ 0
.--0 1
Parse--1 6
(--6 7
rootNode.. 
[.. 
$str.. 0
]..0 1
!..1 2
...2 3
ToJsonString..3 ?
(..? @
)..@ A
)// 
.// 
RootElement// 
}00 
;00 
}11 	
public33 
async33 
Task33 
WriteJsonFileAsync33 ,
(33, -
string33- 3
path334 8
,338 9
JsonNode33: B
rootNode33C K
)33K L
{44 	
string55 
json55 
=55 
rootNode55 "
.55" #
ToJsonString55# /
(55/ 0
new550 3!
JsonSerializerOptions554 I
{66 
Encoder77 
=77 
JavaScriptEncoder77 +
.77+ ,%
UnsafeRelaxedJsonEscaping77, E
,77E F
WriteIndented88 
=88 
true88  $
,88$ %
TypeInfoResolver99  
=99! "
new99# &'
DefaultJsonTypeInfoResolver99' B
(99B C
)99C D
}:: 
):: 
;:: 
await<< 
File<< 
.<< 
WriteAllTextAsync<< (
(<<( )
path<<) -
,<<- .
json<</ 3
)<<3 4
;<<4 5
}== 	
public?? 
async?? 
Task?? (
BroadcastDeviceDetailUpdates?? 6
(??6 7
List??7 ;
<??; <
(??< =
string??= C
MacId??D I
,??I J
string??K Q
	EventName??R [
,??[ \
JsonElement??] h
DetailPayload??i v
)??v w
>??w x
updates	??y Ä
)
??Ä Å
{@@ 	
foreachAA 
(AA 
varAA 
(AA 
macIdAA 
,AA  
	eventNameAA! *
,AA* +
payloadAA, 3
)AA3 4
inAA5 7
updatesAA8 ?
)AA? @
{BB 
varCC 
jsonCC 
=CC 
JsonSerializerCC )
.CC) *
	SerializeCC* 3
(CC3 4
payloadCC4 ;
,CC; <
newCC= @!
JsonSerializerOptionsCCA V
{DD 
EncoderEE 
=EE 
JavaScriptEncoderEE /
.EE/ 0%
UnsafeRelaxedJsonEscapingEE0 I
,EEI J
WriteIndentedFF !
=FF" #
trueFF$ (
}GG 
)GG 
;GG 
varII 
contentII 
=II 
newII !
StringContentII" /
(II/ 0
jsonII0 4
,II4 5
EncodingII6 >
.II> ?
UTF8II? C
,IIC D
$strIIE W
)IIW X
;IIX Y
tryJJ 
{KK 
awaitLL 
_httpClientLL %
.LL% &
	PostAsyncLL& /
(LL/ 0
$"LL0 2
$strLL2 j
{LLj k
macIdLLk p
}LLp q
"LLq r
,LLr s
contentLLt {
)LL{ |
;LL| }
}MM 
catchNN 
(NN  
HttpRequestExceptionNN +
exNN, .
)NN. /
{OO 
_loggerPP 
.PP 

LogWarningPP &
(PP& '
exPP' )
,PP) *
$"PP+ -
$strPP- a
{PPa b
macIdPPb g
}PPg h
$str	PPh Å
"
PPÅ Ç
)
PPÇ É
;
PPÉ Ñ
}QQ 
catchRR 
(RR 
	ExceptionRR  
exRR! #
)RR# $
{SS 
_loggerTT 
.TT 
LogErrorTT $
(TT$ %
exTT% '
,TT' (
$"TT) +
$strTT+ i
{TTi j
macIdTTj o
}TTo p
$strTTp q
"TTq r
)TTr s
;TTs t
}UU 
}VV 
}WW 	
publicYY 
asyncYY 
TaskYY $
BroadcastTopLevelSummaryYY 2
(YY2 3
ListYY3 7
<YY7 8
(YY8 9
DeviceMetadataYY9 G
deviceYYH N
,YYN O
ListYYP T
<YYT U
stringYYU [
>YY[ \
updatedFieldsYY] j
)YYj k
>YYk l

allDevicesYYm w
)YYw x
{ZZ 	
var[[ 
summary[[ 
=[[ 

allDevices[[ $
.[[$ %
Select[[% +
([[+ ,
entry[[, 1
=>[[2 4
{\\ 
var]] 
d]] 
=]] 
entry]] 
.]] 
device]] $
;]]$ %
var^^ 
updated^^ 
=^^ 
entry^^ #
.^^# $
updatedFields^^$ 1
;^^1 2
var`` 
obj`` 
=`` 
new`` 

Dictionary`` (
<``( )
string``) /
,``/ 0
object``1 7
?``7 8
>``8 9
{aa 
{bb  !
$strbb" )
,bb) *
dbb+ ,
.bb, -
MacIdbb- 2
}bb3 4
,bb4 5
{cc  !
$strcc" /
,cc/ 0
dcc1 2
.cc2 3
LastUpdatedcc3 >
}cc? @
}dd 
;dd 
ifff 
(ff 
updatedff 
.ff 
Containsff $
(ff$ %
$strff% -
)ff- .
)ff. /
objgg 
[gg 
$strgg  
]gg  !
=gg" #
dgg$ %
.gg% &
Statusgg& ,
;gg, -
ifii 
(ii 
updatedii 
.ii 
Containsii $
(ii$ %
$strii% 3
)ii3 4
)ii4 5
objjj 
[jj 
$strjj &
]jj& '
=jj( )
djj* +
.jj+ ,
Connectivityjj, 8
;jj8 9
returnll 
objll 
;ll 
}mm 
)mm 
.mm 
ToListmm 
(mm 
)mm 
;mm 
varoo 
jsonoo 
=oo 
JsonSerializeroo %
.oo% &
	Serializeoo& /
(oo/ 0
summaryoo0 7
,oo7 8
newoo9 <!
JsonSerializerOptionsoo= R
{pp 
Encoderqq 
=qq 
JavaScriptEncoderqq +
.qq+ ,%
UnsafeRelaxedJsonEscapingqq, E
,qqE F
WriteIndentedrr 
=rr 
truerr  $
}ss 
)ss 
;ss 
varuu 
contentuu 
=uu 
newuu 
StringContentuu +
(uu+ ,
jsonuu, 0
,uu0 1
Encodinguu2 :
.uu: ;
UTF8uu; ?
,uu? @
$struuA S
)uuS T
;uuT U
tryvv 
{ww 
awaitxx 
_httpClientxx !
.xx! "
	PostAsyncxx" +
(xx+ ,
$strxx, _
,xx_ `
contentxxa h
)xxh i
;xxi j
}yy 
catchzz 
(zz  
HttpRequestExceptionzz '
exzz( *
)zz* +
{{{ 
_logger|| 
.|| 

LogWarning|| "
(||" #
ex||# %
,||% &
$str||' g
)||g h
;||h i
}}} 
catch~~ 
(~~ 
	Exception~~ 
ex~~ 
)~~  
{ 
_logger
ÄÄ 
.
ÄÄ 
LogError
ÄÄ  
(
ÄÄ  !
ex
ÄÄ! #
,
ÄÄ# $
$str
ÄÄ% W
)
ÄÄW X
;
ÄÄX Y
}
ÅÅ 
}
ÇÇ 	
public
ÑÑ 
JsonNode
ÑÑ %
UpdateDynamicProperties
ÑÑ /
(
ÑÑ/ 0
JsonNode
ÑÑ0 8
?
ÑÑ8 9
currentData
ÑÑ: E
,
ÑÑE F
JsonNode
ÑÑG O
?
ÑÑO P 
dynamicObservables
ÑÑQ c
)
ÑÑc d
{
ÖÖ 	
var
ÜÜ 
original
ÜÜ 
=
ÜÜ 
currentData
ÜÜ &
?
ÜÜ& '
.
ÜÜ' (
	DeepClone
ÜÜ( 1
(
ÜÜ1 2
)
ÜÜ2 3
??
ÜÜ4 6
new
ÜÜ7 :

JsonObject
ÜÜ; E
(
ÜÜE F
)
ÜÜF G
;
ÜÜG H
var
àà 
result
àà 
=
àà  
_dynamicDataHelper
àà +
.
àà+ ,0
"GenerateDynamicDataFromObservables
àà, N
(
ààN O
currentData
ààO Z
,
ààZ [ 
dynamicObservables
àà\ n
)
ààn o
;
àào p
var
ää 
diff
ää 
=
ää 
GetJsonDiff
ää "
(
ää" #
original
ää# +
,
ää+ ,
result
ää- 3
)
ää3 4
;
ää4 5
return
ãã 
diff
ãã 
;
ãã 
}
åå 	
public
éé 
static
éé 
JsonNode
éé 
?
éé 
GetJsonDiff
éé  +
(
éé+ ,
JsonNode
éé, 4
?
éé4 5
original
éé6 >
,
éé> ?
JsonNode
éé@ H
?
ééH I
updated
ééJ Q
)
ééQ R
{
èè 	
if
êê 
(
êê 
original
êê 
is
êê 
	JsonValue
êê %
&&
êê& (
updated
êê) 0
is
êê1 3
	JsonValue
êê4 =
)
êê= >
{
ëë 
return
íí 
original
íí 
.
íí  
ToJsonString
íí  ,
(
íí, -
)
íí- .
==
íí/ 1
updated
íí2 9
.
íí9 :
ToJsonString
íí: F
(
ííF G
)
ííG H
?
ííI J
null
ííK O
:
ííP Q
	CloneNode
ííR [
(
íí[ \
updated
íí\ c
)
ííc d
;
ííd e
}
ìì 
if
ïï 
(
ïï 
original
ïï 
is
ïï 

JsonObject
ïï &
origObj
ïï' .
&&
ïï/ 1
updated
ïï2 9
is
ïï: <

JsonObject
ïï= G

updatedObj
ïïH R
)
ïïR S
{
ññ 
var
óó 
diff
óó 
=
óó 
new
óó 

JsonObject
óó )
(
óó) *
)
óó* +
;
óó+ ,
foreach
ôô 
(
ôô 
var
ôô 
kvp
ôô  
in
ôô! #

updatedObj
ôô$ .
)
ôô. /
{
öö 
var
õõ 
	origChild
õõ !
=
õõ" #
origObj
õõ$ +
.
õõ+ ,
ContainsKey
õõ, 7
(
õõ7 8
kvp
õõ8 ;
.
õõ; <
Key
õõ< ?
)
õõ? @
?
õõA B
origObj
õõC J
[
õõJ K
kvp
õõK N
.
õõN O
Key
õõO R
]
õõR S
:
õõT U
null
õõV Z
;
õõZ [
var
úú 
updatedChild
úú $
=
úú% &
kvp
úú' *
.
úú* +
Value
úú+ 0
;
úú0 1
var
ûû 
	childDiff
ûû !
=
ûû" #
GetJsonDiff
ûû$ /
(
ûû/ 0
	origChild
ûû0 9
,
ûû9 :
updatedChild
ûû; G
)
ûûG H
;
ûûH I
if
üü 
(
üü 
	childDiff
üü !
!=
üü" $
null
üü% )
)
üü) *
diff
†† 
[
†† 
kvp
††  
.
††  !
Key
††! $
]
††$ %
=
††& '
	childDiff
††( 1
;
††1 2
}
°° 
return
££ 
diff
££ 
.
££ 
Count
££ !
>
££" #
$num
££$ %
?
££& '
diff
££( ,
:
££- .
null
££/ 3
;
££3 4
}
§§ 
if
¶¶ 
(
¶¶ 
original
¶¶ 
is
¶¶ 
	JsonArray
¶¶ %
	origArray
¶¶& /
&&
¶¶0 2
updated
¶¶3 :
is
¶¶; =
	JsonArray
¶¶> G
updatedArray
¶¶H T
)
¶¶T U
{
ßß 
var
®® 
	arrayDiff
®® 
=
®® 
new
®®  #
	JsonArray
®®$ -
(
®®- .
)
®®. /
;
®®/ 0
bool
©© 

hasChanges
©© 
=
©©  !
false
©©" '
;
©©' (
int
´´ 
	maxLength
´´ 
=
´´ 
Math
´´  $
.
´´$ %
Max
´´% (
(
´´( )
	origArray
´´) 2
.
´´2 3
Count
´´3 8
,
´´8 9
updatedArray
´´: F
.
´´F G
Count
´´G L
)
´´L M
;
´´M N
for
¨¨ 
(
¨¨ 
int
¨¨ 
i
¨¨ 
=
¨¨ 
$num
¨¨ 
;
¨¨ 
i
¨¨  !
<
¨¨" #
	maxLength
¨¨$ -
;
¨¨- .
i
¨¨/ 0
++
¨¨0 2
)
¨¨2 3
{
≠≠ 
JsonNode
ÆÆ 
?
ÆÆ 
origElem
ÆÆ &
=
ÆÆ' (
i
ÆÆ) *
<
ÆÆ+ ,
	origArray
ÆÆ- 6
.
ÆÆ6 7
Count
ÆÆ7 <
?
ÆÆ= >
	origArray
ÆÆ? H
[
ÆÆH I
i
ÆÆI J
]
ÆÆJ K
:
ÆÆL M
null
ÆÆN R
;
ÆÆR S
JsonNode
ØØ 
?
ØØ 
updatedElem
ØØ )
=
ØØ* +
i
ØØ, -
<
ØØ. /
updatedArray
ØØ0 <
.
ØØ< =
Count
ØØ= B
?
ØØC D
updatedArray
ØØE Q
[
ØØQ R
i
ØØR S
]
ØØS T
:
ØØU V
null
ØØW [
;
ØØ[ \
var
±± 
	childDiff
±± !
=
±±" #
GetJsonDiff
±±$ /
(
±±/ 0
origElem
±±0 8
,
±±8 9
updatedElem
±±: E
)
±±E F
;
±±F G
if
≥≥ 
(
≥≥ 
	childDiff
≥≥ !
!=
≥≥" $
null
≥≥% )
)
≥≥) *
{
¥¥ 
	arrayDiff
µµ !
.
µµ! "
Add
µµ" %
(
µµ% &
	childDiff
µµ& /
)
µµ/ 0
;
µµ0 1

hasChanges
∂∂ "
=
∂∂# $
true
∂∂% )
;
∂∂) *
}
∑∑ 
}
∏∏ 
return
∫∫ 

hasChanges
∫∫ !
?
∫∫" #
	arrayDiff
∫∫$ -
:
∫∫. /
null
∫∫0 4
;
∫∫4 5
}
ªª 
return
ΩΩ 
	CloneNode
ΩΩ 
(
ΩΩ 
updated
ΩΩ $
)
ΩΩ$ %
;
ΩΩ% &
}
ææ 	
private
¿¿ 
static
¿¿ 
JsonNode
¿¿ 
?
¿¿  
	CloneNode
¿¿! *
(
¿¿* +
JsonNode
¿¿+ 3
?
¿¿3 4
node
¿¿5 9
)
¿¿9 :
{
¡¡ 	
return
¬¬ 
node
¬¬ 
==
¬¬ 
null
¬¬ 
?
¬¬  !
null
¬¬" &
:
¬¬' (
JsonNode
¬¬) 1
.
¬¬1 2
Parse
¬¬2 7
(
¬¬7 8
node
¬¬8 <
.
¬¬< =
ToJsonString
¬¬= I
(
¬¬I J
)
¬¬J K
)
¬¬K L
;
¬¬L M
}
√√ 	
}
ƒƒ 
}≈≈ ≥ú
ìC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Cache\DeviceStateCache.cs
	namespace 	
Infrastructure
 
. 
Cache 
{ 
public 

class 
DeviceState 
{ 
public 
JsonNode 
Root 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
default- 4
!4 5
;5 6
public 
DateTime 
LastUpdated #
{$ %
get& )
;) *
set+ .
;. /
}0 1
} 
public 

class 
DeviceStateCache !
{ 
private   
readonly   
string   
_dataDirectory    .
=  / 0
Path  1 5
.  5 6
Combine  6 =
(  = >
	Directory  > G
.  G H
	GetParent  H Q
(  Q R
	Directory  R [
.  [ \
GetCurrentDirectory  \ o
(  o p
)  p q
)  q r
!  r s
.  s t
FullName  t |
,  | }
$str	  ~ é
,
  é è
$str
  ê ñ
)
  ñ ó
;
  ó ò
private$$ 
readonly$$ 
ILogger$$  
<$$  !)
DeviceStatePersistenceService$$! >
>$$> ?
_logger$$@ G
;$$G H
private%% 
readonly%%  
ConcurrentDictionary%% -
<%%- .
string%%. 4
,%%4 5
DeviceState%%6 A
>%%A B

_deviceMap%%C M
=%%N O
new%%P S
(%%S T
)%%T U
;%%U V
private&& 
readonly&& 

Dictionary&& #
<&&# $
string&&$ *
,&&* +
string&&, 2
>&&2 3
_fileMap&&4 <
=&&= >
new&&? B
(&&B C
)&&C D
;&&D E
private'' 
readonly''  
ConcurrentDictionary'' -
<''- .
string''. 4
,''4 5
SemaphoreSlim''6 C
>''C D
_locks''E K
=''L M
new''N Q
(''Q R
)''R S
;''S T
private(( 
readonly(( 
bool(( 
_useDatabase(( *
;((* +
private)) 
readonly)) 
IServiceProvider)) )
_serviceProvider))* :
;)): ;
private** 
static** 
readonly** 
SemaphoreSlim**  -
_dbLock**. 5
=**6 7
new**8 ;
(**; <
$num**< =
,**= >
$num**? @
)**@ A
;**A B
public,, 
DeviceStateCache,, 
(,,  
ILogger-- 
<-- )
DeviceStatePersistenceService-- -
>--- .
logger--/ 5
,--5 6
IOptions.. 
<..  
DeviceStorageOptions.. %
>..% &
options..' .
,... /
IServiceProvider// 
serviceProvider// (
)//( )
{00 	
_logger11 
=11 
logger11 
;11 
_useDatabase22 
=22 
options22 "
.22" #
Value22# (
.22( )
UseDatabase22) 4
;224 5
_serviceProvider33 
=33 
serviceProvider33 .
;33. /
}44 	
public66  
ConcurrentDictionary66 #
<66# $
string66$ *
,66* +
DeviceState66, 7
>667 8
GetAllStates669 E
(66E F
)66F G
=>66H J

_deviceMap66K U
;66U V
public88 
async88 
Task88 
	LoadAsync88 #
(88# $
)88$ %
{99 	

_deviceMap:: 
.:: 
Clear:: 
(:: 
):: 
;:: 
if;; 
(;; 
_useDatabase;; 
);; 
{<< 
await== !
LoadFromDatabaseAsync== +
(==+ ,
)==, -
;==- .
}>> 
else?? 
{@@ 
awaitAA 
LoadFromFilesAsyncAA (
(AA( )
)AA) *
;AA* +
}BB 
}CC 	
privateEE 
asyncEE 
TaskEE !
LoadFromDatabaseAsyncEE 0
(EE0 1
)EE1 2
{FF 	
usingGG 
varGG 
scopeGG 
=GG 
_serviceProviderGG .
.GG. /
CreateScopeGG/ :
(GG: ;
)GG; <
;GG< =
varHH 
	dbContextHH 
=HH 
scopeHH !
.HH! "
ServiceProviderHH" 1
.HH1 2
GetRequiredServiceHH2 D
<HHD E
DeviceDbContextHHE T
>HHT U
(HHU V
)HHV W
;HHW X
varII 
devicesII 
=II 
awaitII 
	dbContextII  )
.II) *
DevicesII* 1
.II1 2
ToListAsyncII2 =
(II= >
)II> ?
;II? @
foreachKK 
(KK 
varKK 
deviceKK 
inKK  "
devicesKK# *
)KK* +
{LL 
varMM 
rootMM 
=MM 
newMM 

JsonObjectMM )
{NN 
[OO 
$strOO 
]OO 
=OO 
deviceOO  &
.OO& '
MacIdOO' ,
,OO, -
[PP 
$strPP 
]PP 
=PP 
devicePP %
.PP% &
NamePP& *
,PP* +
[QQ 
$strQQ 
]QQ 
=QQ 
deviceQQ %
.QQ% &
TypeQQ& *
,QQ* +
[RR 
$strRR 
]RR 
=RR  
deviceRR! '
.RR' (
StatusRR( .
,RR. /
[SS 
$strSS #
]SS# $
=SS% &
deviceSS' -
.SS- .
ConnectivitySS. :
,SS: ;
[TT 
$strTT "
]TT" #
=TT$ %
deviceTT& ,
.TT, -
LastUpdatedTT- 8
,TT8 9
[UU 
$strUU '
]UU' (
=UU) *
JsonNodeUU+ 3
.UU3 4
ParseUU4 9
(UU9 :
deviceUU: @
.UU@ A
StaticPropertiesUUA Q
)UUQ R
,UUR S
[VV 
$strVV (
]VV( )
=VV* +
JsonNodeVV, 4
.VV4 5
ParseVV5 :
(VV: ;
deviceVV; A
.VVA B
DynamicPropertiesVVB S
)VVS T
,VVT U
[WW 
$strWW *
]WW* +
=WW, -
JsonNodeWW. 6
.WW6 7
ParseWW7 <
(WW< =
deviceWW= C
.WWC D
TopLevelObservablesWWD W
)WWW X
,WWX Y
[XX 
$strXX )
]XX) *
=XX+ ,
JsonNodeXX- 5
.XX5 6
ParseXX6 ;
(XX; <
deviceXX< B
.XXB C
DynamicObservablesXXC U
)XXU V
}YY 
;YY 

_deviceMap[[ 
[[[ 
device[[ !
.[[! "
MacId[[" '
][[' (
=[[) *
new[[+ .
DeviceState[[/ :
{\\ 
Root]] 
=]] 
root]] 
,]]  
LastUpdated^^ 
=^^  !
device^^" (
.^^( )
LastUpdated^^) 4
}__ 
;__ 
}`` 
}aa 	
privatecc 
asynccc 
Taskcc 
LoadFromFilesAsynccc -
(cc- .
)cc. /
{dd 	
varee 
deviceFilesee 
=ee 
	Directoryee '
.ee' (
GetFilesee( 0
(ee0 1
_dataDirectoryee1 ?
,ee? @
$streeA I
)eeI J
;eeJ K
foreachff 
(ff 
varff 
fileff 
inff  
deviceFilesff! ,
)ff, -
{gg 
tryhh 
{ii 
varjj 
statejj 
=jj 
awaitjj  % 
ParseDeviceFileAsyncjj& :
(jj: ;
filejj; ?
)jj? @
;jj@ A
ifkk 
(kk 
statekk 
!=kk  
nullkk! %
)kk% &
{ll 
varmm 
macIdmm !
=mm" #
statemm$ )
.mm) *
Rootmm* .
[mm. /
$strmm/ 6
]mm6 7
!mm7 8
.mm8 9
ToStringmm9 A
(mmA B
)mmB C
;mmC D

_deviceMapnn "
[nn" #
macIdnn# (
]nn( )
=nn* +
statenn, 1
;nn1 2
_fileMapoo  
[oo  !
macIdoo! &
]oo& '
=oo( )
Pathoo* .
.oo. /
GetFileNameoo/ :
(oo: ;
fileoo; ?
)oo? @
;oo@ A
}pp 
}qq 
catchrr 
(rr 
	Exceptionrr  
exrr! #
)rr# $
{ss 
_loggertt 
.tt 
LogErrortt $
(tt$ %
extt% '
,tt' (
$strtt) E
,ttE F
filettG K
)ttK L
;ttL M
}uu 
}vv 
}ww 	
privateyy 
asyncyy 
Taskyy 
<yy 
DeviceStateyy &
?yy& '
>yy' ( 
ParseDeviceFileAsyncyy) =
(yy= >
stringyy> D
fileyyE I
)yyI J
{zz 	
var{{ 
json{{ 
={{ 
await{{ 
File{{ !
.{{! "
ReadAllTextAsync{{" 2
({{2 3
file{{3 7
){{7 8
;{{8 9
var|| 
node|| 
=|| 
JsonNode|| 
.||  
Parse||  %
(||% &
json||& *
)||* +
!||+ ,
;||, -
DateTime~~ 
lastUpdated~~  
=~~! "
DateTime~~# +
.~~+ ,
UtcNow~~, 2
;~~2 3
if 
( 
node 
[ 
$str "
]" #
is$ &
	JsonValue' 0
ts1 3
&&4 6
DateTime
ÄÄ 
.
ÄÄ 
TryParse
ÄÄ !
(
ÄÄ! "
ts
ÄÄ" $
.
ÄÄ$ %
ToString
ÄÄ% -
(
ÄÄ- .
)
ÄÄ. /
,
ÄÄ/ 0
out
ÄÄ1 4
var
ÄÄ5 8

parsedDate
ÄÄ9 C
)
ÄÄC D
)
ÄÄD E
lastUpdated
ÅÅ 
=
ÅÅ 

parsedDate
ÅÅ (
;
ÅÅ( )
return
ÉÉ 
new
ÉÉ 
DeviceState
ÉÉ "
{
ÑÑ 
Root
ÖÖ 
=
ÖÖ 
node
ÖÖ 
,
ÖÖ 
LastUpdated
ÜÜ 
=
ÜÜ 
lastUpdated
ÜÜ )
}
áá 
;
áá 
}
àà 	
public
ää 
JsonNode
ää 
?
ää 
GetDeviceState
ää '
(
ää' (
string
ää( .
macId
ää/ 4
)
ää4 5
{
ãã 	
return
åå 

_deviceMap
åå 
.
åå 
TryGetValue
åå )
(
åå) *
macId
åå* /
,
åå/ 0
out
åå1 4
var
åå5 8
state
åå9 >
)
åå> ?
?
åå@ A
state
ååB G
.
ååG H
Root
ååH L
:
ååM N
null
ååO S
;
ååS T
}
çç 	
public
èè 
async
èè 
Task
èè 
WithLock
èè "
(
èè" #
string
èè# )
macId
èè* /
,
èè/ 0
Func
èè1 5
<
èè5 6
JsonNode
èè6 >
,
èè> ?
Task
èè@ D
>
èèD E
updateFn
èèF N
)
èèN O
{
êê 	
var
ëë 
sem
ëë 
=
ëë 
_locks
ëë 
.
ëë 
GetOrAdd
ëë %
(
ëë% &
macId
ëë& +
,
ëë+ ,
_
ëë- .
=>
ëë/ 1
new
ëë2 5
SemaphoreSlim
ëë6 C
(
ëëC D
$num
ëëD E
,
ëëE F
$num
ëëG H
)
ëëH I
)
ëëI J
;
ëëJ K
await
íí 
sem
íí 
.
íí 
	WaitAsync
íí 
(
íí  
)
íí  !
;
íí! "
try
ìì 
{
îî 
if
ïï 
(
ïï 

_deviceMap
ïï 
.
ïï 
TryGetValue
ïï *
(
ïï* +
macId
ïï+ 0
,
ïï0 1
out
ïï2 5
var
ïï6 9
state
ïï: ?
)
ïï? @
)
ïï@ A
{
ññ 
await
óó 
updateFn
óó "
(
óó" #
state
óó# (
.
óó( )
Root
óó) -
)
óó- .
;
óó. /
}
òò 
}
ôô 
finally
öö 
{
õõ 
sem
úú 
.
úú 
Release
úú 
(
úú 
)
úú 
;
úú 
}
ùù 
}
ûû 	
public
†† 
void
†† 
UpdateLastUpdated
†† %
(
††% &
string
††& ,
macId
††- 2
,
††2 3
DateTime
††4 <
now
††= @
)
††@ A
{
°° 	
if
¢¢ 
(
¢¢ 

_deviceMap
¢¢ 
.
¢¢ 
TryGetValue
¢¢ &
(
¢¢& '
macId
¢¢' ,
,
¢¢, -
out
¢¢. 1
var
¢¢2 5
state
¢¢6 ;
)
¢¢; <
)
¢¢< =
{
££ 
state
§§ 
.
§§ 
LastUpdated
§§ !
=
§§" #
now
§§$ '
;
§§' (
}
•• 
}
¶¶ 	
public
®® 
async
®® 
Task
®®  
PersistToDiskAsync
®® ,
(
®®, -
)
®®- .
{
©© 	
await
™™ 
_dbLock
™™ 
.
™™ 
	WaitAsync
™™ #
(
™™# $
)
™™$ %
;
™™% &
try
´´ 
{
¨¨ 
if
≠≠ 
(
≠≠ 
_useDatabase
≠≠  
)
≠≠  !
{
ÆÆ 
await
ØØ $
PersistToDatabaseAsync
ØØ 0
(
ØØ0 1
)
ØØ1 2
;
ØØ2 3
}
∞∞ 
else
±± 
{
≤≤ 
await
≥≥ !
PersistToFilesAsync
≥≥ -
(
≥≥- .
)
≥≥. /
;
≥≥/ 0
}
¥¥ 
}
µµ 
finally
∂∂ 
{
∑∑ 
_dbLock
∏∏ 
.
∏∏ 
Release
∏∏ 
(
∏∏  
)
∏∏  !
;
∏∏! "
}
ππ 
}
∫∫ 	
private
ºº 
async
ºº 
Task
ºº $
PersistToDatabaseAsync
ºº 1
(
ºº1 2
)
ºº2 3
{
ΩΩ 	
using
ææ 
var
ææ 
scope
ææ 
=
ææ 
_serviceProvider
ææ .
.
ææ. /
CreateScope
ææ/ :
(
ææ: ;
)
ææ; <
;
ææ< =
var
øø 
	dbContext
øø 
=
øø 
scope
øø !
.
øø! "
ServiceProvider
øø" 1
.
øø1 2 
GetRequiredService
øø2 D
<
øøD E
DeviceDbContext
øøE T
>
øøT U
(
øøU V
)
øøV W
;
øøW X
await
¿¿ 
	dbContext
¿¿ 
.
¿¿ 
Database
¿¿ $
.
¿¿$ % 
ExecuteSqlRawAsync
¿¿% 7
(
¿¿7 8
$str
¿¿8 R
)
¿¿R S
;
¿¿S T
foreach
¬¬ 
(
¬¬ 
var
¬¬ 
kvp
¬¬ 
in
¬¬ 

_deviceMap
¬¬  *
)
¬¬* +
{
√√ 
var
ƒƒ 
macId
ƒƒ 
=
ƒƒ 
kvp
ƒƒ 
.
ƒƒ  
Key
ƒƒ  #
;
ƒƒ# $
var
≈≈ 
state
≈≈ 
=
≈≈ 
kvp
≈≈ 
.
≈≈  
Value
≈≈  %
;
≈≈% &
state
∆∆ 
.
∆∆ 
LastUpdated
∆∆ !
=
∆∆" #
DateTime
∆∆$ ,
.
∆∆, -
UtcNow
∆∆- 3
;
∆∆3 4
state
«« 
.
«« 
Root
«« 
[
«« 
$str
«« (
]
««( )
=
««* +
state
««, 1
.
««1 2
LastUpdated
««2 =
;
««= >
var
…… 
device
…… 
=
…… 
await
…… "
	dbContext
……# ,
.
……, -
Devices
……- 4
.
……4 5!
FirstOrDefaultAsync
……5 H
(
……H I
d
……I J
=>
……K M
d
……N O
.
……O P
MacId
……P U
==
……V X
macId
……Y ^
)
……^ _
;
……_ `
if
   
(
   
device
   
!=
   
null
   "
)
  " #
{
ÀÀ 
device
ÕÕ 
.
ÕÕ 
DynamicProperties
ÕÕ ,
=
ÕÕ- .
state
ÕÕ/ 4
.
ÕÕ4 5
Root
ÕÕ5 9
[
ÕÕ9 :
$str
ÕÕ: M
]
ÕÕM N
!
ÕÕN O
.
ÕÕO P
ToJsonString
ÕÕP \
(
ÕÕ\ ]
)
ÕÕ] ^
;
ÕÕ^ _
device
ŒŒ 
.
ŒŒ 
Status
ŒŒ !
=
ŒŒ" #
state
ŒŒ$ )
.
ŒŒ) *
Root
ŒŒ* .
[
ŒŒ. /
$str
ŒŒ/ 7
]
ŒŒ7 8
?
ŒŒ8 9
.
ŒŒ9 :
ToString
ŒŒ: B
(
ŒŒB C
)
ŒŒC D
;
ŒŒD E
device
œœ 
.
œœ 
Connectivity
œœ '
=
œœ( )
state
œœ* /
.
œœ/ 0
Root
œœ0 4
[
œœ4 5
$str
œœ5 C
]
œœC D
?
œœD E
.
œœE F
ToString
œœF N
(
œœN O
)
œœO P
;
œœP Q
device
““ 
.
““ 
LastUpdated
““ &
=
““' (
state
““) .
.
““. /
LastUpdated
““/ :
;
““: ;
}
”” 
}
‘‘ 
await
’’ 
	dbContext
’’ 
.
’’ 
SaveChangesAsync
’’ ,
(
’’, -
)
’’- .
;
’’. /
}
÷÷ 	
private
ÿÿ 
async
ÿÿ 
Task
ÿÿ !
PersistToFilesAsync
ÿÿ .
(
ÿÿ. /
)
ÿÿ/ 0
{
ŸŸ 	
foreach
⁄⁄ 
(
⁄⁄ 
var
⁄⁄ 
kvp
⁄⁄ 
in
⁄⁄ 

_deviceMap
⁄⁄  *
)
⁄⁄* +
{
€€ 
var
‹‹ 
state
‹‹ 
=
‹‹ 
kvp
‹‹ 
.
‹‹  
Value
‹‹  %
;
‹‹% &
state
›› 
.
›› 
LastUpdated
›› !
=
››" #
DateTime
››$ ,
.
››, -
UtcNow
››- 3
;
››3 4
state
ﬁﬁ 
.
ﬁﬁ 
Root
ﬁﬁ 
[
ﬁﬁ 
$str
ﬁﬁ (
]
ﬁﬁ( )
=
ﬁﬁ* +
state
ﬁﬁ, 1
.
ﬁﬁ1 2
LastUpdated
ﬁﬁ2 =
;
ﬁﬁ= >
_fileMap
‡‡ 
.
‡‡ 
TryGetValue
‡‡ $
(
‡‡$ %
kvp
‡‡% (
.
‡‡( )
Key
‡‡) ,
,
‡‡, -
out
‡‡. 1
var
‡‡2 5
fileName
‡‡6 >
)
‡‡> ?
;
‡‡? @
var
·· 
path
·· 
=
·· 
Path
·· 
.
··  
Combine
··  '
(
··' (
_dataDirectory
··( 6
,
··6 7
fileName
··8 @
??
··@ B
$str
··B D
)
··D E
;
··E F
if
‚‚ 
(
‚‚ 
File
‚‚ 
.
‚‚ 
Exists
‚‚ 
(
‚‚  
path
‚‚  $
)
‚‚$ %
)
‚‚% &
{
„„ 
await
‰‰ 
File
‰‰ 
.
‰‰ 
WriteAllTextAsync
‰‰ 0
(
‰‰0 1
path
‰‰1 5
,
‰‰5 6
state
‰‰7 <
.
‰‰< =
Root
‰‰= A
.
‰‰A B
ToJsonString
‰‰B N
(
‰‰N O
new
‰‰O R#
JsonSerializerOptions
‰‰S h
{
ÂÂ 
WriteIndented
ÊÊ %
=
ÊÊ& '
true
ÊÊ( ,
}
ÁÁ 
)
ÁÁ 
)
ÁÁ 
;
ÁÁ 
}
ËË 
}
ÈÈ 
}
ÍÍ 	
}
ÎÎ 
}ÏÏ 