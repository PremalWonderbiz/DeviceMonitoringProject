‚
ÖC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\AlarmService\API\Middleware\ExceptionMiddleware.cs
	namespace 	
API
 
. 

Middleware 
{ 
public 

class 
ExceptionMiddleware $
{ 
private 
readonly 
RequestDelegate (
_next) .
;. /
public

 
ExceptionMiddleware

 "
(

" #
RequestDelegate

# 2
next

3 7
)

7 8
{ 	
_next 
= 
next 
; 
} 	
public 
async 
Task 
InvokeAsync %
(% &
HttpContext& 1
context2 9
)9 :
{ 	
try 
{ 
await 
_next 
( 
context #
)# $
;$ %
} 
catch 
( 
CustomException "
ex# %
)% &
{ 
await  
HandleExceptionAsync *
(* +
context+ 2
,2 3
ex4 6
,6 7
ex8 :
.: ;

StatusCode; E
)E F
;F G
} 
catch 
( 
	Exception 
ex 
)  
{ 
await  
HandleExceptionAsync *
(* +
context+ 2
,2 3
ex4 6
,6 7
$num8 ;
); <
;< =
} 
} 	
private 
async 
Task  
HandleExceptionAsync /
(/ 0
HttpContext0 ;
context< C
,C D
	ExceptionE N
exO Q
,Q R
intS V

statusCodeW a
)a b
{   	
context!! 
.!! 
Response!! 
.!! 

StatusCode!! '
=!!( )

statusCode!!* 4
;!!4 5
context"" 
."" 
Response"" 
."" 
ContentType"" (
="") *
$str""+ =
;""= >
string$$ 
json$$ 
=$$ 
JsonSerializer$$ (
.$$( )
	Serialize$$) 2
($$2 3
ex$$3 5
.$$5 6
Message$$6 =
)$$= >
;$$> ?
await%% 
context%% 
.%% 
Response%% "
.%%" #

WriteAsync%%# -
(%%- .
json%%. 2
)%%2 3
;%%3 4
}&& 	
}'' 
}(( ê%
nC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\AlarmService\API\Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. 
AddControllers 
(  
)  !
;! "
builder 
. 
Services 
. 
	AddScoped 
< 
IAlarmService (
,( )
AlarmService* 6
>6 7
(7 8
)8 9
;9 :
builder 
. 
Services 
. 
	AddScoped 
< #
IAlarmEvaluationService 2
,2 3"
AlarmEvaluationService4 J
>J K
(K L
)L M
;M N
builder 
. 
Services 
. 
	AddScoped 
< 
AlertService '
>' (
(( )
)) *
;* +
var 
dbPath 

= 
$str |
;| }
builder 
. 
Services 
. 
AddDbContext 
< 
AlarmDbContext ,
>, -
(- .
options. 5
=>6 8
options 
. 
	UseSqlite 
( 
$" 
$str $
{$ %
dbPath% +
}+ ,
", -
)- .
). /
;/ 0
builder 
. 
Services 
. 
AddCors 
( 
options  
=>! #
{ 
options   
.   
	AddPolicy   
(   
$str   "
,  " #
policy!! 
=>!! 
policy!! 
."" 
AllowAnyMethod"" 
("" 
)"" 
.## 
AllowAnyHeader## 
(## 
)## 
.$$ 
SetIsOriginAllowed$$ 
($$  
_$$  !
=>$$" $
true$$% )
)$$) *
.%% 
AllowCredentials%% 
(%% 
)%% 
)%%  
;%%  !
}&& 
)&& 
;&& 
builder)) 
.)) 
Services)) 
.)) #
AddEndpointsApiExplorer)) (
())( )
)))) *
;))* +
builder** 
.** 
Services** 
.** 
AddSwaggerGen** 
(** 
)**  
;**  !
builder++ 
.++ 
Services++ 
.++ 
AddHttpClient++ 
<++ 
AlertService++ +
>+++ ,
(++, -
)++- .
;++. /
var-- 
app-- 
=-- 	
builder--
 
.-- 
Build-- 
(-- 
)-- 
;-- 
if00 
(00 
app00 
.00 
Environment00 
.00 
IsDevelopment00 !
(00! "
)00" #
)00# $
{11 
app22 
.22 

UseSwagger22 
(22 
)22 
;22 
app33 
.33 
UseSwaggerUI33 
(33 
)33 
;33 
}44 
using66 
(66 
var66 

scope66 
=66 
app66 
.66 
Services66 
.66  
CreateScope66  +
(66+ ,
)66, -
)66- .
{77 
var88 
db88 

=88 
scope88 
.88 
ServiceProvider88 "
.88" #
GetRequiredService88# 5
<885 6
AlarmDbContext886 D
>88D E
(88E F
)88F G
;88G H
db99 
.99 
Database99 
.99 
Migrate99 
(99 
)99 
;99 
}:: 
app<< 
.<< 
UseMiddleware<< 
<<< 
ExceptionMiddleware<< %
><<% &
(<<& '
)<<' (
;<<( )
app>> 
.>> 
UseHttpsRedirection>> 
(>> 
)>> 
;>> 
app@@ 
.@@ 
UseAuthorization@@ 
(@@ 
)@@ 
;@@ 
appBB 
.BB 
MapControllersBB 
(BB 
)BB 
;BB 
appDD 
.DD 
UseCorsDD 
(DD 
$strDD 
)DD 
;DD 
appFF 
.FF 
RunFF 
(FF 
)FF 	
;FF	 
Ál
ÉC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\AlarmService\API\Controllers\AlarmsController.cs
	namespace 	
API
 
. 
Controllers 
{		 
[

 
Route

 

(


 
$str

 
)

 
]

 
[ 
ApiController 
] 
public 

class 
AlarmsController !
:" #
ControllerBase$ 2
{ 
private 
readonly 
IAlarmService &
_alarmService' 4
;4 5
private 
readonly #
IAlarmEvaluationService 0#
_alarmEvaluationService1 H
;H I
public 
AlarmsController 
(  
IAlarmService  -
alarmService. :
,: ;#
IAlarmEvaluationService; R"
alarmEvaluationServiceS i
)i j
{ 	
_alarmService 
= 
alarmService (
;( )#
_alarmEvaluationService #
=$ %"
alarmEvaluationService& <
;< =
} 	
[ 	
HttpPost	 
( 
$str 
) 
] 
public 
async 
Task 
< 
ActionResult &
<& '
IEnumerable' 2
<2 3
GetAlarmDto3 >
>> ?
>? @
>@ A
	GetAlarmsB K
(K L
AlarmFilterL W
filterX ^
)^ _
{ 	
var 
res 
= 
await 
_alarmService )
.) *
	GetAlarms* 3
(3 4
filter4 :
): ;
;; <
return 
Ok 
( 
res 
) 
; 
} 	
[   	
HttpGet  	 
(   
$str   "
)  " #
]  # $
public!! 
async!! 
Task!! 
<!! 
ActionResult!! &
<!!& '
GetLatestAlarmsDto!!' 9
>!!9 :
>!!: ;
GetLatestFiveAlarms!!< O
(!!O P
)!!P Q
{"" 	
var## 
res## 
=## 
await## 
_alarmService## )
.##) *
GetLatestFiveAlarms##* =
(##= >
)##> ?
;##? @
return$$ 
Ok$$ 
($$ 
res$$ 
)$$ 
;$$ 
}%% 	
[(( 	
HttpGet((	 
((( 
$str(( 8
)((8 9
]((9 :
public)) 
async)) 
Task)) 
<)) 
ActionResult)) &
<))& '&
GetLatestAlarmForDeviceDto))' A
>))A B
>))B C#
GetLatestAlarmForDevice))D [
())[ \
string))\ b
deviceMacId))c n
)))n o
{** 	
var++ 
res++ 
=++ 
await++ 
_alarmService++ )
.++) *#
GetLatestAlarmForDevice++* A
(++A B
deviceMacId++B M
)++M N
;++N O
return,, 
Ok,, 
(,, 
res,, 
),, 
;,, 
}-- 	
[11 	
HttpGet11	 
(11 
$str11 +
)11+ ,
]11, -
public22 
async22 
Task22 
<22 
ActionResult22 &
<22& '
IEnumerable22' 2
<222 3
GetAlarmDto223 >
>22> ?
>22? @
>22@ A
GetAlarmsByDeviceId22B U
(22U V
string22V \
id22] _
)22_ `
{33 	
var44 
res44 
=44 
await44 
_alarmService44 )
.44) *
GetAlarmsByDeviceId44* =
(44= >
id44> @
)44@ A
;44A B
return55 
Ok55 
(55 
res55 
)55 
;55 
}66 	
[99 	
HttpGet99	 
(99 
$str99 
)99 
]99 
public:: 
async:: 
Task:: 
<:: 
ActionResult:: &
<::& '
GetAlarmDto::' 2
>::2 3
>::3 4
GetAlarm::5 =
(::= >
Guid::> B
id::C E
)::E F
{;; 	
var<< 
alarm<< 
=<< 
await<< 
_alarmService<< +
.<<+ ,
GetAlarm<<, 4
(<<4 5
id<<5 7
)<<7 8
;<<8 9
return>> 
alarm>> 
;>> 
}?? 	
[CC 	
HttpPutCC	 
(CC 
$strCC 
)CC 
]CC 
publicDD 
asyncDD 
TaskDD 
<DD 
IActionResultDD '
>DD' (
PutAlarmDD) 1
(DD1 2
GuidDD2 6
idDD7 9
,DD9 :
AlarmDD; @
alarmDDA F
)DDF G
{EE 	
varFF 
resFF 
=FF 
awaitFF 
_alarmServiceFF )
.FF) *
PutAlarmFF* 2
(FF2 3
idFF3 5
,FF5 6
alarmFF7 <
)FF< =
;FF= >
returnHH 
OkHH 
(HH 
resHH 
)HH 
;HH 
}II 	
[KK 	
HttpPutKK	 
(KK 
$strKK -
)KK- .
]KK. /
publicLL 
asyncLL 
TaskLL 
<LL 
IActionResultLL '
>LL' (
InvestigateAlarmLL) 9
(LL9 :
GuidLL: >
alarmIdLL? F
)LLF G
{MM 	
varNN 
resNN 
=NN 
awaitNN 
_alarmServiceNN )
.NN) *
InvestigateAlarmNN* :
(NN: ;
alarmIdNN; B
)NNB C
;NNC D
returnPP 
OkPP 
(PP 
resPP 
)PP 
;PP 
}QQ 	
[SS 	
HttpPutSS	 
(SS 
$strSS 3
)SS3 4
]SS4 5
publicTT 
asyncTT 
TaskTT 
<TT 
IActionResultTT '
>TT' (
ResolveAlarmTT) 5
(TT5 6
GuidTT6 :
alarmIdTT; B
,TTB C
stringTTD J
commentTTK R
)TTR S
{UU 	
varVV 
resVV 
=VV 
awaitVV 
_alarmServiceVV )
.VV) *
ResolveAlarmVV* 6
(VV6 7
alarmIdVV7 >
,VV> ?
commentVV@ G
)VVG H
;VVH I
returnXX 
OkXX 
(XX 
resXX 
)XX 
;XX 
}YY 	
[]] 	
HttpPost]]	 
]]] 
public^^ 
async^^ 
Task^^ 
<^^ 
ActionResult^^ &
<^^& '
Alarm^^' ,
>^^, -
>^^- .
	PostAlarm^^/ 8
(^^8 9
PostAlarmDto^^9 E
alarm^^F K
)^^K L
{__ 	
var`` 
res`` 
=`` 
await`` 
_alarmService`` )
.``) *
	PostAlarm``* 3
(``3 4
alarm``4 9
)``9 :
;``: ;
returnbb 
CreatedAtActionbb "
(bb" #
$strbb# -
,bb- .
newbb/ 2
{bb3 4
idbb5 7
=bb8 9
resbb: =
.bb= >
Idbb> @
}bbA B
,bbB C
resbbD G
)bbG H
;bbH I
}cc 	
[oo 	
HttpPostoo	 
(oo 
$stroo 
)oo  
]oo  !
publicpp 
asyncpp 
Taskpp 
<pp 
IActionResultpp '
>pp' (
EvaluateToppp) 4
(pp4 5
[pp5 6
FromBodypp6 >
]pp> ?*
TopLevelAlarmEvaluationRequestpp@ ^
reqpp_ b
)ppb c
{qq 	
varrr 
previousrr 
=rr 
newrr !
TopLevelDeviceDataDtorr 4
{ss 
DeviceMacIdtt 
=tt 
reqtt !
.tt! "
Previoustt" *
.tt* +
DeviceMacIdtt+ 6
,tt6 7
Statusuu 
=uu 
requu 
.uu 
Previousuu %
.uu% &
Statusuu& ,
,uu, -
Connectivityvv 
=vv 
reqvv "
.vv" #
Previousvv# +
.vv+ ,
Connectivityvv, 8
}ww 
;ww 
varyy 
currentyy 
=yy 
newyy !
TopLevelDeviceDataDtoyy 3
{zz 
DeviceMacId{{ 
={{ 
req{{ !
.{{! "
Current{{" )
.{{) *
DeviceMacId{{* 5
,{{5 6
Status|| 
=|| 
req|| 
.|| 
Current|| $
.||$ %
Status||% +
,||+ ,
Connectivity}} 
=}} 
req}} "
.}}" #
Current}}# *
.}}* +
Connectivity}}+ 7
}~~ 
;~~ 
var
ÄÄ 
result
ÄÄ 
=
ÄÄ 
await
ÄÄ %
_alarmEvaluationService
ÄÄ 6
.
ÄÄ6 7#
EvaluateTopLevelAsync
ÄÄ7 L
(
ÄÄL M
current
ÄÄM T
,
ÄÄT U
previous
ÄÄV ^
)
ÄÄ^ _
;
ÄÄ_ `
return
ÅÅ 
Ok
ÅÅ 
(
ÅÅ 
result
ÅÅ 
)
ÅÅ 
;
ÅÅ 
}
ÇÇ 	
[
ÑÑ 	
HttpPost
ÑÑ	 
(
ÑÑ 
$str
ÑÑ #
)
ÑÑ# $
]
ÑÑ$ %
public
ÖÖ 
async
ÖÖ 
Task
ÖÖ 
<
ÖÖ 
IActionResult
ÖÖ '
>
ÖÖ' (
EvaluateDynamic
ÖÖ) 8
(
ÖÖ8 9
[
ÖÖ9 :
FromBody
ÖÖ: B
]
ÖÖB C+
DynamicAlarmEvaluationRequest
ÖÖD a
req
ÖÖb e
)
ÖÖe f
{
ÜÜ 	
var
áá 
previous
áá 
=
áá 
new
áá "
DynamicDeviceDataDto
áá 3
{
àà 
DeviceMacId
ââ 
=
ââ 
req
ââ !
.
ââ! "
Previous
ââ" *
.
ââ* +
DeviceMacId
ââ+ 6
,
ââ6 7
DynamicProperties
ää !
=
ää" #
req
ää$ '
.
ää' (
Previous
ää( 0
.
ää0 1
DynamicProperties
ää1 B
}
ãã 
;
ãã 
var
çç 
current
çç 
=
çç 
new
çç "
DynamicDeviceDataDto
çç 2
{
éé 
DeviceMacId
èè 
=
èè 
req
èè !
.
èè! "
Current
èè" )
.
èè) *
DeviceMacId
èè* 5
,
èè5 6
DynamicProperties
êê !
=
êê" #
req
êê$ '
.
êê' (
Current
êê( /
.
êê/ 0
DynamicProperties
êê0 A
}
ëë 
;
ëë 
var
ìì 
result
ìì 
=
ìì 
await
ìì %
_alarmEvaluationService
ìì 6
.
ìì6 7"
EvaluateDynamicAsync
ìì7 K
(
ììK L
current
ììL S
,
ììS T
previous
ììU ]
)
ìì] ^
;
ìì^ _
return
îî 
Ok
îî 
(
îî 
result
îî 
)
îî 
;
îî 
}
ïï 	
[
óó 	
HttpPost
óó	 
(
óó 
$str
óó /
)
óó/ 0
]
óó0 1
public
òò 
async
òò 
Task
òò 
<
òò 
IActionResult
òò '
>
òò' (
AddAlarmRules
òò) 6
(
òò6 7
string
òò7 =
deviceMacId
òò> I
,
òòI J
List
òòK O
<
òòO P
AlarmRuleDto
òòP \
>
òò\ ]

alarmRules
òò^ h
)
òòh i
{
ôô 	
var
öö 
result
öö 
=
öö 
await
öö 
_alarmService
öö ,
.
öö, - 
AddAlarmRulesAsync
öö- ?
(
öö? @
deviceMacId
öö@ K
,
ööK L

alarmRules
ööM W
)
ööW X
;
ööX Y
return
õõ 
Ok
õõ 
(
õõ 
result
õõ 
)
õõ 
;
õõ 
}
úú 	
[
üü 	

HttpDelete
üü	 
(
üü 
$str
üü 0
)
üü0 1
]
üü1 2
public
†† 
async
†† 
Task
†† 
<
†† 
IActionResult
†† '
>
††' (
IgnoreAlarm
††) 4
(
††4 5
Guid
††5 9
id
††: <
,
††< =
string
††> D
comment
††E L
)
††L M
{
°° 	
var
¢¢ 
res
¢¢ 
=
¢¢ 
await
¢¢ 
_alarmService
¢¢ )
.
¢¢) *
IgnoreAlarm
¢¢* 5
(
¢¢5 6
id
¢¢6 8
,
¢¢8 9
comment
¢¢: A
)
¢¢A B
;
¢¢B C
return
§§ 
Ok
§§ 
(
§§ 
res
§§ 
)
§§ 
;
§§ 
}
•• 	
[
©© 	
HttpGet
©©	 
(
©© 
$str
©© !
)
©©! "
]
©©" #
public
™™ 
async
™™ 
Task
™™ 
<
™™ 
ActionResult
™™ &
<
™™& '
IEnumerable
™™' 2
<
™™2 3
GetAlarmStatesDto
™™3 D
>
™™D E
>
™™E F
>
™™F G
GetAlarmStates
™™H V
(
™™V W
)
™™W X
{
´´ 	
var
¨¨ 
res
¨¨ 
=
¨¨ 
await
¨¨ 
_alarmService
¨¨ )
.
¨¨) *
GetAlarmStates
¨¨* 8
(
¨¨8 9
)
¨¨9 :
;
¨¨: ;
return
≠≠ 
Ok
≠≠ 
(
≠≠ 
res
≠≠ 
)
≠≠ 
;
≠≠ 
}
ÆÆ 	
}
ØØ 
}∞∞ 