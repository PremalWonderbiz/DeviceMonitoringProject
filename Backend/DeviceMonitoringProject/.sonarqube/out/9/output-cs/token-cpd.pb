Í
§C:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\DeviceStatePersistenceService .cs
	namespace 	
Infrastructure
 
. 
Services !
{ 
public 

class )
DeviceStatePersistenceService .
:/ 0
BackgroundService1 B
{ 
private 
readonly 
DeviceStateCache )
_deviceStateCache* ;
;; <
private 
readonly 
ILogger  
<  !)
DeviceStatePersistenceService! >
>> ?
_logger@ G
;G H
private 
readonly 
string 
_dataDirectory  .
;. /
private 
readonly 
TimeSpan !
	_interval" +
=, -
TimeSpan. 6
.6 7
FromSeconds7 B
(B C
$numC F
)F G
;G H
public )
DeviceStatePersistenceService ,
(, -
DeviceStateCache 
deviceStateCache -
,- .
ILogger 
< )
DeviceStatePersistenceService 1
>1 2
logger3 9
,9 :
IOptions 
<  
DeviceServiceOptions )
>) *
options+ 2
)2 3
{ 	
_deviceStateCache 
= 
deviceStateCache  0
;0 1
_logger 
= 
logger 
; 
_dataDirectory 
= 
options $
.$ %
Value% *
.* +
DataDirectory+ 8
;8 9
} 	
	protected 
override 
async  
Task! %
ExecuteAsync& 2
(2 3
CancellationToken3 D
stoppingTokenE R
)R S
{ 	
_logger   
.   
LogInformation   "
(  " #
$str  # N
)  N O
;  O P
while"" 
("" 
!"" 
stoppingToken"" !
.""! "#
IsCancellationRequested""" 9
)""9 :
{## 
await$$ 
_deviceStateCache$$ '
.$$' (
PersistToDiskAsync$$( :
($$: ;
)$$; <
;$$< =
await%% 
Task%% 
.%% 
Delay%%  
(%%  !
	_interval%%! *
,%%* +
stoppingToken%%, 9
)%%9 :
;%%: ;
}&& 
}'' 	
public)) 
override)) 
async)) 
Task)) "
	StopAsync))# ,
()), -
CancellationToken))- >
cancellationToken))? P
)))P Q
{** 	
_logger++ 
.++ 
LogInformation++ "
(++" #
$str++# i
)++i j
;++j k
await,, 
_deviceStateCache,, #
.,,# $
PersistToDiskAsync,,$ 6
(,,6 7
),,7 8
;,,8 9
_logger-- 
.-- 
LogInformation-- "
(--" #
$str--# :
)--: ;
;--; <
await.. 
base.. 
... 
	StopAsync..  
(..  !
cancellationToken..! 2
)..2 3
;..3 4
}// 	
}00 
}11 ¢œ
ìC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\DeviceService.cs
	namespace 	
Infrastructure
 
. 
Services !
;! "
public 
class 
DeviceService 
: 
IDeviceService +
{ 
private 
readonly 
ILogger 
< 
DeviceService *
>* +
_logger, 3
;3 4
private 
readonly 
IDynamicDataHelper '
_dynamicDataHelper( :
;: ;
private 
readonly  
IDeviceServiceHelper ) 
_deviceServiceHelper* >
;> ?
private 
readonly #
IAlarmEvaluationService ,#
_alarmEvaluationService- D
;D E
private 
readonly 
DeviceStateCache %
_deviceStateCache& 7
;7 8
private 
readonly 
Random 
_random #
=$ %
new& )
() *
)* +
;+ ,
private 
readonly 
IAlarmToggleService (
_alarmToggleService) <
;< =
private 
readonly 
bool 
_useDatabase &
;& '
private 
readonly 
DeviceDbContext $

_dbContext% /
;/ 0
private 
static 
readonly 
List  
<  !
Func! %
<% &
DeviceMetadata& 4
,4 5
string6 <
>< =
>= >
_searchSequence? N
=O P
newQ T
(T U
)U V
{   
d!! 	
=>!!
 
d!! 
.!! 
Name!! 
,!! 
d"" 	
=>""
 
d"" 
."" 
Type"" 
,"" 
d## 	
=>##
 
d## 
.## 
Status## 
,## 
d$$ 	
=>$$
 
d$$ 
.$$ 
MacId$$ 
,$$ 
d%% 	
=>%%
 
d%% 
.%% 
Connectivity%% 
,%% 
d&& 	
=>&&
 
d&& 
.&& 
FileName&& 
}'' 
;'' 
private** 
static** 
readonly** 

Dictionary** &
<**& '
string**' -
,**- .
int**/ 2
>**2 3
connectivityOrder**4 E
=**F G
new**H K
(**K L
)**L M
{++ 
{,, 	
$str,,
 
,,, 
$num,, 
},, 
,,, 
{-- 	
$str--
 
,-- 
$num-- 
}-- 
,-- 
{.. 	
$str..
 
,.. 
$num.. 
}.. 
}// 
;// 
private11 
List11 
<11 
DeviceMetadata11 
>11  
_devices11! )
=>11* ,
_deviceStateCache22 
.22 
GetAllStates22 &
(22& '
)22' (
.33 
Select33 
(33 
state33 
=>33 
{44 
var55 
root55 
=55 
state55  
.55  !
Value55! &
.55& '
Root55' +
;55+ ,
var66 
lastUpdated66 
=66  !
state66" '
.66' (
Value66( -
.66- .
LastUpdated66. 9
;669 :
return77 
new77 
DeviceMetadata77 )
{88 
Name99 
=99 
root99 
[99  
$str99  &
]99& '
?99' (
.99( )
GetValue99) 1
<991 2
string992 8
>998 9
(999 :
)99: ;
??99< >
$str99? H
,99H I
Type:: 
=:: 
root:: 
[::  
$str::  &
]::& '
?::' (
.::( )
GetValue::) 1
<::1 2
string::2 8
>::8 9
(::9 :
)::: ;
??::< >
$str::? H
,::H I
Status;; 
=;; 
root;; !
[;;! "
$str;;" *
];;* +
?;;+ ,
.;;, -
GetValue;;- 5
<;;5 6
string;;6 <
>;;< =
(;;= >
);;> ?
??;;@ B
$str;;C L
,;;L M
MacId<< 
=<< 
state<< !
.<<! "
Key<<" %
,<<% &
Connectivity==  
===! "
root==# '
[==' (
$str==( 6
]==6 7
?==7 8
.==8 9
GetValue==9 A
<==A B
string==B H
>==H I
(==I J
)==J K
??==L N
$str==O X
,==X Y
FileName>> 
=>> 
root>> #
[>># $
$str>>$ .
]>>. /
?>>/ 0
.>>0 1
GetValue>>1 9
<>>9 :
string>>: @
>>>@ A
(>>A B
)>>B C
??>>D F
$str>>G I
,>>I J
LastUpdated?? 
=??  !
lastUpdated??" -
}@@ 
;@@ 
}AA 
)AA 
.BB 
ToListBB 
(BB 
)BB 
;BB 
privateEE 
readonlyEE 
stringEE 
_dataDirectoryEE *
=EE+ ,
PathEE- 1
.EE1 2
CombineEE2 9
(EE9 :
	DirectoryEE: C
.EEC D
	GetParentEED M
(EEM N
	DirectoryEEN W
.EEW X
GetCurrentDirectoryEEX k
(EEk l
)EEl m
)EEm n
!EEn o
.EEo p
FullNameEEp x
,EEx y
$str	EEz ä
,
EEä ã
$str
EEå í
)
EEí ì
;
EEì î
publicJJ 

DeviceServiceJJ 
(JJ  
IDeviceServiceHelperKK 
deviceServiceHelperKK 0
,KK0 1
ILoggerLL 
<LL 
DeviceServiceLL 
>LL 
loggerLL %
,LL% &
IDynamicDataHelperMM 
dynamicDataHelperMM ,
,MM, -#
IAlarmEvaluationServiceNN "
alarmEvaluationServiceNN  6
,NN6 7
DeviceStateCacheOO 
deviceStateCacheOO )
,OO) *
IAlarmToggleServicePP 
alarmToggleServicePP .
,PP. /
IOptionsQQ 
<QQ  
DeviceStorageOptionsQQ %
>QQ% &
optionsQQ' .
,QQ. /
DeviceDbContextRR 
	dbContextRR !
)RR! "
{SS 
_loggerTT 
=TT 
loggerTT 
;TT 
_dynamicDataHelperUU 
=UU 
dynamicDataHelperUU .
;UU. /#
_alarmEvaluationServiceVV 
=VV  !"
alarmEvaluationServiceVV" 8
;VV8 9 
_deviceServiceHelperWW 
=WW 
deviceServiceHelperWW 2
;WW2 3
_deviceStateCacheXX 
=XX 
deviceStateCacheXX ,
;XX, -
_alarmToggleServiceYY 
=YY 
alarmToggleServiceYY 0
;YY0 1
_useDatabaseZZ 
=ZZ 
optionsZZ 
.ZZ 
ValueZZ $
.ZZ$ %
UseDatabaseZZ% 0
;ZZ0 1

_dbContext[[ 
=[[ 
	dbContext[[ 
;[[ 
}\\ 
public^^ 

async^^ 
Task^^ 
<^^ 
bool^^ 
>^^ 1
%GenerateAndSendLiveUpdatesDevicesData^^ A
(^^A B
)^^B C
{__ 
throw`` 
new`` #
NotImplementedException`` )
(``) *
)``* +
;``+ ,
}aa 
publiccc 

Listcc 
<cc 
DeviceMetadatacc 
>cc )
GetAllDeviceMetadataPaginatedcc  =
(cc= >
Listcc> B
<ccB C
DeviceMetadataccC Q
>ccQ R
dataccS W
,ccW X
intccY \

pageNumbercc] g
=cch i
$numccj k
,cck l
intccm p
pageSizeccq y
=ccz {
$numcc| ~
)cc~ 
{dd 
returnee 
dataee 
.ee 
Skipee 
(ee 
(ee 

pageNumberee $
-ee% &
$numee' (
)ee( )
*ee* +
pageSizeee, 4
)ee4 5
.ee5 6
Takeee6 :
(ee: ;
pageSizeee; C
)eeC D
.eeD E
ToListeeE K
(eeK L
)eeL M
;eeM N
}ff 
publichh 
/
#DeviceMetadataPaginatedandSortedDtohh .2
&GetAllDeviceMetadataPaginatedandSortedhh/ U
(hhU V%
DeviceTopLevelSortOptionshhV o
sortRequesthhp {
,hh{ |
List	hh} Å
<
hhÅ Ç
DeviceMetadata
hhÇ ê
>
hhê ë
filteredData
hhí û
=
hhü †
null
hh° •
)
hh• ¶
{ii 
varjj 
metaDatajj 
=jj 
filteredDatajj #
isjj$ &
notjj' *
nulljj+ /
?kk 
filteredDatakk 
.kk 
AsQueryablekk 
(kk 
)kk  
:ll 
_devicesll 
.ll 
AsQueryablell 
(ll 
)ll 
;ll 
IOrderedQueryablenn 
<nn 
DeviceMetadatann (
>nn( )
orderednn* 1
;nn1 2
ifpp 

(pp 
sortRequestpp 
.pp 
Sortingpp 
==pp  "
nullpp# '
||pp( *
!pp+ ,
sortRequestpp, 7
.pp7 8
Sortingpp8 ?
.pp? @
Anypp@ C
(ppC D
)ppD E
)ppE F
{qq 	
orderedrr 
=rr 
metaDatarr 
.rr 
OrderByDescendingrr 0
(rr0 1
drr1 2
=>rr3 5
drr6 7
.rr7 8
LastUpdatedrr8 C
)rrC D
;rrD E
}ss 	
elsett 
{uu 	
IOrderedQueryablevv 
<vv 
DeviceMetadatavv ,
>vv, -
?vv- .
tempvv/ 3
=vv4 5
nullvv6 :
;vv: ;
foreachxx 
(xx 
varxx 
sortxx 
inxx  
sortRequestxx! ,
.xx, -
Sortingxx- 4
)xx4 5
{yy 
stringzz 
idzz 
=zz 
sortzz  
.zz  !
Idzz! #
;zz# $
bool{{ 
desc{{ 
={{ 
sort{{  
.{{  !
Desc{{! %
;{{% &
temp}} 
=}} 
temp}} 
==}} 
null}} #
?~~ 
SortInitial~~ !
(~~! "
metaData~~" *
,~~* +
id~~, .
,~~. /
desc~~0 4
)~~4 5
: 
SortThen 
( 
temp #
,# $
id% '
,' (
desc) -
)- .
;. /
}
ÄÄ 
ordered
ÇÇ 
=
ÇÇ 
temp
ÇÇ 
!
ÇÇ 
;
ÇÇ 
}
ÉÉ 	
var
ÖÖ 
metadataPaginated
ÖÖ 
=
ÖÖ +
GetAllDeviceMetadataPaginated
ÖÖ  =
(
ÖÖ= >
ordered
ÜÜ 
.
ÜÜ 
ToList
ÜÜ 
(
ÜÜ 
)
ÜÜ 
,
ÜÜ 
sortRequest
áá 
.
áá 

PageNumber
áá "
,
áá" #
sortRequest
àà 
.
àà 
PageSize
àà  
)
ââ 	
;
ââ	 

return
ãã 
new
ãã 1
#DeviceMetadataPaginatedandSortedDto
ãã 6
(
ãã6 7
)
ãã7 8
{
åå 	

TotalCount
çç 
=
çç 
metaData
çç !
.
çç! "
Count
çç" '
(
çç' (
)
çç( )
,
çç) *
DeviceMetadata
éé 
=
éé 
metadataPaginated
éé .
}
èè 	
;
èè	 

}
ëë 
private
ìì 
IOrderedQueryable
ìì 
<
ìì 
DeviceMetadata
ìì ,
>
ìì, -
SortInitial
ìì. 9
(
ìì9 :

IQueryable
ìì: D
<
ììD E
DeviceMetadata
ììE S
>
ììS T
data
ììU Y
,
ììY Z
string
ìì[ a
id
ììb d
,
ììd e
bool
ììf j
desc
ììk o
)
ììo p
{
îî 
return
ïï 
id
ïï 
switch
ïï 
{
ññ 	
$str
óó 
=>
óó 
desc
óó 
?
óó 
data
óó !
.
óó! "
OrderByDescending
óó" 3
(
óó3 4
u
óó4 5
=>
óó6 8
u
óó9 :
.
óó: ;
Name
óó; ?
)
óó? @
:
óóA B
data
óóC G
.
óóG H
OrderBy
óóH O
(
óóO P
u
óóP Q
=>
óóR T
u
óóU V
.
óóV W
Name
óóW [
)
óó[ \
,
óó\ ]
$str
òò 
=>
òò 
desc
òò 
?
òò 
data
òò !
.
òò! "
OrderByDescending
òò" 3
(
òò3 4
u
òò4 5
=>
òò6 8
u
òò9 :
.
òò: ;
Type
òò; ?
)
òò? @
:
òòA B
data
òòC G
.
òòG H
OrderBy
òòH O
(
òòO P
u
òòP Q
=>
òòR T
u
òòU V
.
òòV W
Type
òòW [
)
òò[ \
,
òò\ ]
$str
ôô 
=>
ôô 
desc
ôô 
?
ôô 
data
ôô #
.
ôô# $
OrderByDescending
ôô$ 5
(
ôô5 6
u
ôô6 7
=>
ôô8 :
u
ôô; <
.
ôô< =
Status
ôô= C
)
ôôC D
:
ôôE F
data
ôôG K
.
ôôK L
OrderBy
ôôL S
(
ôôS T
u
ôôT U
=>
ôôV X
u
ôôY Z
.
ôôZ [
Status
ôô[ a
)
ôôa b
,
ôôb c
$str
öö 
=>
öö 
desc
öö 
?
öö 
data
öö "
.
öö" #
OrderByDescending
öö# 4
(
öö4 5
u
öö5 6
=>
öö7 9
u
öö: ;
.
öö; <
MacId
öö< A
)
ööA B
:
ööC D
data
ööE I
.
ööI J
OrderBy
ööJ Q
(
ööQ R
u
ööR S
=>
ööT V
u
ööW X
.
ööX Y
MacId
ööY ^
)
öö^ _
,
öö_ `
$str
õõ 
=>
õõ 
desc
õõ "
?
õõ# $
data
õõ% )
.
õõ) *
OrderByDescending
õõ* ;
(
õõ; <
u
õõ< =
=>
õõ> @
connectivityOrder
õõA R
.
õõR S
ContainsKey
õõS ^
(
õõ^ _
u
õõ_ `
.
õõ` a
Connectivity
õõa m
)
õõm n
?
õõo p 
connectivityOrderõõq Ç
[õõÇ É
uõõÉ Ñ
.õõÑ Ö
ConnectivityõõÖ ë
]õõë í
:õõì î
intõõï ò
.õõò ô
MaxValueõõô °
)õõ° ¢
:
úú$ %
data
úú& *
.
úú* +
OrderBy
úú+ 2
(
úú2 3
u
úú3 4
=>
úú5 7
connectivityOrder
úú8 I
.
úúI J
ContainsKey
úúJ U
(
úúU V
u
úúV W
.
úúW X
Connectivity
úúX d
)
úúd e
?
úúf g
connectivityOrder
úúh y
[
úúy z
u
úúz {
.
úú{ |
Connectivityúú| à
]úúà â
:úúä ã
intúúå è
.úúè ê
MaxValueúúê ò
)úúò ô
,úúô ö
$str
ùù 
=>
ùù 
desc
ùù !
?
ùù" #
data
ùù$ (
.
ùù( )
OrderByDescending
ùù) :
(
ùù: ;
u
ùù; <
=>
ùù= ?
u
ùù@ A
.
ùùA B
LastUpdated
ùùB M
)
ùùM N
:
ùùO P
data
ùùQ U
.
ùùU V
OrderBy
ùùV ]
(
ùù] ^
u
ùù^ _
=>
ùù` b
u
ùùc d
.
ùùd e
LastUpdated
ùùe p
)
ùùp q
,
ùùq r
_
ûû 
=>
ûû 
data
ûû 
.
ûû 
OrderBy
ûû 
(
ûû 
u
ûû 
=>
ûû  "
u
ûû# $
.
ûû$ %
Name
ûû% )
)
ûû) *
}
üü 	
;
üü	 

}
†† 
private
¢¢ 
IOrderedQueryable
¢¢ 
<
¢¢ 
DeviceMetadata
¢¢ ,
>
¢¢, -
SortThen
¢¢. 6
(
¢¢6 7
IOrderedQueryable
¢¢7 H
<
¢¢H I
DeviceMetadata
¢¢I W
>
¢¢W X
data
¢¢Y ]
,
¢¢] ^
string
¢¢_ e
id
¢¢f h
,
¢¢h i
bool
¢¢j n
desc
¢¢o s
)
¢¢s t
{
££ 
return
§§ 
id
§§ 
switch
§§ 
{
•• 	
$str
¶¶ 
=>
¶¶ 
desc
¶¶ 
?
¶¶ 
data
¶¶ !
.
¶¶! "
ThenByDescending
¶¶" 2
(
¶¶2 3
u
¶¶3 4
=>
¶¶5 7
u
¶¶8 9
.
¶¶9 :
Name
¶¶: >
)
¶¶> ?
:
¶¶@ A
data
¶¶B F
.
¶¶F G
ThenBy
¶¶G M
(
¶¶M N
u
¶¶N O
=>
¶¶P R
u
¶¶S T
.
¶¶T U
Name
¶¶U Y
)
¶¶Y Z
,
¶¶Z [
$str
ßß 
=>
ßß 
desc
ßß 
?
ßß 
data
ßß !
.
ßß! "
ThenByDescending
ßß" 2
(
ßß2 3
u
ßß3 4
=>
ßß5 7
u
ßß8 9
.
ßß9 :
Type
ßß: >
)
ßß> ?
:
ßß@ A
data
ßßB F
.
ßßF G
ThenBy
ßßG M
(
ßßM N
u
ßßN O
=>
ßßP R
u
ßßS T
.
ßßT U
Type
ßßU Y
)
ßßY Z
,
ßßZ [
$str
®® 
=>
®® 
desc
®® 
?
®® 
data
®® #
.
®®# $
ThenByDescending
®®$ 4
(
®®4 5
u
®®5 6
=>
®®7 9
u
®®: ;
.
®®; <
Status
®®< B
)
®®B C
:
®®D E
data
®®F J
.
®®J K
ThenBy
®®K Q
(
®®Q R
u
®®R S
=>
®®T V
u
®®W X
.
®®X Y
Status
®®Y _
)
®®_ `
,
®®` a
$str
©© 
=>
©© 
desc
©© 
?
©© 
data
©© "
.
©©" #
ThenByDescending
©©# 3
(
©©3 4
u
©©4 5
=>
©©6 8
u
©©9 :
.
©©: ;
MacId
©©; @
)
©©@ A
:
©©B C
data
©©D H
.
©©H I
ThenBy
©©I O
(
©©O P
u
©©P Q
=>
©©R T
u
©©U V
.
©©V W
MacId
©©W \
)
©©\ ]
,
©©] ^
$str
™™ 
=>
™™ 
desc
™™ "
?
™™# $
data
™™% )
.
™™) *
ThenByDescending
™™* :
(
™™: ;
u
™™; <
=>
™™= ?
connectivityOrder
™™@ Q
.
™™Q R
ContainsKey
™™R ]
(
™™] ^
u
™™^ _
.
™™_ `
Connectivity
™™` l
)
™™l m
?
™™n o 
connectivityOrder™™p Å
[™™Å Ç
u™™Ç É
.™™É Ñ
Connectivity™™Ñ ê
]™™ê ë
:™™í ì
int™™î ó
.™™ó ò
MaxValue™™ò †
)™™† °
:
´´$ %
data
´´& *
.
´´* +
ThenBy
´´+ 1
(
´´1 2
u
´´2 3
=>
´´4 6
connectivityOrder
´´7 H
.
´´H I
ContainsKey
´´I T
(
´´T U
u
´´U V
.
´´V W
Connectivity
´´W c
)
´´c d
?
´´e f
connectivityOrder
´´g x
[
´´x y
u
´´y z
.
´´z {
Connectivity´´{ á
]´´á à
:´´â ä
int´´ã é
.´´é è
MaxValue´´è ó
)´´ó ò
,´´ò ô
$str
¨¨ 
=>
¨¨ 
desc
¨¨ !
?
¨¨" #
data
¨¨$ (
.
¨¨( )
OrderByDescending
¨¨) :
(
¨¨: ;
u
¨¨; <
=>
¨¨= ?
u
¨¨@ A
.
¨¨A B
LastUpdated
¨¨B M
)
¨¨M N
:
¨¨O P
data
¨¨Q U
.
¨¨U V
OrderBy
¨¨V ]
(
¨¨] ^
u
¨¨^ _
=>
¨¨` b
u
¨¨c d
.
¨¨d e
LastUpdated
¨¨e p
)
¨¨p q
,
¨¨q r
_
≠≠ 
=>
≠≠ 
data
≠≠ 
.
≠≠ 
ThenBy
≠≠ 
(
≠≠ 
u
≠≠ 
=>
≠≠ !
u
≠≠" #
.
≠≠# $
Name
≠≠$ (
)
≠≠( )
}
ÆÆ 	
;
ÆÆ	 

}
ØØ 
public
±± 
1
#DeviceMetadataPaginatedandSortedDto
±± .0
"GetSearchedDeviceMetadataPaginated
±±/ Q
(
±±Q R'
DeviceTopLevelSortOptions
±±R k
options
±±l s
,
±±s t
string
±±u {
input±±| Å
=±±Ç É
$str±±Ñ Ü
)±±Ü á
{
≤≤ 
var
≥≥ 
filteredList
≥≥ 
=
≥≥ 
string
≥≥ !
.
≥≥! " 
IsNullOrWhiteSpace
≥≥" 4
(
≥≥4 5
input
≥≥5 :
)
≥≥: ;
?
¥¥ 	
_devices
¥¥
 
:
µµ 	
_devices
µµ
 
.
µµ 
Where
µµ 
(
µµ 
d
µµ 
=>
µµ 
MatchesSearch
µµ +
(
µµ+ ,
d
µµ, -
,
µµ- .
input
µµ/ 4
)
µµ4 5
)
µµ5 6
.
µµ6 7
ToList
µµ7 =
(
µµ= >
)
µµ> ?
;
µµ? @
if
∑∑ 

(
∑∑ 
filteredList
∑∑ 
.
∑∑ 
Count
∑∑ 
<=
∑∑ !
$num
∑∑" #
)
∑∑# $
{
∏∏ 	
return
ππ 
new
ππ 1
#DeviceMetadataPaginatedandSortedDto
ππ :
{
∫∫ 

TotalCount
ªª 
=
ªª 
filteredList
ªª )
.
ªª) *
Count
ªª* /
,
ªª/ 0
DeviceMetadata
ºº 
=
ºº  
filteredList
ºº! -
}
ΩΩ 
;
ΩΩ 
}
ææ 	
return
¿¿ 4
&GetAllDeviceMetadataPaginatedandSorted
¿¿ 5
(
¿¿5 6
options
¿¿6 =
,
¿¿= >
filteredList
¿¿? K
)
¿¿K L
;
¿¿L M
}
¡¡ 
private
√√ 
bool
√√ 
MatchesSearch
√√ 
(
√√ 
DeviceMetadata
√√ -
device
√√. 4
,
√√4 5
string
√√6 <
input
√√= B
)
√√B C
{
ƒƒ 
input
≈≈ 
=
≈≈ 
input
≈≈ 
.
≈≈ 
ToLowerInvariant
≈≈ &
(
≈≈& '
)
≈≈' (
;
≈≈( )
foreach
«« 
(
«« 
var
«« 
selector
«« 
in
««  
_searchSequence
««! 0
)
««0 1
{
»» 	
var
…… 
value
…… 
=
…… 
selector
……  
(
……  !
device
……! '
)
……' (
;
……( )
if
   
(
   
!
   
string
   
.
    
IsNullOrWhiteSpace
   *
(
  * +
value
  + 0
)
  0 1
&&
  2 4
value
ÀÀ 
.
ÀÀ 
ToLowerInvariant
ÀÀ &
(
ÀÀ& '
)
ÀÀ' (
.
ÀÀ( )
Contains
ÀÀ) 1
(
ÀÀ1 2
input
ÀÀ2 7
)
ÀÀ7 8
)
ÀÀ8 9
{
ÃÃ 
return
ÕÕ 
true
ÕÕ 
;
ÕÕ 
}
ŒŒ 
}
œœ 	
return
—— 
false
—— 
;
—— 
}
““ 
public
’’ 


Dictionary
’’ 
<
’’ 
string
’’ 
,
’’ 
string
’’ $
>
’’$ %#
GetMacIdToFileNameMap
’’& ;
(
’’; <
)
’’< =
{
÷÷ 
return
◊◊ 
_devices
◊◊ 
.
◊◊ 
ToDictionary
◊◊ $
(
◊◊$ %
d
◊◊% &
=>
◊◊' )
d
◊◊* +
.
◊◊+ ,
MacId
◊◊, 1
,
◊◊1 2
d
◊◊3 4
=>
◊◊5 7
d
◊◊8 9
.
◊◊9 :
FileName
◊◊: B
,
◊◊B C
StringComparer
◊◊D R
.
◊◊R S
OrdinalIgnoreCase
◊◊S d
)
◊◊d e
;
◊◊e f
}
ÿÿ 
public
⁄⁄ 

async
⁄⁄ 
Task
⁄⁄ 
<
⁄⁄ 
DeviceDetails
⁄⁄ #
>
⁄⁄# $+
GetPropertyPanelDataForDevice
⁄⁄% B
(
⁄⁄B C
string
⁄⁄C I
deviceId
⁄⁄J R
)
⁄⁄R S
{
€€ 
var
›› 
state
›› 
=
›› 
_deviceStateCache
›› %
.
››% &
GetAllStates
››& 2
(
››2 3
)
››3 4
.
››4 5
TryGetValue
››5 @
(
››@ A
deviceId
››A I
,
››I J
out
››K N
var
››O R
deviceState
››S ^
)
››^ _
?
››` a
deviceState
››b m
:
››n o
null
››p t
;
››t u
if
ﬂﬂ 

(
ﬂﬂ 
state
ﬂﬂ 
?
ﬂﬂ 
.
ﬂﬂ 
Root
ﬂﬂ 
==
ﬂﬂ 
null
ﬂﬂ 
)
ﬂﬂ  
{
‡‡ 	
_logger
·· 
.
·· 
LogError
·· 
(
·· 
$str
·· R
,
··R S
deviceId
··T \
)
··\ ]
;
··] ^
throw
‚‚ 
new
‚‚ 
	Exception
‚‚ 
(
‚‚  
$str
‚‚  C
)
‚‚C D
;
‚‚D E
}
„„ 	
try
ÂÂ 
{
ÊÊ 	
var
ÁÁ 
json
ÁÁ 
=
ÁÁ 
state
ÁÁ 
.
ÁÁ 
Root
ÁÁ !
.
ÁÁ! "
ToJsonString
ÁÁ" .
(
ÁÁ. /
)
ÁÁ/ 0
;
ÁÁ0 1
return
ËË 
JsonSerializer
ËË !
.
ËË! "
Deserialize
ËË" -
<
ËË- .
DeviceDetails
ËË. ;
>
ËË; <
(
ËË< =
json
ËË= A
,
ËËA B
new
ËËC F#
JsonSerializerOptions
ËËG \
{
ÈÈ )
PropertyNameCaseInsensitive
ÍÍ +
=
ÍÍ, -
true
ÍÍ. 2
}
ÎÎ 
)
ÎÎ 
!
ÎÎ 
;
ÎÎ 
}
ÏÏ 	
catch
ÌÌ 
(
ÌÌ 
	Exception
ÌÌ 
ex
ÌÌ 
)
ÌÌ 
{
ÓÓ 	
_logger
ÔÔ 
.
ÔÔ 
LogError
ÔÔ 
(
ÔÔ 
ex
ÔÔ 
,
ÔÔ  
$str
ÔÔ! R
,
ÔÔR S
deviceId
ÔÔT \
)
ÔÔ\ ]
;
ÔÔ] ^
throw
 
new
 
	Exception
 
(
  
$str
  @
)
@ A
;
A B
}
ÒÒ 	
}
ÚÚ 
public
ÙÙ 

async
ÙÙ 
Task
ÙÙ 
<
ÙÙ 
bool
ÙÙ 
>
ÙÙ 0
"SimulateTopLevelChangeForOneDevice
ÙÙ >
(
ÙÙ> ?
)
ÙÙ? @
{
ıı 
var
ˆˆ 
device
ˆˆ 
=
ˆˆ 
_devices
ˆˆ 
[
ˆˆ 
_random
ˆˆ %
.
ˆˆ% &
Next
ˆˆ& *
(
ˆˆ* +
_devices
ˆˆ+ 3
.
ˆˆ3 4
Count
ˆˆ4 9
)
ˆˆ9 :
]
ˆˆ: ;
;
ˆˆ; <
var
¯¯ 
rootSnapshot
¯¯ 
=
¯¯ 
_deviceStateCache
¯¯ ,
.
¯¯, -
GetDeviceState
¯¯- ;
(
¯¯; <
device
¯¯< B
.
¯¯B C
MacId
¯¯C H
)
¯¯H I
;
¯¯I J
if
˘˘ 

(
˘˘ 
rootSnapshot
˘˘ 
==
˘˘ 
null
˘˘  
)
˘˘  !
return
˘˘" (
false
˘˘) .
;
˘˘. /
var
˚˚ 
previousTop
˚˚ 
=
˚˚ "
_deviceServiceHelper
˚˚ .
.
˚˚. / 
ExtractTopLevelDto
˚˚/ A
(
˚˚A B
device
˚˚B H
.
˚˚H I
MacId
˚˚I N
,
˚˚N O
rootSnapshot
˚˚P \
.
˚˚\ ]
	DeepClone
˚˚] f
(
˚˚f g
)
˚˚g h
)
˚˚h i
;
˚˚i j
bool
˝˝ 

wasUpdated
˝˝ 
=
˝˝ 
false
˝˝ 
;
˝˝  
await
ˇˇ 
_deviceStateCache
ˇˇ 
.
ˇˇ  
WithLock
ˇˇ  (
(
ˇˇ( )
device
ˇˇ) /
.
ˇˇ/ 0
MacId
ˇˇ0 5
,
ˇˇ5 6
async
ˇˇ7 <
(
ˇˇ= >
rootNode
ˇˇ> F
)
ˇˇF G
=>
ˇˇH J
{
ÄÄ 	
string
ÅÅ 
?
ÅÅ 
previousStatus
ÅÅ "
=
ÅÅ# $
rootNode
ÅÅ% -
[
ÅÅ- .
$str
ÅÅ. 6
]
ÅÅ6 7
?
ÅÅ7 8
.
ÅÅ8 9
GetValue
ÅÅ9 A
<
ÅÅA B
string
ÅÅB H
>
ÅÅH I
(
ÅÅI J
)
ÅÅJ K
;
ÅÅK L
string
ÇÇ 
?
ÇÇ "
previousConnectivity
ÇÇ (
=
ÇÇ) *
rootNode
ÇÇ+ 3
[
ÇÇ3 4
$str
ÇÇ4 B
]
ÇÇB C
?
ÇÇC D
.
ÇÇD E
GetValue
ÇÇE M
<
ÇÇM N
string
ÇÇN T
>
ÇÇT U
(
ÇÇU V
)
ÇÇV W
;
ÇÇW X
var
ÑÑ 
	newStatus
ÑÑ 
=
ÑÑ  
_dynamicDataHelper
ÑÑ .
.
ÑÑ. /
GetRandomStatus
ÑÑ/ >
(
ÑÑ> ?
)
ÑÑ? @
;
ÑÑ@ A
var
ÖÖ 
newConnectivity
ÖÖ 
=
ÖÖ  ! 
_dynamicDataHelper
ÖÖ" 4
.
ÖÖ4 5#
GetRandomConnectivity
ÖÖ5 J
(
ÖÖJ K
)
ÖÖK L
;
ÖÖL M
bool
áá 
statusChanged
áá 
=
áá  
	newStatus
áá! *
!=
áá+ -
previousStatus
áá. <
;
áá< =
bool
àà !
connectivityChanged
àà $
=
àà% &
newConnectivity
àà' 6
!=
àà7 9"
previousConnectivity
àà: N
;
ààN O
if
ää 
(
ää 
!
ää 
statusChanged
ää 
&&
ää !
!
ää" #!
connectivityChanged
ää# 6
)
ää6 7
{
ãã 
return
åå 
;
åå 
}
çç 
if
èè 
(
èè 
statusChanged
èè 
)
èè 
rootNode
èè '
[
èè' (
$str
èè( 0
]
èè0 1
=
èè2 3
	newStatus
èè4 =
;
èè= >
if
êê 
(
êê !
connectivityChanged
êê #
)
êê# $
rootNode
êê% -
[
êê- .
$str
êê. <
]
êê< =
=
êê> ?
newConnectivity
êê@ O
;
êêO P
var
íí 
now
íí 
=
íí 
DateTime
íí 
.
íí 
UtcNow
íí %
;
íí% &
rootNode
ìì 
[
ìì 
$str
ìì "
]
ìì" #
=
ìì$ %
now
ìì& )
.
ìì) *
ToString
ìì* 2
(
ìì2 3
$str
ìì3 6
)
ìì6 7
;
ìì7 8
_deviceStateCache
îî 
.
îî 
UpdateLastUpdated
îî /
(
îî/ 0
device
îî0 6
.
îî6 7
MacId
îî7 <
,
îî< =
now
îî> A
)
îîA B
;
îîB C
var
ññ 

currentTop
ññ 
=
ññ "
_deviceServiceHelper
ññ 1
.
ññ1 2 
ExtractTopLevelDto
ññ2 D
(
ññD E
device
ññE K
.
ññK L
MacId
ññL Q
,
ññQ R
rootNode
ññS [
)
ññ[ \
;
ññ\ ]
if
òò 
(
òò !
_alarmToggleService
òò #
.
òò# $
IsAlarmEnabled
òò$ 2
)
òò2 3
{
ôô 
await
öö %
_alarmEvaluationService
öö -
.
öö- .
EvaluateTopAsync
öö. >
(
öö> ?

currentTop
öö? I
,
ööI J
previousTop
ööK V
)
ööV W
;
ööW X
}
õõ 
var
ùù 
updatedDevice
ùù 
=
ùù 
new
ùù  #
DeviceMetadata
ùù$ 2
{
ûû 
MacId
üü 
=
üü 
device
üü 
.
üü 
MacId
üü $
,
üü$ %
Name
†† 
=
†† 
rootNode
†† 
[
††  
$str
††  &
]
††& '
?
††' (
.
††( )
GetValue
††) 1
<
††1 2
string
††2 8
>
††8 9
(
††9 :
)
††: ;
??
††< >
$str
††? H
,
††H I
Type
°° 
=
°° 
rootNode
°° 
[
°°  
$str
°°  &
]
°°& '
?
°°' (
.
°°( )
GetValue
°°) 1
<
°°1 2
string
°°2 8
>
°°8 9
(
°°9 :
)
°°: ;
??
°°< >
$str
°°? H
,
°°H I
FileName
¢¢ 
=
¢¢ 
rootNode
¢¢ #
[
¢¢# $
$str
¢¢$ .
]
¢¢. /
?
¢¢/ 0
.
¢¢0 1
GetValue
¢¢1 9
<
¢¢9 :
string
¢¢: @
>
¢¢@ A
(
¢¢A B
)
¢¢B C
??
¢¢D F
$str
¢¢G I
,
¢¢I J
Status
££ 
=
££ 
rootNode
££ !
[
££! "
$str
££" *
]
££* +
?
££+ ,
.
££, -
GetValue
££- 5
<
££5 6
string
££6 <
>
££< =
(
££= >
)
££> ?
??
££@ B
	newStatus
££C L
,
££L M
Connectivity
§§ 
=
§§ 
rootNode
§§ '
[
§§' (
$str
§§( 6
]
§§6 7
?
§§7 8
.
§§8 9
GetValue
§§9 A
<
§§A B
string
§§B H
>
§§H I
(
§§I J
)
§§J K
??
§§L N
newConnectivity
§§O ^
,
§§^ _
LastUpdated
•• 
=
•• 
now
•• !
}
¶¶ 
;
¶¶ 
var
®® 
updatedFields
®® 
=
®® 
new
®®  #
List
®®$ (
<
®®( )
string
®®) /
>
®®/ 0
(
®®0 1
)
®®1 2
;
®®2 3
if
©© 
(
©© 
statusChanged
©© 
)
©© 
updatedFields
©© ,
.
©©, -
Add
©©- 0
(
©©0 1
$str
©©1 9
)
©©9 :
;
©©: ;
if
™™ 
(
™™ !
connectivityChanged
™™ #
)
™™# $
updatedFields
™™% 2
.
™™2 3
Add
™™3 6
(
™™6 7
$str
™™7 E
)
™™E F
;
™™F G
await
¨¨ "
_deviceServiceHelper
¨¨ &
.
¨¨& '&
BroadcastTopLevelSummary
¨¨' ?
(
¨¨? @
new
¨¨@ C
List
¨¨D H
<
¨¨H I
(
¨¨I J
DeviceMetadata
¨¨J X
,
¨¨X Y
List
¨¨Z ^
<
¨¨^ _
string
¨¨_ e
>
¨¨e f
)
¨¨f g
>
¨¨g h
{
¨¨i j
(
¨¨k l
updatedDevice
¨¨l y
,
¨¨y z
updatedFields¨¨{ à
)¨¨à â
}¨¨ä ã
)¨¨ã å
;¨¨å ç

wasUpdated
ÆÆ 
=
ÆÆ 
true
ÆÆ 
;
ÆÆ 
}
ØØ 	
)
ØØ	 

;
ØØ
 
return
±± 

wasUpdated
±± 
;
±± 
}
≤≤ 
public
¥¥ 

async
¥¥ 
Task
¥¥ 
<
¥¥ 
bool
¥¥ 
>
¥¥ 5
'SimulateDynamicPropertiesUpdateForBatch
¥¥ C
(
¥¥C D
)
¥¥D E
{
µµ 
var
∂∂ "
updatedDeviceDetails
∂∂  
=
∂∂! "
new
∂∂# &
List
∂∂' +
<
∂∂+ ,
(
∂∂, -
string
∂∂- 3
MacId
∂∂4 9
,
∂∂9 :
string
∂∂; A
	EventName
∂∂B K
,
∂∂K L
JsonElement
∂∂M X
DetailPayload
∂∂Y f
)
∂∂f g
>
∂∂g h
(
∂∂h i
)
∂∂i j
;
∂∂j k
foreach
∏∏ 
(
∏∏ 
var
∏∏ 
device
∏∏ 
in
∏∏ 
_devices
∏∏ '
)
∏∏' (
{
ππ 	
var
∫∫ 
root
∫∫ 
=
∫∫ 
_deviceStateCache
∫∫ (
.
∫∫( )
GetDeviceState
∫∫) 7
(
∫∫7 8
device
∫∫8 >
.
∫∫> ?
MacId
∫∫? D
)
∫∫D E
;
∫∫E F
if
ªª 
(
ªª 
root
ªª 
==
ªª 
null
ªª 
)
ªª 
continue
ªª &
;
ªª& '
await
ΩΩ 
_deviceStateCache
ΩΩ #
.
ΩΩ# $
WithLock
ΩΩ$ ,
(
ΩΩ, -
device
ΩΩ- 3
.
ΩΩ3 4
MacId
ΩΩ4 9
,
ΩΩ9 :
async
ΩΩ; @
(
ΩΩA B
root
ΩΩB F
)
ΩΩF G
=>
ΩΩH J
{
ææ 
var
øø 
previousDynamic
øø #
=
øø$ %"
_deviceServiceHelper
øø& :
.
øø: ;
ExtractDynamicDto
øø; L
(
øøL M
device
øøM S
.
øøS T
MacId
øøT Y
,
øøY Z
root
øø[ _
.
øø_ `
	DeepClone
øø` i
(
øøi j
)
øøj k
)
øøk l
;
øøl m
var
¿¿ 
updatedNode
¿¿ 
=
¿¿  !"
_deviceServiceHelper
¿¿" 6
.
¿¿6 7%
UpdateDynamicProperties
¿¿7 N
(
¿¿N O
root
¿¿O S
[
¿¿S T
$str
¿¿T g
]
¿¿g h
,
¿¿h i
root
¿¿j n
[
¿¿n o
$str¿¿o É
]¿¿É Ñ
)¿¿Ñ Ö
;¿¿Ö Ü
var
¬¬ 
currentDynamic
¬¬ "
=
¬¬# $"
_deviceServiceHelper
¬¬% 9
.
¬¬9 :
ExtractDynamicDto
¬¬: K
(
¬¬K L
device
¬¬L R
.
¬¬R S
MacId
¬¬S X
,
¬¬X Y
root
¬¬Z ^
)
¬¬^ _
;
¬¬_ `
if
ƒƒ 
(
ƒƒ !
_alarmToggleService
ƒƒ '
.
ƒƒ' (
IsAlarmEnabled
ƒƒ( 6
)
ƒƒ6 7
{
≈≈ 
await
∆∆ %
_alarmEvaluationService
∆∆ 1
.
∆∆1 2"
EvaluateDynamicAsync
∆∆2 F
(
∆∆F G
currentDynamic
∆∆G U
,
∆∆U V
previousDynamic
∆∆W f
)
∆∆f g
;
∆∆g h
}
«« 
if
…… 
(
…… 
updatedNode
…… 
is
……  "
not
……# &
null
……' +
)
……+ ,
{
   
var
ÃÃ 
jsonElement
ÃÃ #
=
ÃÃ$ %
JsonDocument
ÃÃ& 2
.
ÃÃ2 3
Parse
ÃÃ3 8
(
ÃÃ8 9
updatedNode
ÃÃ9 D
.
ÃÃD E
ToJsonString
ÃÃE Q
(
ÃÃQ R
)
ÃÃR S
)
ÃÃS T
.
ÃÃT U
RootElement
ÃÃU `
.
ÃÃ` a
Clone
ÃÃa f
(
ÃÃf g
)
ÃÃg h
;
ÃÃh i"
updatedDeviceDetails
ŒŒ (
.
ŒŒ( )
Add
ŒŒ) ,
(
ŒŒ, -
(
ŒŒ- .
MacId
œœ 
:
œœ 
device
œœ %
.
œœ% &
MacId
œœ& +
,
œœ+ ,
	EventName
–– !
:
––! "
$"
––# %
$str
––% 2
{
––2 3
device
––3 9
.
––9 :
MacId
––: ?
}
––? @
"
––@ A
,
––A B
DetailPayload
—— %
:
——% &
jsonElement
——' 2
)
““ 
)
““ 
;
““ 
}
”” 
}
‘‘ 
)
‘‘ 
;
‘‘ 
}
’’ 	
await
◊◊ "
_deviceServiceHelper
◊◊ "
.
◊◊" #*
BroadcastDeviceDetailUpdates
◊◊# ?
(
◊◊? @"
updatedDeviceDetails
◊◊@ T
)
◊◊T U
;
◊◊U V
return
ÿÿ 
true
ÿÿ 
;
ÿÿ 
}
ŸŸ 
public
€€ 

async
€€ 
Task
€€ 
<
€€ 
List
€€ 
<
€€ !
DevicesNameMacIdDto
€€ .
>
€€. /
>
€€/ 0%
GetDevicesNameMacIdList
€€1 H
(
€€H I
)
€€I J
{
‹‹ 
return
›› 
_devices
›› 
.
›› 
Select
›› 
(
›› 
d
››  
=>
››! #
new
››$ '!
DevicesNameMacIdDto
››( ;
{
ﬁﬁ 	

DeviceName
ﬂﬂ 
=
ﬂﬂ 
d
ﬂﬂ 
.
ﬂﬂ 
Name
ﬂﬂ 
,
ﬂﬂ  
DeviceMacId
‡‡ 
=
‡‡ 
d
‡‡ 
.
‡‡ 
MacId
‡‡ !
}
·· 	
)
··	 

.
··
 
ToList
·· 
(
·· 
)
·· 
;
·· 
}
‚‚ 
public
‰‰ 

async
‰‰ 
Task
‰‰ 
<
‰‰ 1
#DeviceMetadataPaginatedandSortedDto
‰‰ 9
>
‰‰9 :+
GetAllDataRefereshedFromCache
‰‰; X
(
‰‰X Y'
DeviceTopLevelSortOptions
‰‰Y r
request
‰‰s z
,
‰‰z {
string‰‰| Ç
input‰‰É à
=‰‰â ä
$str‰‰ã ç
)‰‰ç é
{
ÂÂ 
await
ÊÊ %
refreshDeviceStateCache
ÊÊ %
(
ÊÊ% &
)
ÊÊ& '
;
ÊÊ' (
if
ËË 

(
ËË 
input
ËË 
!=
ËË 
$str
ËË  
)
ËË  !
return
ÈÈ 0
"GetSearchedDeviceMetadataPaginated
ÈÈ 5
(
ÈÈ5 6
request
ÈÈ6 =
,
ÈÈ= >
input
ÈÈ? D
)
ÈÈD E
;
ÈÈE F
return
ÎÎ 4
&GetAllDeviceMetadataPaginatedandSorted
ÎÎ 5
(
ÎÎ5 6
request
ÎÎ6 =
)
ÎÎ= >
;
ÎÎ> ?
}
ÏÏ 
public
ÔÔ 

async
ÔÔ 
Task
ÔÔ 
<
ÔÔ 
string
ÔÔ 
>
ÔÔ 

UploadFile
ÔÔ (
(
ÔÔ( )
	IFormFile
ÔÔ) 2
file
ÔÔ3 7
)
ÔÔ7 8
{
 
if
ÚÚ 

(
ÚÚ 
file
ÚÚ 
==
ÚÚ 
null
ÚÚ 
||
ÚÚ 
file
ÚÚ  
.
ÚÚ  !
Length
ÚÚ! '
==
ÚÚ( *
$num
ÚÚ+ ,
)
ÚÚ, -
throw
ÛÛ 
new
ÛÛ 
	Exception
ÛÛ 
(
ÛÛ  
$str
ÛÛ  3
)
ÛÛ3 4
;
ÛÛ4 5
string
ˆˆ 
fileContent
ˆˆ 
=
ˆˆ 
await
ˆˆ ""
ReadFileContentAsync
ˆˆ# 7
(
ˆˆ7 8
file
ˆˆ8 <
)
ˆˆ< =
;
ˆˆ= >
JsonDocument
˘˘ 
jsonDoc
˘˘ 
=
˘˘ 
ParseJsonDocument
˘˘ 0
(
˘˘0 1
fileContent
˘˘1 <
)
˘˘< =
;
˘˘= >
JsonElement
˙˙ 
root
˙˙ 
=
˙˙ 
jsonDoc
˙˙ "
.
˙˙" #
RootElement
˙˙# .
;
˙˙. /
var
˝˝ 
(
˝˝ 
	macIdProp
˝˝ 
,
˝˝ 
staticProps
˝˝ #
,
˝˝# $
dynamicProps
˝˝% 1
,
˝˝1 2

alarmRules
˝˝3 =
)
˝˝= >
=
˝˝? @&
ValidateAndExtractFields
˝˝A Y
(
˝˝Y Z
root
˝˝Z ^
,
˝˝^ _
file
˝˝` d
.
˝˝d e
FileName
˝˝e m
)
˝˝m n
;
˝˝n o
var
ÄÄ 
deviceState
ÄÄ 
=
ÄÄ 
new
ÄÄ 
DeviceState
ÄÄ )
{
ÅÅ 	
Root
ÇÇ 
=
ÇÇ 
JsonNode
ÇÇ 
.
ÇÇ 
Parse
ÇÇ !
(
ÇÇ! "
fileContent
ÇÇ" -
)
ÇÇ- .
!
ÇÇ. /
,
ÇÇ/ 0
LastUpdated
ÉÉ 
=
ÉÉ 
DateTime
ÉÉ "
.
ÉÉ" #
UtcNow
ÉÉ# )
}
ÑÑ 	
;
ÑÑ	 

if
áá 

(
áá 
_useDatabase
áá 
)
áá 
{
àà 	
await
ââ $
InsertDeviceInDatabase
ââ (
(
ââ( )
root
ââ) -
,
ââ- .
	macIdProp
ââ/ 8
,
ââ8 9
staticProps
ââ: E
,
ââE F
dynamicProps
ââG S
,
ââS T
deviceState
ââU `
.
ââ` a
LastUpdated
ââa l
)
ââl m
;
ââm n
}
ää 	
else
ãã 
{
åå 	
await
çç "
SaveDeviceFileToDisk
çç &
(
çç& '
file
çç' +
.
çç+ ,
FileName
çç, 4
,
çç4 5
fileContent
çç6 A
)
ççA B
;
ççB C
}
éé 	
var
ëë 
rulesToSend
ëë 
=
ëë 
ParseAlarmRules
ëë )
(
ëë) *

alarmRules
ëë* 4
)
ëë4 5
;
ëë5 6
await
íí %
_alarmEvaluationService
íí %
.
íí% &
AddAlarmRules
íí& 3
(
íí3 4
	macIdProp
íí4 =
.
íí= >
ToString
íí> F
(
ííF G
)
ííG H
,
ííH I
rulesToSend
ííJ U
)
ííU V
;
ííV W
await
ïï 
_deviceStateCache
ïï 
.
ïï  
	LoadAsync
ïï  )
(
ïï) *
)
ïï* +
;
ïï+ ,
return
óó 
$str
óó +
;
óó+ ,
}
òò 
private
ùù 
async
ùù 
Task
ùù 
<
ùù 
string
ùù 
>
ùù "
ReadFileContentAsync
ùù 3
(
ùù3 4
	IFormFile
ùù4 =
file
ùù> B
)
ùùB C
{
ûû 
using
üü 
var
üü 
reader
üü 
=
üü 
new
üü 
StreamReader
üü +
(
üü+ ,
file
üü, 0
.
üü0 1
OpenReadStream
üü1 ?
(
üü? @
)
üü@ A
)
üüA B
;
üüB C
return
†† 
await
†† 
reader
†† 
.
†† 
ReadToEndAsync
†† *
(
††* +
)
††+ ,
;
††, -
}
°° 
private
¶¶ 
JsonDocument
¶¶ 
ParseJsonDocument
¶¶ *
(
¶¶* +
string
¶¶+ 1
fileContent
¶¶2 =
)
¶¶= >
{
ßß 
try
®® 
{
©© 	
return
™™ 
JsonDocument
™™ 
.
™™  
Parse
™™  %
(
™™% &
fileContent
™™& 1
)
™™1 2
;
™™2 3
}
´´ 	
catch
¨¨ 
(
¨¨ 
JsonException
¨¨ 
)
¨¨ 
{
≠≠ 	
throw
ÆÆ 
new
ÆÆ 
	Exception
ÆÆ 
(
ÆÆ  
$str
ÆÆ  D
)
ÆÆD E
;
ÆÆE F
}
ØØ 	
}
∞∞ 
private
∂∂ 
(
∂∂ 
JsonElement
∂∂ 
	macIdProp
∂∂ "
,
∂∂" #
JsonElement
∂∂$ /
staticProps
∂∂0 ;
,
∂∂; <
JsonElement
∂∂= H
dynamicProps
∂∂I U
,
∂∂U V
JsonElement
∂∂W b

alarmRules
∂∂c m
)
∂∂m n&
ValidateAndExtractFields
∑∑  
(
∑∑  !
JsonElement
∑∑! ,
root
∑∑- 1
,
∑∑1 2
string
∑∑3 9
uploadedFileName
∑∑: J
)
∑∑J K
{
∏∏ 
if
ππ 

(
ππ 
!
ππ 
root
ππ 
.
ππ 
TryGetProperty
ππ  
(
ππ  !
$str
ππ! '
,
ππ' (
out
ππ) ,
_
ππ- .
)
ππ. /
||
ππ0 2
!
∫∫ 
root
∫∫ 
.
∫∫ 
TryGetProperty
∫∫  
(
∫∫  !
$str
∫∫! '
,
∫∫' (
out
∫∫) ,
_
∫∫- .
)
∫∫. /
||
∫∫0 2
!
ªª 
root
ªª 
.
ªª 
TryGetProperty
ªª  
(
ªª  !
$str
ªª! (
,
ªª( )
out
ªª* -
var
ªª. 1
	macIdProp
ªª2 ;
)
ªª; <
||
ªª= ?
!
ºº 
root
ºº 
.
ºº 
TryGetProperty
ºº  
(
ºº  !
$str
ºº! 3
,
ºº3 4
out
ºº5 8
var
ºº9 <
staticProps
ºº= H
)
ººH I
||
ººJ L
!
ΩΩ 
root
ΩΩ 
.
ΩΩ 
TryGetProperty
ΩΩ  
(
ΩΩ  !
$str
ΩΩ! 4
,
ΩΩ4 5
out
ΩΩ6 9
var
ΩΩ: =
dynamicProps
ΩΩ> J
)
ΩΩJ K
||
ΩΩL N
!
ææ 
root
ææ 
.
ææ 
TryGetProperty
ææ  
(
ææ  !
$str
ææ! -
,
ææ- .
out
ææ/ 2
var
ææ3 6

alarmRules
ææ7 A
)
ææA B
)
ææB C
{
øø 	
throw
¿¿ 
new
¿¿ 
	Exception
¿¿ 
(
¿¿  
$str¿¿  ê
)¿¿ê ë
;¿¿ë í
}
¡¡ 	
if
ƒƒ 

(
ƒƒ 
staticProps
ƒƒ 
.
ƒƒ 
	ValueKind
ƒƒ !
!=
ƒƒ" $
JsonValueKind
ƒƒ% 2
.
ƒƒ2 3
Object
ƒƒ3 9
||
ƒƒ: <
dynamicProps
ƒƒ= I
.
ƒƒI J
	ValueKind
ƒƒJ S
!=
ƒƒT V
JsonValueKind
ƒƒW d
.
ƒƒd e
Object
ƒƒe k
)
ƒƒk l
throw
≈≈ 
new
≈≈ 
	Exception
≈≈ 
(
≈≈  
$str
≈≈  b
)
≈≈b c
;
≈≈c d
return
«« 
(
«« 
	macIdProp
«« 
,
«« 
staticProps
«« &
,
««& '
dynamicProps
««( 4
,
««4 5

alarmRules
««6 @
)
««@ A
;
««A B
}
»» 
private
ÕÕ 
async
ÕÕ 
Task
ÕÕ $
InsertDeviceInDatabase
ÕÕ -
(
ÕÕ- .
JsonElement
ŒŒ 
root
ŒŒ 
,
ŒŒ 
JsonElement
œœ 
	macIdProp
œœ 
,
œœ 
JsonElement
–– 
staticProps
–– 
,
––  
JsonElement
—— 
dynamicProps
——  
,
——  !
DateTime
““ 
lastUpdated
““ 
)
““ 
{
”” 
var
‘‘ 
macId
‘‘ 
=
‘‘ 
	macIdProp
‘‘ 
.
‘‘ 
	GetString
‘‘ '
(
‘‘' (
)
‘‘( )
;
‘‘) *
var
÷÷ 
device
÷÷ 
=
÷÷ 
await
÷÷ 

_dbContext
÷÷ %
.
÷÷% &
Devices
÷÷& -
.
÷÷- .!
FirstOrDefaultAsync
÷÷. A
(
÷÷A B
d
÷÷B C
=>
÷÷D F
d
÷÷G H
.
÷÷H I
MacId
÷÷I N
==
÷÷O Q
macId
÷÷R W
)
÷÷W X
;
÷÷X Y
if
◊◊ 

(
◊◊ 
device
◊◊ 
!=
◊◊ 
null
◊◊ 
)
◊◊ 
{
ÿÿ 	
throw
ŸŸ 
new
ŸŸ 
	Exception
ŸŸ 
(
ŸŸ  
$"
ŸŸ  "
$str
ŸŸ" 6
{
ŸŸ6 7
device
ŸŸ7 =
.
ŸŸ= >
Name
ŸŸ> B
}
ŸŸB C
$strŸŸC à
"ŸŸà â
)ŸŸâ ä
;ŸŸä ã
}
⁄⁄ 	
else
€€ 
{
‹‹ 	
device
ﬁﬁ 
=
ﬁﬁ 
new
ﬁﬁ 
Device
ﬁﬁ 
{
ﬂﬂ 
MacId
‡‡ 
=
‡‡ 
macId
‡‡ 
,
‡‡ 
Name
·· 
=
·· 
root
·· 
.
·· 
GetProperty
·· '
(
··' (
$str
··( .
)
··. /
.
··/ 0
	GetString
··0 9
(
··9 :
)
··: ;
,
··; <
Type
‚‚ 
=
‚‚ 
root
‚‚ 
.
‚‚ 
GetProperty
‚‚ '
(
‚‚' (
$str
‚‚( .
)
‚‚. /
.
‚‚/ 0
	GetString
‚‚0 9
(
‚‚9 :
)
‚‚: ;
,
‚‚; <
Status
„„ 
=
„„ 
root
„„ 
.
„„ 
GetProperty
„„ )
(
„„) *
$str
„„* 2
)
„„2 3
.
„„3 4
	GetString
„„4 =
(
„„= >
)
„„> ?
,
„„? @
Connectivity
‰‰ 
=
‰‰ 
root
‰‰ #
.
‰‰# $
GetProperty
‰‰$ /
(
‰‰/ 0
$str
‰‰0 >
)
‰‰> ?
.
‰‰? @
	GetString
‰‰@ I
(
‰‰I J
)
‰‰J K
,
‰‰K L
LastUpdated
ÂÂ 
=
ÂÂ 
lastUpdated
ÂÂ )
,
ÂÂ) *
StaticProperties
ÊÊ  
=
ÊÊ! "
staticProps
ÊÊ# .
.
ÊÊ. /

GetRawText
ÊÊ/ 9
(
ÊÊ9 :
)
ÊÊ: ;
,
ÊÊ; <
DynamicProperties
ÁÁ !
=
ÁÁ" #
dynamicProps
ÁÁ$ 0
.
ÁÁ0 1

GetRawText
ÁÁ1 ;
(
ÁÁ; <
)
ÁÁ< =
,
ÁÁ= >!
TopLevelObservables
ËË #
=
ËË$ %
root
ËË& *
.
ËË* +
TryGetProperty
ËË+ 9
(
ËË9 :
$str
ËË: O
,
ËËO P
out
ËËQ T
var
ËËU X
topObs2
ËËY `
)
ËË` a
?
ËËb c
topObs2
ËËd k
.
ËËk l

GetRawText
ËËl v
(
ËËv w
)
ËËw x
:
ËËy z
$str
ËË{ 
,ËË Ä 
DynamicObservables
ÈÈ "
=
ÈÈ# $
root
ÈÈ% )
.
ÈÈ) *
TryGetProperty
ÈÈ* 8
(
ÈÈ8 9
$str
ÈÈ9 M
,
ÈÈM N
out
ÈÈO R
var
ÈÈS V
dynObs2
ÈÈW ^
)
ÈÈ^ _
?
ÈÈ` a
dynObs2
ÈÈb i
.
ÈÈi j

GetRawText
ÈÈj t
(
ÈÈt u
)
ÈÈu v
:
ÈÈw x
$str
ÈÈy }
}
ÍÍ 
;
ÍÍ 
await
ÎÎ 

_dbContext
ÎÎ 
.
ÎÎ 
Devices
ÎÎ $
.
ÎÎ$ %
AddAsync
ÎÎ% -
(
ÎÎ- .
device
ÎÎ. 4
)
ÎÎ4 5
;
ÎÎ5 6
}
ÏÏ 	
await
ÓÓ 

_dbContext
ÓÓ 
.
ÓÓ 
SaveChangesAsync
ÓÓ )
(
ÓÓ) *
)
ÓÓ* +
;
ÓÓ+ ,
}
ÔÔ 
private
ÙÙ 
async
ÙÙ 
Task
ÙÙ "
SaveDeviceFileToDisk
ÙÙ +
(
ÙÙ+ ,
string
ÙÙ, 2
fileName
ÙÙ3 ;
,
ÙÙ; <
string
ÙÙ= C
fileContent
ÙÙD O
)
ÙÙO P
{
ıı 
if
ˆˆ 

(
ˆˆ 
!
ˆˆ 
	Directory
ˆˆ 
.
ˆˆ 
Exists
ˆˆ 
(
ˆˆ 
_dataDirectory
ˆˆ ,
)
ˆˆ, -
)
ˆˆ- .
	Directory
˜˜ 
.
˜˜ 
CreateDirectory
˜˜ %
(
˜˜% &
_dataDirectory
˜˜& 4
)
˜˜4 5
;
˜˜5 6
var
˘˘ 
filePath
˘˘ 
=
˘˘ 
Path
˘˘ 
.
˘˘ 
Combine
˘˘ #
(
˘˘# $
_dataDirectory
˘˘$ 2
,
˘˘2 3
fileName
˘˘4 <
)
˘˘< =
;
˘˘= >
if
˙˙ 

(
˙˙ 
File
˙˙ 
.
˙˙ 
Exists
˙˙ 
(
˙˙ 
filePath
˙˙  
)
˙˙  !
)
˙˙! "
throw
˚˚ 
new
˚˚ 
	Exception
˚˚ 
(
˚˚  
$"
˚˚  "
$str
˚˚" S
{
˚˚S T
fileName
˚˚T \
}
˚˚\ ]
$str
˚˚] y
"
˚˚y z
)
˚˚z {
;
˚˚{ |
await
˝˝ 
File
˝˝ 
.
˝˝ 
WriteAllTextAsync
˝˝ $
(
˝˝$ %
filePath
˝˝% -
,
˝˝- .
fileContent
˝˝/ :
)
˝˝: ;
;
˝˝; <
}
˛˛ 
private
ÄÄ 
async
ÄÄ 
Task
ÄÄ 
<
ÄÄ 
bool
ÄÄ 
>
ÄÄ %
refreshDeviceStateCache
ÄÄ 4
(
ÄÄ4 5
)
ÄÄ5 6
{
ÅÅ 
await
ÇÇ 
_deviceStateCache
ÇÇ 
.
ÇÇ   
PersistToDiskAsync
ÇÇ  2
(
ÇÇ2 3
)
ÇÇ3 4
;
ÇÇ4 5
await
ÉÉ 
_deviceStateCache
ÉÉ 
.
ÉÉ  
	LoadAsync
ÉÉ  )
(
ÉÉ) *
)
ÉÉ* +
;
ÉÉ+ ,
return
ÖÖ 
true
ÖÖ 
;
ÖÖ 
}
ÜÜ 
private
àà 
List
àà 
<
àà 
AlarmRuleDto
àà 
>
àà 
ParseAlarmRules
àà .
(
àà. /
JsonElement
àà/ :
alarmRulesElement
àà; L
)
ààL M
{
ââ 
var
ää 
rules
ää 
=
ää 
new
ää 
List
ää 
<
ää 
AlarmRuleDto
ää )
>
ää) *
(
ää* +
)
ää+ ,
;
ää, -
foreach
åå 
(
åå 
var
åå 
ruleJson
åå 
in
åå  
alarmRulesElement
åå! 2
.
åå2 3
EnumerateArray
åå3 A
(
ååA B
)
ååB C
)
ååC D
{
çç 	
var
éé 
rule
éé 
=
éé 
new
éé 
AlarmRuleDto
éé '
{
èè 
	FieldPath
êê 
=
êê 
ruleJson
êê $
.
êê$ %
GetProperty
êê% 0
(
êê0 1
$str
êê1 <
)
êê< =
.
êê= >
	GetString
êê> G
(
êêG H
)
êêH I
!
êêI J
,
êêJ K
Operator
ëë 
=
ëë 
ruleJson
ëë #
.
ëë# $
GetProperty
ëë$ /
(
ëë/ 0
$str
ëë0 :
)
ëë: ;
.
ëë; <
	GetString
ëë< E
(
ëëE F
)
ëëF G
!
ëëG H
,
ëëH I
ThresholdValue
íí 
=
íí  
ruleJson
íí! )
.
íí) *
GetProperty
íí* 5
(
íí5 6
$str
íí6 F
)
ííF G
.
ííG H
	GetString
ííH Q
(
ííQ R
)
ííR S
!
ííS T
,
ííT U
Severity
ìì 
=
ìì 
ruleJson
ìì #
.
ìì# $
GetProperty
ìì$ /
(
ìì/ 0
$str
ìì0 :
)
ìì: ;
.
ìì; <
	GetString
ìì< E
(
ììE F
)
ììF G
!
ììG H
,
ììH I
MessageTemplate
îî 
=
îî  !
ruleJson
îî" *
.
îî* +
GetProperty
îî+ 6
(
îî6 7
$str
îî7 H
)
îîH I
.
îîI J
	GetString
îîJ S
(
îîS T
)
îîT U
!
îîU V
}
ïï 
;
ïï 
rules
óó 
.
óó 
Add
óó 
(
óó 
rule
óó 
)
óó 
;
óó 
}
òò 	
return
öö 
rules
öö 
;
öö 
}
õõ 
public
ùù 
1
#DeviceMetadataPaginatedandSortedDto
ùù ."
GetAllDeviceMetadata
ùù/ C
(
ùùC D
)
ùùD E
{
ûû 
var
üü 
metaData
üü 
=
üü 
_devices
üü 
.
üü  
AsQueryable
üü  +
(
üü+ ,
)
üü, -
;
üü- .
return
££ 
new
££ 1
#DeviceMetadataPaginatedandSortedDto
££ 6
(
££6 7
)
££7 8
{
§§ 	

TotalCount
•• 
=
•• 
metaData
•• !
.
••! "
Count
••" '
(
••' (
)
••( )
,
••) *
DeviceMetadata
¶¶ 
=
¶¶ 
metaData
¶¶ %
.
¶¶% &
ToList
¶¶& ,
(
¶¶, -
)
¶¶- .
}
ßß 	
;
ßß	 

}
®® 
}©© õ"
ùC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\DeviceLiveDataBgService.cs
	namespace 	
Infrastructure
 
. 
Services !
{ 
public 

class #
DeviceLiveDataBgService (
:) *
BackgroundService+ <
{ 
private 
readonly 
ILogger  
<  !#
DeviceLiveDataBgService! 8
>8 9
_logger: A
;A B
private 
readonly 
DeviceStateCache )
_deviceStateCache* ;
;; <
private 
readonly  
IServiceScopeFactory -
_scopeFactory. ;
;; <
private 
DateTime "
_lastDynamicUpdateTime /
=0 1
DateTime2 :
.: ;
UtcNow; A
;A B
public #
DeviceLiveDataBgService &
(& '
DeviceStateCache' 7
deviceStateCache8 H
,H I 
IServiceScopeFactoryJ ^
scopeFactory_ k
,k l
ILoggerm t
<t u$
DeviceLiveDataBgService	u å
>
å ç
logger
é î
)
î ï
{ 	
_deviceStateCache 
= 
deviceStateCache  0
;0 1
_logger 
= 
logger 
; 
_scopeFactory 
= 
scopeFactory (
;( )
} 	
	protected 
override 
async  
Task! %
ExecuteAsync& 2
(2 3
CancellationToken3 D
stoppingTokenE R
)R S
{ 	
_logger 
. 
LogInformation "
(" #
$str# H
)H I
;I J
using   
(   
var   
scope   
=   
_scopeFactory   ,
.  , -
CreateScope  - 8
(  8 9
)  9 :
)  : ;
{!! 
var"" 
deviceService"" !
=""" #
scope""$ )
."") *
ServiceProvider""* 9
.""9 :
GetRequiredService"": L
<""L M
IDeviceService""M [
>""[ \
(""\ ]
)""] ^
;""^ _
await## 
_deviceStateCache## '
.##' (
	LoadAsync##( 1
(##1 2
)##2 3
;##3 4
while%% 
(%% 
!%% 
stoppingToken%% %
.%%% &#
IsCancellationRequested%%& =
)%%= >
{&& 
await'' 
deviceService'' '
.''' (.
"SimulateTopLevelChangeForOneDevice''( J
(''J K
)''K L
;''L M
if)) 
()) 
()) 
DateTime)) !
.))! "
UtcNow))" (
-))) *"
_lastDynamicUpdateTime))+ A
)))A B
.))B C
TotalSeconds))C O
>=))P R
$num))S U
)))U V
{** 
await++ 
deviceService++ +
.+++ ,3
'SimulateDynamicPropertiesUpdateForBatch++, S
(++S T
)++T U
;++U V"
_lastDynamicUpdateTime,, .
=,,/ 0
DateTime,,1 9
.,,9 :
UtcNow,,: @
;,,@ A
}-- 
await00 
Task00 
.00 
Delay00 $
(00$ %
TimeSpan00% -
.00- .
FromSeconds00. 9
(009 :
$num00: <
)00< =
,00= >
stoppingToken00? L
)00L M
;00M N
}11 
}22 
_logger44 
.44 
LogInformation44 "
(44" #
$str44# H
)44H I
;44I J
}55 	
public77 
override77 
Task77 
	StopAsync77 &
(77& '
CancellationToken77' 8
cancellationToken779 J
)77J K
{88 	
Console99 
.99 
	WriteLine99 
(99 
$str99 =
)99= >
;99> ?
return:: 
base:: 
.:: 
	StopAsync:: !
(::! "
cancellationToken::" 3
)::3 4
;::4 5
};; 	
}<< 
}== ˙
òC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\AlarmToggleService.cs
	namespace 	
Infrastructure
 
. 
Services !
{		 
public

 

class

 
AlarmToggleService

 #
:

$ %
IAlarmToggleService

& 9
{ 
private 
bool 

_isEnabled 
=  !
false" '
;' (
public 
bool 
IsAlarmEnabled "
=># %

_isEnabled& 0
;0 1
public 
void 
SetAlarmEnabled #
(# $
bool$ (
enabled) 0
)0 1
{ 	

_isEnabled 
= 
enabled  
;  !
} 	
} 
} ë'
úC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Services\AlarmEvaluationService.cs
	namespace 	
Infrastructure
 
. 
Services !
{ 
public		 

class		 "
AlarmEvaluationService		 '
:		( )#
IAlarmEvaluationService		* A
{

 
private 
readonly 

HttpClient #
_httpClient$ /
;/ 0
private 
readonly 
ILogger  
<  !"
AlarmEvaluationService! 7
>7 8
_logger9 @
;@ A
public "
AlarmEvaluationService %
(% &

HttpClient& 0

httpClient1 ;
,; <
ILogger= D
<D E"
AlarmEvaluationServiceE [
>[ \
logger] c
)c d
{ 	
_httpClient 
= 

httpClient $
;$ %
_logger 
= 
logger 
; 
} 	
public 
async 
Task 
EvaluateTopAsync *
(* +!
TopLevelDeviceDataDto+ @
previousA I
,I J!
TopLevelDeviceDataDtoK `
currenta h
)h i
{ 	
var 
request 
= 
new 
{ 
Type 
= 
$str !
,! "
Previous 
= 
previous #
,# $
Current 
= 
current !
} 
; 
await 
SendRequestAsync "
(" #
request# *
,* +
$str, D
)D E
;E F
} 	
public   
async   
Task    
EvaluateDynamicAsync   .
(  . / 
DynamicDeviceDataDto  / C
previous  D L
,  L M 
DynamicDeviceDataDto  N b
current  c j
)  j k
{!! 	
var"" 
request"" 
="" 
new"" 
{## 
Type$$ 
=$$ 
$str$$  
,$$  !
Previous%% 
=%% 
previous%% #
,%%# $
Current&& 
=&& 
current&& !
}'' 
;'' 
await)) 
SendRequestAsync)) "
())" #
request))# *
,))* +
$str)), H
)))H I
;))I J
}** 	
public,, 
async,, 
Task,, 
AddAlarmRules,, '
(,,' (
string,,( .
deviceMacId,,/ :
,,,: ;
List,,< @
<,,@ A
AlarmRuleDto,,A M
>,,M N

alarmRules,,O Y
),,Y Z
{-- 	
await.. 
SendRequestAsync.. "
(.." #

alarmRules..# -
,..- .
$"../ 1
$str..1 J
{..J K
deviceMacId..K V
}..V W
"..W X
)..X Y
;..Y Z
}// 	
private11 
async11 
Task11 
SendRequestAsync11 +
<11+ ,
T11, -
>11- .
(11. /
T11/ 0
payload111 8
,118 9
string11: @
endpoint11A I
)11I J
{22 	
var33 
json33 
=33 
JsonSerializer33 %
.33% &
	Serialize33& /
(33/ 0
payload330 7
,337 8
new339 <!
JsonSerializerOptions33= R
{44  
PropertyNamingPolicy55 $
=55% &
JsonNamingPolicy55' 7
.557 8
	CamelCase558 A
}66 
)66 
;66 
var88 
content88 
=88 
new88 
StringContent88 +
(88+ ,
json88, 0
,880 1
Encoding882 :
.88: ;
UTF888; ?
,88? @
$str88A S
)88S T
;88T U
try:: 
{;; 
var<< 
response<< 
=<< 
await<< $
_httpClient<<% 0
.<<0 1
	PostAsync<<1 :
(<<: ;
endpoint<<; C
,<<C D
content<<E L
)<<L M
;<<M N
if== 
(== 
!== 
response== 
.== 
IsSuccessStatusCode== 1
)==1 2
{>> 
_logger?? 
.?? 

LogWarning?? &
(??& '
$str??' `
,??` a
response??b j
.??j k

StatusCode??k u
)??u v
;??v w
}@@ 
}AA 
catchBB 
(BB 
	ExceptionBB 
exBB 
)BB  
{CC 
_loggerDD 
.DD 
LogErrorDD  
(DD  !
exDD! #
,DD# $
$strDD% O
)DDO P
;DDP Q
}EE 
}FF 	
}GG 
}HH í
èC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\RealTime\DeviceHub.cs”
òC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Persistence\DeviceDbContext.cs
	namespace		 	
Infrastructure		
 
.		 
Persistence		 $
{

 
public 

class 
DeviceDbContext  
:! "
	DbContext# ,
{ 
public 
DeviceDbContext 
( 
DbContextOptions /
</ 0
DeviceDbContext0 ?
>? @
optionsA H
)H I
: 
base 
( 
options 
) 
{ 
} 
public 
DbSet 
< 
Device 
> 
Devices $
{% &
get' *
;* +
set, /
;/ 0
}1 2
=3 4
default5 <
!< =
;= >
} 
} ¸ñ
ñC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Helpers\DynamicDataHelper.cs
	namespace 	
Infrastructure
 
. 
Helpers  
{ 
public 

class 
DynamicDataHelper "
:# $
IDynamicDataHelper% 7
{		 
private

 
readonly

 
Random

 
random

  &
=

' (
new

) ,
(

, -
)

- .
;

. /
private 
readonly 
string 
[  
]  !
statuses" *
=+ ,
{- .
$str/ 7
,7 8
$str9 B
}C D
;D E
private 
readonly 
string 
[  
]  !
conns" '
=( )
{* +
$str, 1
,1 2
$str3 ;
,; <
$str= C
}D E
;E F
string 
IDynamicDataHelper !
.! "
GetRandomStatus" 1
(1 2
)2 3
{ 	
return 
statuses 
[ 
random "
." #
Next# '
(' (
statuses( 0
.0 1
Length1 7
)7 8
]8 9
;9 :
} 	
string 
IDynamicDataHelper !
.! "!
GetRandomConnectivity" 7
(7 8
)8 9
{ 	
return 
conns 
[ 
random 
.  
Next  $
($ %
conns% *
.* +
Length+ 1
)1 2
]2 3
;3 4
} 	
public 
JsonNode .
"GenerateDynamicDataFromObservables :
(: ;
JsonNode; C
?C D
currentDataE P
,P Q
JsonNodeR Z
?Z [
dynamicObservables\ n
)n o
{ 	
var 
rand 
= 
new 
Random !
(! "
)" #
;# $
if 
( 
dynamicObservables "
is# %
not& )

JsonObject* 4
observableMap5 B
)B C
return 
currentData "
;" #
try 
{ 
foreach   
(   
var   
(   
	fieldName   '
,  ' (
observableDef  ) 6
)  6 7
in  8 :
observableMap  ; H
)  H I
{!! 
if"" 
("" 
observableDef"" %
is""& (
not"") ,

JsonObject""- 7
defObj""8 >
)""> ?
continue##  
;##  !
if%% 
(%% 
defObj%% 
.%% 
TryGetPropertyValue%% 2
(%%2 3
$str%%3 9
,%%9 :
out%%; >
var%%? B
typeNode%%C K
)%%K L
&&%%M O
typeNode%%P X
!=%%Y [
null%%\ `
)%%` a
{&& 
var(( 
type((  
=((! "
typeNode((# +
.((+ ,
GetValue((, 4
<((4 5
string((5 ;
>((; <
(((< =
)((= >
;((> ?
var)) 
generatedValue)) *
=))+ ,
GenerateValue))- :
()): ;
type)); ?
,))? @
defObj))A G
,))G H
rand))I M
)))M N
;))N O
currentData** #
[**# $
	fieldName**$ -
]**- .
=**/ 0
generatedValue**1 ?
;**? @
},, 
else-- 
{.. 
var00 
existingChild00 )
=00* +
currentData00, 7
[007 8
	fieldName008 A
]00A B
as00C E
JsonNode00F N
??00O Q
new00R U

JsonObject00V `
(00` a
)00a b
;00b c
var22 
updatedChild22 (
=22) *.
"GenerateDynamicDataFromObservables22+ M
(22M N
existingChild22N [
,22[ \
defObj22] c
)22c d
;22d e
currentData33 #
[33# $
	fieldName33$ -
]33- .
=33/ 0
updatedChild331 =
;33= >
}44 
}55 
}66 
catch77 
(77 
	Exception77 
ex77 
)77 
{88 
return99 
null99 
;99 
}:: 
return<< 
currentData<< 
;<< 
}== 	
private?? 
JsonNode?? 
GenerateValue?? &
(??& '
string??' -
type??. 2
,??2 3

JsonObject??4 >
def??? B
,??B C
Random??D J
rand??K O
)??O P
{@@ 	
doubleAA 
minAA 
=AA 
defAA 
.AA 
TryGetPropertyValueAA 0
(AA0 1
$strAA1 6
,AA6 7
outAA8 ;
varAA< ?
minNodeAA@ G
)AAG H
?AAI J
minNodeAAK R
?AAR S
.AAS T
GetValueAAT \
<AA\ ]
doubleAA] c
>AAc d
(AAd e
)AAe f
??AAg i
$numAAj k
:AAl m
$numAAn o
;AAo p
doubleBB 
maxBB 
=BB 
defBB 
.BB 
TryGetPropertyValueBB 0
(BB0 1
$strBB1 6
,BB6 7
outBB8 ;
varBB< ?
maxNodeBB@ G
)BBG H
?BBI J
maxNodeBBK R
?BBR S
.BBS T
GetValueBBT \
<BB\ ]
doubleBB] c
>BBc d
(BBd e
)BBe f
??BBg i
$numBBj m
:BBn o
$numBBp s
;BBs t
intCC 
countCC 
=CC 
defCC 
.CC 
TryGetPropertyValueCC /
(CC/ 0
$strCC0 7
,CC7 8
outCC9 <
varCC= @
	countNodeCCA J
)CCJ K
?CCL M
	countNodeCCN W
?CCW X
.CCX Y
GetValueCCY a
<CCa b
intCCb e
>CCe f
(CCf g
)CCg h
??CCi k
$numCCl m
:CCn o
$numCCp q
;CCq r
switchEE 
(EE 
typeEE 
)EE 
{FF 
caseGG 
$strGG 
:GG 
returnHH 
	JsonValueHH $
.HH$ %
CreateHH% +
(HH+ ,
randHH, 0
.HH0 1
NextHH1 5
(HH5 6
(HH6 7
intHH7 :
)HH: ;
minHH; >
,HH> ?
(HH@ A
intHHA D
)HHD E
maxHHE H
+HHI J
$numHHK L
)HHL M
)HHM N
;HHN O
caseJJ 
$strJJ 
:JJ 
returnKK 
	JsonValueKK $
.KK$ %
CreateKK% +
(KK+ ,
MathKK, 0
.KK0 1
RoundKK1 6
(KK6 7
minKK7 :
+KK; <
randKK= A
.KKA B

NextDoubleKKB L
(KKL M
)KKM N
*KKO P
(KKQ R
maxKKR U
-KKV W
minKKX [
)KK[ \
,KK\ ]
$numKK^ _
)KK_ `
)KK` a
;KKa b
caseMM 
$strMM !
:MM! "
returnNN 
	JsonValueNN $
.NN$ %
CreateNN% +
(NN+ ,
$"NN, .
{NN. /
randNN/ 3
.NN3 4
NextNN4 8
(NN8 9
$numNN9 :
,NN: ;
$numNN< ?
)NN? @
}NN@ A
$strNNA B
"NNB C
)NNC D
;NND E
casePP 
$strPP 
:PP 
returnQQ 
	JsonValueQQ $
.QQ$ %
CreateQQ% +
(QQ+ ,
randQQ, 0
.QQ0 1

NextDoubleQQ1 ;
(QQ; <
)QQ< =
<QQ> ?
$numQQ@ C
)QQC D
;QQD E
caseSS 
$strSS 
:SS 
ifTT 
(TT 
defTT 
.TT 
TryGetPropertyValueTT /
(TT/ 0
$strTT0 8
,TT8 9
outTT: =
varTT> A

valuesNodeTTB L
)TTL M
&&TTN P

valuesNodeTTQ [
isTT\ ^
	JsonArrayTT_ h
valArrTTi o
&&TTp r
valArrTTs y
.TTy z
CountTTz 
>
TTÄ Å
$num
TTÇ É
)
TTÉ Ñ
{UU 
returnVV 
	JsonValueVV (
.VV( )
CreateVV) /
(VV/ 0
valArrVV0 6
[VV6 7
randVV7 ;
.VV; <
NextVV< @
(VV@ A
valArrVVA G
.VVG H
CountVVH M
)VVM N
]VVN O
?VVO P
.VVP Q
ToStringVVQ Y
(VVY Z
)VVZ [
)VV[ \
;VV\ ]
}WW 
returnXX 
	JsonValueXX $
.XX$ %
CreateXX% +
(XX+ ,
$strXX, 5
)XX5 6
;XX6 7
caseZZ 
$strZZ 
:ZZ 
return[[ 
	JsonValue[[ $
.[[$ %
Create[[% +
([[+ ,
$"[[, .
{[[. /
rand[[/ 3
.[[3 4
Next[[4 8
([[8 9
$num[[9 :
,[[: ;
$num[[< >
)[[> ?
}[[? @
$str[[@ G
{[[G H
rand[[H L
.[[L M
Next[[M Q
([[Q R
$num[[R S
,[[S T
$num[[U W
)[[W X
}[[X Y
$str[[Y ]
"[[] ^
)[[^ _
;[[_ `
case]] 
$str]]  
:]]  !
return^^ 
	JsonValue^^ $
.^^$ %
Create^^% +
(^^+ ,
DateTime^^, 4
.^^4 5
UtcNow^^5 ;
.^^; <
ToString^^< D
(^^D E
$str^^E H
)^^H I
)^^I J
;^^J K
case`` 
$str`` 
:`` 
returnaa 
	JsonValueaa $
.aa$ %
Createaa% +
(aa+ ,
$"aa, .
$straa. 6
{aa6 7
randaa7 ;
.aa; <
Nextaa< @
(aa@ A
$numaaA B
,aaB C
$numaaD G
)aaG H
}aaH I
$straaI J
{aaJ K
randaaK O
.aaO P
NextaaP T
(aaT U
$numaaU V
,aaV W
$numaaX [
)aa[ \
}aa\ ]
"aa] ^
)aa^ _
;aa_ `
casecc 
$strcc 
:cc 
returndd 
	JsonValuedd $
.dd$ %
Createdd% +
(dd+ ,
stringdd, 2
.dd2 3
Joindd3 7
(dd7 8
$strdd8 ;
,dd; <

Enumerabledd= G
.ddG H
RangeddH M
(ddM N
$numddN O
,ddO P
$numddQ R
)ddR S
.ddS T
SelectddT Z
(ddZ [
_dd[ \
=>dd] _
randdd` d
.ddd e
Nextdde i
(ddi j
$numddj k
,ddk l
$numddm p
)ddp q
.ddq r
ToStringddr z
(ddz {
$strdd{ 
)	dd Ä
)
ddÄ Å
)
ddÅ Ç
)
ddÇ É
;
ddÉ Ñ
caseff 
$strff 
:ff 
returngg 
	JsonValuegg $
.gg$ %
Creategg% +
(gg+ ,
$"gg, .
$strgg. /
{gg/ 0
randgg0 4
.gg4 5
Nextgg5 9
(gg9 :
$numgg: <
,gg< =
$numgg> @
)gg@ A
}ggA B
$strggB F
"ggF G
)ggG H
;ggH I
caseii 
$strii !
:ii! "
returnjj 
	JsonValuejj $
.jj$ %
Createjj% +
(jj+ ,
$"jj, .
{jj. /
(jj/ 0
randjj0 4
.jj4 5

NextDoublejj5 ?
(jj? @
)jj@ A
*jjB C
$numjjD F
)jjF G
:jjG H
$strjjH J
}jjJ K
$strjjK N
"jjN O
)jjO P
;jjP Q
casell 
$strll 
:ll 
returnmm 
	JsonValuemm $
.mm$ %
Createmm% +
(mm+ ,
$strmm, ?
)mm? @
;mm@ A
caseoo 
$stroo 
:oo 
{pp 
varqq 
listqq  
=qq! "
newqq# &
	JsonArrayqq' 0
(qq0 1
)qq1 2
;qq2 3
intrr 
arrCountrr $
=rr% &
defrr' *
.rr* +
TryGetPropertyValuerr+ >
(rr> ?
$strrr? F
,rrF G
outrrH K
varrrL O
arrCountNoderrP \
)rr\ ]
&&rr^ `
intrra d
.rrd e
TryParserre m
(rrm n
arrCountNoderrn z
?rrz {
.rr{ |
ToString	rr| Ñ
(
rrÑ Ö
)
rrÖ Ü
,
rrÜ á
out
rrà ã
var
rrå è
c
rrê ë
)
rrë í
?
rrì î
c
rrï ñ
:
rró ò
$num
rrô ö
;
rrö õ
iftt 
(tt 
deftt 
.tt  
TryGetPropertyValuett  3
(tt3 4
$strtt4 <
,tt< =
outtt> A
varttB E
valNodettF M
)ttM N
&&ttO Q
valNodettR Y
isttZ \
	JsonArraytt] f

valTypeArrttg q
&&ttr t

valTypeArrttu 
.	tt Ä
Count
ttÄ Ö
>
ttÜ á
$num
ttà â
)
ttâ ä
{uu 
varvv 
elementTypevv  +
=vv, -

valTypeArrvv. 8
[vv8 9
$numvv9 :
]vv: ;
?vv; <
.vv< =
ToStringvv= E
(vvE F
)vvF G
??vvH J
$strvvK P
;vvP Q
forww 
(ww  !
intww! $
iww% &
=ww' (
$numww) *
;ww* +
iww, -
<ww. /
arrCountww0 8
;ww8 9
iww: ;
++ww; =
)ww= >
listxx  $
.xx$ %
Addxx% (
(xx( )
GenerateValuexx) 6
(xx6 7
elementTypexx7 B
,xxB C
defxxD G
,xxG H
randxxI M
)xxM N
)xxN O
;xxO P
returnyy "
listyy# '
;yy' (
}zz 
if|| 
(|| 
def|| 
.||  
TryGetPropertyValue||  3
(||3 4
$str||4 ;
,||; <
out||= @
var||A D
	itemsNode||E N
)||N O
&&||P R
	itemsNode||S \
is||] _

JsonObject||` j
itemDef||k r
)||r s
{}} 
for~~ 
(~~  !
int~~! $
i~~% &
=~~' (
$num~~) *
;~~* +
i~~, -
<~~. /
arrCount~~0 8
;~~8 9
i~~: ;
++~~; =
)~~= >
{ 
var
ÄÄ  #
element
ÄÄ$ +
=
ÄÄ, -
new
ÄÄ. 1

JsonObject
ÄÄ2 <
(
ÄÄ< =
)
ÄÄ= >
;
ÄÄ> ?
foreach
ÅÅ  '
(
ÅÅ( )
var
ÅÅ) ,
prop
ÅÅ- 1
in
ÅÅ2 4
itemDef
ÅÅ5 <
)
ÅÅ< =
{
ÇÇ  !
var
ÉÉ$ '
propName
ÉÉ( 0
=
ÉÉ1 2
prop
ÉÉ3 7
.
ÉÉ7 8
Key
ÉÉ8 ;
;
ÉÉ; <
if
ÑÑ$ &
(
ÑÑ' (
prop
ÑÑ( ,
.
ÑÑ, -
Value
ÑÑ- 2
is
ÑÑ3 5

JsonObject
ÑÑ6 @

propSchema
ÑÑA K
&&
ÑÑL N

propSchema
ÑÑO Y
.
ÑÑY Z!
TryGetPropertyValue
ÑÑZ m
(
ÑÑm n
$str
ÑÑn t
,
ÑÑt u
out
ÑÑv y
var
ÑÑz }
typeNodeÑÑ~ Ü
)ÑÑÜ á
)ÑÑá à
{
ÖÖ$ %
element
ÜÜ( /
[
ÜÜ/ 0
propName
ÜÜ0 8
]
ÜÜ8 9
=
ÜÜ: ;
GenerateValue
ÜÜ< I
(
ÜÜI J
typeNode
ÜÜJ R
!
ÜÜR S
.
ÜÜS T
ToString
ÜÜT \
(
ÜÜ\ ]
)
ÜÜ] ^
,
ÜÜ^ _

propSchema
ÜÜ` j
,
ÜÜj k
rand
ÜÜl p
)
ÜÜp q
;
ÜÜq r
}
áá$ %
}
àà  !
list
ââ  $
.
ââ$ %
Add
ââ% (
(
ââ( )
element
ââ) 0
)
ââ0 1
;
ââ1 2
}
ää 
return
ãã "
list
ãã# '
;
ãã' (
}
åå 
for
éé 
(
éé 
int
éé  
i
éé! "
=
éé# $
$num
éé% &
;
éé& '
i
éé( )
<
éé* +
arrCount
éé, 4
;
éé4 5
i
éé6 7
++
éé7 9
)
éé9 :
list
èè  
.
èè  !
Add
èè! $
(
èè$ %
rand
èè% )
.
èè) *
Next
èè* .
(
èè. /
$num
èè/ 0
,
èè0 1
$num
èè2 5
)
èè5 6
)
èè6 7
;
èè7 8
return
ëë 
list
ëë #
;
ëë# $
}
íí 
case
ïï 
$str
ïï 
:
ïï 
if
ññ 
(
ññ 
def
ññ 
.
ññ !
TryGetPropertyValue
ññ /
(
ññ/ 0
$str
ññ0 8
,
ññ8 9
out
ññ: =
var
ññ> A
pickVals
ññB J
)
ññJ K
&&
ññL N
pickVals
ññO W
is
ññX Z
	JsonArray
ññ[ d
pickArr
ññe l
)
ññl m
{
óó 
var
òò 
shuffled
òò $
=
òò% &
pickArr
òò' .
.
òò. /
OrderBy
òò/ 6
(
òò6 7
_
òò7 8
=>
òò9 ;
rand
òò< @
.
òò@ A
Next
òòA E
(
òòE F
)
òòF G
)
òòG H
.
òòH I
Take
òòI M
(
òòM N
count
òòN S
)
òòS T
;
òòT U
var
ôô 
resultArray
ôô '
=
ôô( )
new
ôô* -
	JsonArray
ôô. 7
(
ôô7 8
)
ôô8 9
;
ôô9 :
foreach
öö 
(
öö  !
var
öö! $
item
öö% )
in
öö* ,
shuffled
öö- 5
)
öö5 6
{
õõ 
resultArray
úú '
.
úú' (
Add
úú( +
(
úú+ ,
item
úú, 0
?
úú0 1
.
úú1 2
	DeepClone
úú2 ;
(
úú; <
)
úú< =
)
úú= >
;
úú> ?
}
ùù 
return
ûû 
resultArray
ûû *
;
ûû* +
}
üü 
return
†† 
new
†† 
	JsonArray
†† (
(
††( )
)
††) *
;
††* +
case
¢¢ 
$str
¢¢ !
:
¢¢! "
case
££ 
$str
££  
:
££  !
case
§§ 
$str
§§  
:
§§  !
return
•• 
	JsonValue
•• $
.
••$ %
Create
••% +
(
••+ ,
$str
••, B
)
••B C
;
••C D
default
ßß 
:
ßß 
return
®® 
	JsonValue
®® $
.
®®$ %
Create
®®% +
(
®®+ ,
$str
®®, >
)
®®> ?
;
®®? @
}
©© 
}
™™ 	
}
´´ 
}¨¨ ’{
òC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Helpers\DeviceServiceHelper.cs
	namespace 	
Infrastructure
 
. 
Helpers  
{ 
public 

class 
DeviceServiceHelper $
:% & 
IDeviceServiceHelper' ;
{ 
private 
readonly 
ILogger  
<  !
DeviceService! .
>. /
_logger0 7
;7 8
private 
readonly 
IDynamicDataHelper +
_dynamicDataHelper, >
;> ?
private 
readonly 

HttpClient #
_httpClient$ /
;/ 0
public 
DeviceServiceHelper "
(" #
ILogger# *
<* +
DeviceService+ 8
>8 9
logger: @
,@ A
IDynamicDataHelperB T
dynamicDataHelperU f
,f g

HttpClienth r

httpClients }
)} ~
{ 	
_logger 
= 
logger 
; 
_dynamicDataHelper 
=  
dynamicDataHelper! 2
;2 3
_httpClient 
= 

httpClient $
;$ %
} 	
public !
TopLevelDeviceDataDto $
ExtractTopLevelDto% 7
(7 8
string8 >
macId? D
,D E
JsonNodeF N
rootNodeO W
)W X
{ 	
return   
new   !
TopLevelDeviceDataDto   ,
{!! 
DeviceMacId"" 
="" 
macId"" #
,""# $
Status## 
=## 
rootNode## !
[##! "
$str##" *
]##* +
?##+ ,
.##, -
GetValue##- 5
<##5 6
string##6 <
>##< =
(##= >
)##> ?
??##@ B
$str##C L
,##L M
Connectivity$$ 
=$$ 
rootNode$$ '
[$$' (
$str$$( 6
]$$6 7
?$$7 8
.$$8 9
GetValue$$9 A
<$$A B
string$$B H
>$$H I
($$I J
)$$J K
??$$L N
$str$$O X
}%% 
;%% 
}&& 	
public((  
DynamicDeviceDataDto(( #
ExtractDynamicDto(($ 5
(((5 6
string((6 <
macId((= B
,((B C
JsonNode((D L
rootNode((M U
)((U V
{)) 	
return** 
new**  
DynamicDeviceDataDto** +
{++ 
DeviceMacId,, 
=,, 
macId,, #
,,,# $
DynamicProperties-- !
=--" #
JsonDocument--$ 0
.--0 1
Parse--1 6
(--6 7
rootNode.. 
[.. 
$str.. 0
]..0 1
!..1 2
...2 3
ToJsonString..3 ?
(..? @
)..@ A
)// 
.// 
RootElement// 
}00 
;00 
}11 	
public33 
async33 
Task33 
WriteJsonFileAsync33 ,
(33, -
string33- 3
path334 8
,338 9
JsonNode33: B
rootNode33C K
)33K L
{44 	
string55 
json55 
=55 
rootNode55 "
.55" #
ToJsonString55# /
(55/ 0
new550 3!
JsonSerializerOptions554 I
{66 
Encoder77 
=77 
JavaScriptEncoder77 +
.77+ ,%
UnsafeRelaxedJsonEscaping77, E
,77E F
WriteIndented88 
=88 
true88  $
,88$ %
TypeInfoResolver99  
=99! "
new99# &'
DefaultJsonTypeInfoResolver99' B
(99B C
)99C D
}:: 
):: 
;:: 
await<< 
File<< 
.<< 
WriteAllTextAsync<< (
(<<( )
path<<) -
,<<- .
json<</ 3
)<<3 4
;<<4 5
}== 	
public?? 
async?? 
Task?? (
BroadcastDeviceDetailUpdates?? 6
(??6 7
List??7 ;
<??; <
(??< =
string??= C
MacId??D I
,??I J
string??K Q
	EventName??R [
,??[ \
JsonElement??] h
DetailPayload??i v
)??v w
>??w x
updates	??y Ä
)
??Ä Å
{@@ 	
foreachAA 
(AA 
varAA 
(AA 
macIdAA 
,AA  
	eventNameAA! *
,AA* +
payloadAA, 3
)AA3 4
inAA5 7
updatesAA8 ?
)AA? @
{BB 
varCC 
jsonCC 
=CC 
JsonSerializerCC )
.CC) *
	SerializeCC* 3
(CC3 4
payloadCC4 ;
,CC; <
newCC= @!
JsonSerializerOptionsCCA V
{DD 
EncoderEE 
=EE 
JavaScriptEncoderEE /
.EE/ 0%
UnsafeRelaxedJsonEscapingEE0 I
,EEI J
WriteIndentedFF !
=FF" #
trueFF$ (
}GG 
)GG 
;GG 
varII 
contentII 
=II 
newII !
StringContentII" /
(II/ 0
jsonII0 4
,II4 5
EncodingII6 >
.II> ?
UTF8II? C
,IIC D
$strIIE W
)IIW X
;IIX Y
awaitJJ 
_httpClientJJ !
.JJ! "
	PostAsyncJJ" +
(JJ+ ,
$"JJ, .
$strJJ. f
{JJf g
macIdJJg l
}JJl m
"JJm n
,JJn o
contentJJp w
)JJw x
;JJx y
}KK 
}LL 	
publicNN 
asyncNN 
TaskNN $
BroadcastTopLevelSummaryNN 2
(NN2 3
ListNN3 7
<NN7 8
(NN8 9
DeviceMetadataNN9 G
deviceNNH N
,NNN O
ListNNP T
<NNT U
stringNNU [
>NN[ \
updatedFieldsNN] j
)NNj k
>NNk l

allDevicesNNm w
)NNw x
{OO 	
varPP 
summaryPP 
=PP 

allDevicesPP $
.PP$ %
SelectPP% +
(PP+ ,
entryPP, 1
=>PP2 4
{QQ 
varRR 
dRR 
=RR 
entryRR 
.RR 
deviceRR $
;RR$ %
varSS 
updatedSS 
=SS 
entrySS #
.SS# $
updatedFieldsSS$ 1
;SS1 2
varUU 
objUU 
=UU 
newUU 

DictionaryUU (
<UU( )
stringUU) /
,UU/ 0
objectUU1 7
?UU7 8
>UU8 9
{VV 
{WW  !
$strWW" )
,WW) *
dWW+ ,
.WW, -
MacIdWW- 2
}WW3 4
,WW4 5
{XX  !
$strXX" /
,XX/ 0
dXX1 2
.XX2 3
LastUpdatedXX3 >
}XX? @
}YY 
;YY 
if[[ 
([[ 
updated[[ 
.[[ 
Contains[[ $
([[$ %
$str[[% -
)[[- .
)[[. /
obj\\ 
[\\ 
$str\\  
]\\  !
=\\" #
d\\$ %
.\\% &
Status\\& ,
;\\, -
if^^ 
(^^ 
updated^^ 
.^^ 
Contains^^ $
(^^$ %
$str^^% 3
)^^3 4
)^^4 5
obj__ 
[__ 
$str__ &
]__& '
=__( )
d__* +
.__+ ,
Connectivity__, 8
;__8 9
returnaa 
objaa 
;aa 
}bb 
)bb 
.bb 
ToListbb 
(bb 
)bb 
;bb 
vardd 
jsondd 
=dd 
JsonSerializerdd %
.dd% &
	Serializedd& /
(dd/ 0
summarydd0 7
,dd7 8
newdd9 <!
JsonSerializerOptionsdd= R
{ee 
Encoderff 
=ff 
JavaScriptEncoderff +
.ff+ ,%
UnsafeRelaxedJsonEscapingff, E
,ffE F
WriteIndentedgg 
=gg 
truegg  $
}hh 
)hh 
;hh 
varjj 
contentjj 
=jj 
newjj 
StringContentjj +
(jj+ ,
jsonjj, 0
,jj0 1
Encodingjj2 :
.jj: ;
UTF8jj; ?
,jj? @
$strjjA S
)jjS T
;jjT U
awaitkk 
_httpClientkk 
.kk 
	PostAsynckk '
(kk' (
$strkk( [
,kk[ \
contentkk] d
)kkd e
;kke f
}ll 	
publicnn 
JsonNodenn #
UpdateDynamicPropertiesnn /
(nn/ 0
JsonNodenn0 8
?nn8 9
currentDatann: E
,nnE F
JsonNodennG O
?nnO P
dynamicObservablesnnQ c
)nnc d
{oo 	
varpp 
originalpp 
=pp 
currentDatapp &
?pp& '
.pp' (
	DeepClonepp( 1
(pp1 2
)pp2 3
??pp4 6
newpp7 :

JsonObjectpp; E
(ppE F
)ppF G
;ppG H
varrr 
resultrr 
=rr 
_dynamicDataHelperrr +
.rr+ ,.
"GenerateDynamicDataFromObservablesrr, N
(rrN O
currentDatarrO Z
,rrZ [
dynamicObservablesrr\ n
)rrn o
;rro p
vartt 
difftt 
=tt 
GetJsonDifftt "
(tt" #
originaltt# +
,tt+ ,
resulttt- 3
)tt3 4
;tt4 5
returnuu 
diffuu 
;uu 
}vv 	
publicxx 
staticxx 
JsonNodexx 
?xx 
GetJsonDiffxx  +
(xx+ ,
JsonNodexx, 4
?xx4 5
originalxx6 >
,xx> ?
JsonNodexx@ H
?xxH I
updatedxxJ Q
)xxQ R
{yy 	
ifzz 
(zz 
originalzz 
iszz 
	JsonValuezz %
&&zz& (
updatedzz) 0
iszz1 3
	JsonValuezz4 =
)zz= >
{{{ 
return|| 
original|| 
.||  
ToJsonString||  ,
(||, -
)||- .
==||/ 1
updated||2 9
.||9 :
ToJsonString||: F
(||F G
)||G H
?||I J
null||K O
:||P Q
	CloneNode||R [
(||[ \
updated||\ c
)||c d
;||d e
}}} 
if 
( 
original 
is 

JsonObject &
origObj' .
&&/ 1
updated2 9
is: <

JsonObject= G

updatedObjH R
)R S
{
ÄÄ 
var
ÅÅ 
diff
ÅÅ 
=
ÅÅ 
new
ÅÅ 

JsonObject
ÅÅ )
(
ÅÅ) *
)
ÅÅ* +
;
ÅÅ+ ,
foreach
ÉÉ 
(
ÉÉ 
var
ÉÉ 
kvp
ÉÉ  
in
ÉÉ! #

updatedObj
ÉÉ$ .
)
ÉÉ. /
{
ÑÑ 
var
ÖÖ 
	origChild
ÖÖ !
=
ÖÖ" #
origObj
ÖÖ$ +
.
ÖÖ+ ,
ContainsKey
ÖÖ, 7
(
ÖÖ7 8
kvp
ÖÖ8 ;
.
ÖÖ; <
Key
ÖÖ< ?
)
ÖÖ? @
?
ÖÖA B
origObj
ÖÖC J
[
ÖÖJ K
kvp
ÖÖK N
.
ÖÖN O
Key
ÖÖO R
]
ÖÖR S
:
ÖÖT U
null
ÖÖV Z
;
ÖÖZ [
var
ÜÜ 
updatedChild
ÜÜ $
=
ÜÜ% &
kvp
ÜÜ' *
.
ÜÜ* +
Value
ÜÜ+ 0
;
ÜÜ0 1
var
àà 
	childDiff
àà !
=
àà" #
GetJsonDiff
àà$ /
(
àà/ 0
	origChild
àà0 9
,
àà9 :
updatedChild
àà; G
)
ààG H
;
ààH I
if
ââ 
(
ââ 
	childDiff
ââ !
!=
ââ" $
null
ââ% )
)
ââ) *
diff
ää 
[
ää 
kvp
ää  
.
ää  !
Key
ää! $
]
ää$ %
=
ää& '
	childDiff
ää( 1
;
ää1 2
}
ãã 
return
çç 
diff
çç 
.
çç 
Count
çç !
>
çç" #
$num
çç$ %
?
çç& '
diff
çç( ,
:
çç- .
null
çç/ 3
;
çç3 4
}
éé 
if
êê 
(
êê 
original
êê 
is
êê 
	JsonArray
êê %
	origArray
êê& /
&&
êê0 2
updated
êê3 :
is
êê; =
	JsonArray
êê> G
updatedArray
êêH T
)
êêT U
{
ëë 
var
íí 
	arrayDiff
íí 
=
íí 
new
íí  #
	JsonArray
íí$ -
(
íí- .
)
íí. /
;
íí/ 0
bool
ìì 

hasChanges
ìì 
=
ìì  !
false
ìì" '
;
ìì' (
int
ïï 
	maxLength
ïï 
=
ïï 
Math
ïï  $
.
ïï$ %
Max
ïï% (
(
ïï( )
	origArray
ïï) 2
.
ïï2 3
Count
ïï3 8
,
ïï8 9
updatedArray
ïï: F
.
ïïF G
Count
ïïG L
)
ïïL M
;
ïïM N
for
ññ 
(
ññ 
int
ññ 
i
ññ 
=
ññ 
$num
ññ 
;
ññ 
i
ññ  !
<
ññ" #
	maxLength
ññ$ -
;
ññ- .
i
ññ/ 0
++
ññ0 2
)
ññ2 3
{
óó 
JsonNode
òò 
?
òò 
origElem
òò &
=
òò' (
i
òò) *
<
òò+ ,
	origArray
òò- 6
.
òò6 7
Count
òò7 <
?
òò= >
	origArray
òò? H
[
òòH I
i
òòI J
]
òòJ K
:
òòL M
null
òòN R
;
òòR S
JsonNode
ôô 
?
ôô 
updatedElem
ôô )
=
ôô* +
i
ôô, -
<
ôô. /
updatedArray
ôô0 <
.
ôô< =
Count
ôô= B
?
ôôC D
updatedArray
ôôE Q
[
ôôQ R
i
ôôR S
]
ôôS T
:
ôôU V
null
ôôW [
;
ôô[ \
var
õõ 
	childDiff
õõ !
=
õõ" #
GetJsonDiff
õõ$ /
(
õõ/ 0
origElem
õõ0 8
,
õõ8 9
updatedElem
õõ: E
)
õõE F
;
õõF G
if
ùù 
(
ùù 
	childDiff
ùù !
!=
ùù" $
null
ùù% )
)
ùù) *
{
ûû 
	arrayDiff
üü !
.
üü! "
Add
üü" %
(
üü% &
	childDiff
üü& /
)
üü/ 0
;
üü0 1

hasChanges
†† "
=
††# $
true
††% )
;
††) *
}
°° 
}
¢¢ 
return
§§ 

hasChanges
§§ !
?
§§" #
	arrayDiff
§§$ -
:
§§. /
null
§§0 4
;
§§4 5
}
•• 
return
ßß 
	CloneNode
ßß 
(
ßß 
updated
ßß $
)
ßß$ %
;
ßß% &
}
®® 	
private
™™ 
static
™™ 
JsonNode
™™ 
?
™™  
	CloneNode
™™! *
(
™™* +
JsonNode
™™+ 3
?
™™3 4
node
™™5 9
)
™™9 :
{
´´ 	
return
¨¨ 
node
¨¨ 
==
¨¨ 
null
¨¨ 
?
¨¨  !
null
¨¨" &
:
¨¨' (
JsonNode
¨¨) 1
.
¨¨1 2
Parse
¨¨2 7
(
¨¨7 8
node
¨¨8 <
.
¨¨< =
ToJsonString
¨¨= I
(
¨¨I J
)
¨¨J K
)
¨¨K L
;
¨¨L M
}
≠≠ 	
}
ÆÆ 
}ØØ ≥ú
ìC:\Users\Premal Kadam\Documents\Device Monitoring Project\DeviceMonitoring\Backend\DeviceMonitoringProject\Infrastructure\Cache\DeviceStateCache.cs
	namespace 	
Infrastructure
 
. 
Cache 
{ 
public 

class 
DeviceState 
{ 
public 
JsonNode 
Root 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
default- 4
!4 5
;5 6
public 
DateTime 
LastUpdated #
{$ %
get& )
;) *
set+ .
;. /
}0 1
} 
public 

class 
DeviceStateCache !
{ 
private   
readonly   
string   
_dataDirectory    .
=  / 0
Path  1 5
.  5 6
Combine  6 =
(  = >
	Directory  > G
.  G H
	GetParent  H Q
(  Q R
	Directory  R [
.  [ \
GetCurrentDirectory  \ o
(  o p
)  p q
)  q r
!  r s
.  s t
FullName  t |
,  | }
$str	  ~ é
,
  é è
$str
  ê ñ
)
  ñ ó
;
  ó ò
private$$ 
readonly$$ 
ILogger$$  
<$$  !)
DeviceStatePersistenceService$$! >
>$$> ?
_logger$$@ G
;$$G H
private%% 
readonly%%  
ConcurrentDictionary%% -
<%%- .
string%%. 4
,%%4 5
DeviceState%%6 A
>%%A B

_deviceMap%%C M
=%%N O
new%%P S
(%%S T
)%%T U
;%%U V
private&& 
readonly&& 

Dictionary&& #
<&&# $
string&&$ *
,&&* +
string&&, 2
>&&2 3
_fileMap&&4 <
=&&= >
new&&? B
(&&B C
)&&C D
;&&D E
private'' 
readonly''  
ConcurrentDictionary'' -
<''- .
string''. 4
,''4 5
SemaphoreSlim''6 C
>''C D
_locks''E K
=''L M
new''N Q
(''Q R
)''R S
;''S T
private(( 
readonly(( 
bool(( 
_useDatabase(( *
;((* +
private)) 
readonly)) 
IServiceProvider)) )
_serviceProvider))* :
;)): ;
private** 
static** 
readonly** 
SemaphoreSlim**  -
_dbLock**. 5
=**6 7
new**8 ;
(**; <
$num**< =
,**= >
$num**? @
)**@ A
;**A B
public,, 
DeviceStateCache,, 
(,,  
ILogger-- 
<-- )
DeviceStatePersistenceService-- -
>--- .
logger--/ 5
,--5 6
IOptions.. 
<..  
DeviceStorageOptions.. %
>..% &
options..' .
,... /
IServiceProvider// 
serviceProvider// (
)//( )
{00 	
_logger11 
=11 
logger11 
;11 
_useDatabase22 
=22 
options22 "
.22" #
Value22# (
.22( )
UseDatabase22) 4
;224 5
_serviceProvider33 
=33 
serviceProvider33 .
;33. /
}44 	
public66  
ConcurrentDictionary66 #
<66# $
string66$ *
,66* +
DeviceState66, 7
>667 8
GetAllStates669 E
(66E F
)66F G
=>66H J

_deviceMap66K U
;66U V
public88 
async88 
Task88 
	LoadAsync88 #
(88# $
)88$ %
{99 	

_deviceMap:: 
.:: 
Clear:: 
(:: 
):: 
;:: 
if;; 
(;; 
_useDatabase;; 
);; 
{<< 
await== !
LoadFromDatabaseAsync== +
(==+ ,
)==, -
;==- .
}>> 
else?? 
{@@ 
awaitAA 
LoadFromFilesAsyncAA (
(AA( )
)AA) *
;AA* +
}BB 
}CC 	
privateEE 
asyncEE 
TaskEE !
LoadFromDatabaseAsyncEE 0
(EE0 1
)EE1 2
{FF 	
usingGG 
varGG 
scopeGG 
=GG 
_serviceProviderGG .
.GG. /
CreateScopeGG/ :
(GG: ;
)GG; <
;GG< =
varHH 
	dbContextHH 
=HH 
scopeHH !
.HH! "
ServiceProviderHH" 1
.HH1 2
GetRequiredServiceHH2 D
<HHD E
DeviceDbContextHHE T
>HHT U
(HHU V
)HHV W
;HHW X
varII 
devicesII 
=II 
awaitII 
	dbContextII  )
.II) *
DevicesII* 1
.II1 2
ToListAsyncII2 =
(II= >
)II> ?
;II? @
foreachKK 
(KK 
varKK 
deviceKK 
inKK  "
devicesKK# *
)KK* +
{LL 
varMM 
rootMM 
=MM 
newMM 

JsonObjectMM )
{NN 
[OO 
$strOO 
]OO 
=OO 
deviceOO  &
.OO& '
MacIdOO' ,
,OO, -
[PP 
$strPP 
]PP 
=PP 
devicePP %
.PP% &
NamePP& *
,PP* +
[QQ 
$strQQ 
]QQ 
=QQ 
deviceQQ %
.QQ% &
TypeQQ& *
,QQ* +
[RR 
$strRR 
]RR 
=RR  
deviceRR! '
.RR' (
StatusRR( .
,RR. /
[SS 
$strSS #
]SS# $
=SS% &
deviceSS' -
.SS- .
ConnectivitySS. :
,SS: ;
[TT 
$strTT "
]TT" #
=TT$ %
deviceTT& ,
.TT, -
LastUpdatedTT- 8
,TT8 9
[UU 
$strUU '
]UU' (
=UU) *
JsonNodeUU+ 3
.UU3 4
ParseUU4 9
(UU9 :
deviceUU: @
.UU@ A
StaticPropertiesUUA Q
)UUQ R
,UUR S
[VV 
$strVV (
]VV( )
=VV* +
JsonNodeVV, 4
.VV4 5
ParseVV5 :
(VV: ;
deviceVV; A
.VVA B
DynamicPropertiesVVB S
)VVS T
,VVT U
[WW 
$strWW *
]WW* +
=WW, -
JsonNodeWW. 6
.WW6 7
ParseWW7 <
(WW< =
deviceWW= C
.WWC D
TopLevelObservablesWWD W
)WWW X
,WWX Y
[XX 
$strXX )
]XX) *
=XX+ ,
JsonNodeXX- 5
.XX5 6
ParseXX6 ;
(XX; <
deviceXX< B
.XXB C
DynamicObservablesXXC U
)XXU V
}YY 
;YY 

_deviceMap[[ 
[[[ 
device[[ !
.[[! "
MacId[[" '
][[' (
=[[) *
new[[+ .
DeviceState[[/ :
{\\ 
Root]] 
=]] 
root]] 
,]]  
LastUpdated^^ 
=^^  !
device^^" (
.^^( )
LastUpdated^^) 4
}__ 
;__ 
}`` 
}aa 	
privatecc 
asynccc 
Taskcc 
LoadFromFilesAsynccc -
(cc- .
)cc. /
{dd 	
varee 
deviceFilesee 
=ee 
	Directoryee '
.ee' (
GetFilesee( 0
(ee0 1
_dataDirectoryee1 ?
,ee? @
$streeA I
)eeI J
;eeJ K
foreachff 
(ff 
varff 
fileff 
inff  
deviceFilesff! ,
)ff, -
{gg 
tryhh 
{ii 
varjj 
statejj 
=jj 
awaitjj  % 
ParseDeviceFileAsyncjj& :
(jj: ;
filejj; ?
)jj? @
;jj@ A
ifkk 
(kk 
statekk 
!=kk  
nullkk! %
)kk% &
{ll 
varmm 
macIdmm !
=mm" #
statemm$ )
.mm) *
Rootmm* .
[mm. /
$strmm/ 6
]mm6 7
!mm7 8
.mm8 9
ToStringmm9 A
(mmA B
)mmB C
;mmC D

_deviceMapnn "
[nn" #
macIdnn# (
]nn( )
=nn* +
statenn, 1
;nn1 2
_fileMapoo  
[oo  !
macIdoo! &
]oo& '
=oo( )
Pathoo* .
.oo. /
GetFileNameoo/ :
(oo: ;
fileoo; ?
)oo? @
;oo@ A
}pp 
}qq 
catchrr 
(rr 
	Exceptionrr  
exrr! #
)rr# $
{ss 
_loggertt 
.tt 
LogErrortt $
(tt$ %
extt% '
,tt' (
$strtt) E
,ttE F
filettG K
)ttK L
;ttL M
}uu 
}vv 
}ww 	
privateyy 
asyncyy 
Taskyy 
<yy 
DeviceStateyy &
?yy& '
>yy' ( 
ParseDeviceFileAsyncyy) =
(yy= >
stringyy> D
fileyyE I
)yyI J
{zz 	
var{{ 
json{{ 
={{ 
await{{ 
File{{ !
.{{! "
ReadAllTextAsync{{" 2
({{2 3
file{{3 7
){{7 8
;{{8 9
var|| 
node|| 
=|| 
JsonNode|| 
.||  
Parse||  %
(||% &
json||& *
)||* +
!||+ ,
;||, -
DateTime~~ 
lastUpdated~~  
=~~! "
DateTime~~# +
.~~+ ,
UtcNow~~, 2
;~~2 3
if 
( 
node 
[ 
$str "
]" #
is$ &
	JsonValue' 0
ts1 3
&&4 6
DateTime
ÄÄ 
.
ÄÄ 
TryParse
ÄÄ !
(
ÄÄ! "
ts
ÄÄ" $
.
ÄÄ$ %
ToString
ÄÄ% -
(
ÄÄ- .
)
ÄÄ. /
,
ÄÄ/ 0
out
ÄÄ1 4
var
ÄÄ5 8

parsedDate
ÄÄ9 C
)
ÄÄC D
)
ÄÄD E
lastUpdated
ÅÅ 
=
ÅÅ 

parsedDate
ÅÅ (
;
ÅÅ( )
return
ÉÉ 
new
ÉÉ 
DeviceState
ÉÉ "
{
ÑÑ 
Root
ÖÖ 
=
ÖÖ 
node
ÖÖ 
,
ÖÖ 
LastUpdated
ÜÜ 
=
ÜÜ 
lastUpdated
ÜÜ )
}
áá 
;
áá 
}
àà 	
public
ää 
JsonNode
ää 
?
ää 
GetDeviceState
ää '
(
ää' (
string
ää( .
macId
ää/ 4
)
ää4 5
{
ãã 	
return
åå 

_deviceMap
åå 
.
åå 
TryGetValue
åå )
(
åå) *
macId
åå* /
,
åå/ 0
out
åå1 4
var
åå5 8
state
åå9 >
)
åå> ?
?
åå@ A
state
ååB G
.
ååG H
Root
ååH L
:
ååM N
null
ååO S
;
ååS T
}
çç 	
public
èè 
async
èè 
Task
èè 
WithLock
èè "
(
èè" #
string
èè# )
macId
èè* /
,
èè/ 0
Func
èè1 5
<
èè5 6
JsonNode
èè6 >
,
èè> ?
Task
èè@ D
>
èèD E
updateFn
èèF N
)
èèN O
{
êê 	
var
ëë 
sem
ëë 
=
ëë 
_locks
ëë 
.
ëë 
GetOrAdd
ëë %
(
ëë% &
macId
ëë& +
,
ëë+ ,
_
ëë- .
=>
ëë/ 1
new
ëë2 5
SemaphoreSlim
ëë6 C
(
ëëC D
$num
ëëD E
,
ëëE F
$num
ëëG H
)
ëëH I
)
ëëI J
;
ëëJ K
await
íí 
sem
íí 
.
íí 
	WaitAsync
íí 
(
íí  
)
íí  !
;
íí! "
try
ìì 
{
îî 
if
ïï 
(
ïï 

_deviceMap
ïï 
.
ïï 
TryGetValue
ïï *
(
ïï* +
macId
ïï+ 0
,
ïï0 1
out
ïï2 5
var
ïï6 9
state
ïï: ?
)
ïï? @
)
ïï@ A
{
ññ 
await
óó 
updateFn
óó "
(
óó" #
state
óó# (
.
óó( )
Root
óó) -
)
óó- .
;
óó. /
}
òò 
}
ôô 
finally
öö 
{
õõ 
sem
úú 
.
úú 
Release
úú 
(
úú 
)
úú 
;
úú 
}
ùù 
}
ûû 	
public
†† 
void
†† 
UpdateLastUpdated
†† %
(
††% &
string
††& ,
macId
††- 2
,
††2 3
DateTime
††4 <
now
††= @
)
††@ A
{
°° 	
if
¢¢ 
(
¢¢ 

_deviceMap
¢¢ 
.
¢¢ 
TryGetValue
¢¢ &
(
¢¢& '
macId
¢¢' ,
,
¢¢, -
out
¢¢. 1
var
¢¢2 5
state
¢¢6 ;
)
¢¢; <
)
¢¢< =
{
££ 
state
§§ 
.
§§ 
LastUpdated
§§ !
=
§§" #
now
§§$ '
;
§§' (
}
•• 
}
¶¶ 	
public
®® 
async
®® 
Task
®®  
PersistToDiskAsync
®® ,
(
®®, -
)
®®- .
{
©© 	
await
™™ 
_dbLock
™™ 
.
™™ 
	WaitAsync
™™ #
(
™™# $
)
™™$ %
;
™™% &
try
´´ 
{
¨¨ 
if
≠≠ 
(
≠≠ 
_useDatabase
≠≠  
)
≠≠  !
{
ÆÆ 
await
ØØ $
PersistToDatabaseAsync
ØØ 0
(
ØØ0 1
)
ØØ1 2
;
ØØ2 3
}
∞∞ 
else
±± 
{
≤≤ 
await
≥≥ !
PersistToFilesAsync
≥≥ -
(
≥≥- .
)
≥≥. /
;
≥≥/ 0
}
¥¥ 
}
µµ 
finally
∂∂ 
{
∑∑ 
_dbLock
∏∏ 
.
∏∏ 
Release
∏∏ 
(
∏∏  
)
∏∏  !
;
∏∏! "
}
ππ 
}
∫∫ 	
private
ºº 
async
ºº 
Task
ºº $
PersistToDatabaseAsync
ºº 1
(
ºº1 2
)
ºº2 3
{
ΩΩ 	
using
ææ 
var
ææ 
scope
ææ 
=
ææ 
_serviceProvider
ææ .
.
ææ. /
CreateScope
ææ/ :
(
ææ: ;
)
ææ; <
;
ææ< =
var
øø 
	dbContext
øø 
=
øø 
scope
øø !
.
øø! "
ServiceProvider
øø" 1
.
øø1 2 
GetRequiredService
øø2 D
<
øøD E
DeviceDbContext
øøE T
>
øøT U
(
øøU V
)
øøV W
;
øøW X
await
¿¿ 
	dbContext
¿¿ 
.
¿¿ 
Database
¿¿ $
.
¿¿$ % 
ExecuteSqlRawAsync
¿¿% 7
(
¿¿7 8
$str
¿¿8 R
)
¿¿R S
;
¿¿S T
foreach
¬¬ 
(
¬¬ 
var
¬¬ 
kvp
¬¬ 
in
¬¬ 

_deviceMap
¬¬  *
)
¬¬* +
{
√√ 
var
ƒƒ 
macId
ƒƒ 
=
ƒƒ 
kvp
ƒƒ 
.
ƒƒ  
Key
ƒƒ  #
;
ƒƒ# $
var
≈≈ 
state
≈≈ 
=
≈≈ 
kvp
≈≈ 
.
≈≈  
Value
≈≈  %
;
≈≈% &
state
∆∆ 
.
∆∆ 
LastUpdated
∆∆ !
=
∆∆" #
DateTime
∆∆$ ,
.
∆∆, -
UtcNow
∆∆- 3
;
∆∆3 4
state
«« 
.
«« 
Root
«« 
[
«« 
$str
«« (
]
««( )
=
««* +
state
««, 1
.
««1 2
LastUpdated
««2 =
;
««= >
var
…… 
device
…… 
=
…… 
await
…… "
	dbContext
……# ,
.
……, -
Devices
……- 4
.
……4 5!
FirstOrDefaultAsync
……5 H
(
……H I
d
……I J
=>
……K M
d
……N O
.
……O P
MacId
……P U
==
……V X
macId
……Y ^
)
……^ _
;
……_ `
if
   
(
   
device
   
!=
   
null
   "
)
  " #
{
ÀÀ 
device
ÕÕ 
.
ÕÕ 
DynamicProperties
ÕÕ ,
=
ÕÕ- .
state
ÕÕ/ 4
.
ÕÕ4 5
Root
ÕÕ5 9
[
ÕÕ9 :
$str
ÕÕ: M
]
ÕÕM N
!
ÕÕN O
.
ÕÕO P
ToJsonString
ÕÕP \
(
ÕÕ\ ]
)
ÕÕ] ^
;
ÕÕ^ _
device
ŒŒ 
.
ŒŒ 
Status
ŒŒ !
=
ŒŒ" #
state
ŒŒ$ )
.
ŒŒ) *
Root
ŒŒ* .
[
ŒŒ. /
$str
ŒŒ/ 7
]
ŒŒ7 8
?
ŒŒ8 9
.
ŒŒ9 :
ToString
ŒŒ: B
(
ŒŒB C
)
ŒŒC D
;
ŒŒD E
device
œœ 
.
œœ 
Connectivity
œœ '
=
œœ( )
state
œœ* /
.
œœ/ 0
Root
œœ0 4
[
œœ4 5
$str
œœ5 C
]
œœC D
?
œœD E
.
œœE F
ToString
œœF N
(
œœN O
)
œœO P
;
œœP Q
device
““ 
.
““ 
LastUpdated
““ &
=
““' (
state
““) .
.
““. /
LastUpdated
““/ :
;
““: ;
}
”” 
}
‘‘ 
await
’’ 
	dbContext
’’ 
.
’’ 
SaveChangesAsync
’’ ,
(
’’, -
)
’’- .
;
’’. /
}
÷÷ 	
private
ÿÿ 
async
ÿÿ 
Task
ÿÿ !
PersistToFilesAsync
ÿÿ .
(
ÿÿ. /
)
ÿÿ/ 0
{
ŸŸ 	
foreach
⁄⁄ 
(
⁄⁄ 
var
⁄⁄ 
kvp
⁄⁄ 
in
⁄⁄ 

_deviceMap
⁄⁄  *
)
⁄⁄* +
{
€€ 
var
‹‹ 
state
‹‹ 
=
‹‹ 
kvp
‹‹ 
.
‹‹  
Value
‹‹  %
;
‹‹% &
state
›› 
.
›› 
LastUpdated
›› !
=
››" #
DateTime
››$ ,
.
››, -
UtcNow
››- 3
;
››3 4
state
ﬁﬁ 
.
ﬁﬁ 
Root
ﬁﬁ 
[
ﬁﬁ 
$str
ﬁﬁ (
]
ﬁﬁ( )
=
ﬁﬁ* +
state
ﬁﬁ, 1
.
ﬁﬁ1 2
LastUpdated
ﬁﬁ2 =
;
ﬁﬁ= >
_fileMap
‡‡ 
.
‡‡ 
TryGetValue
‡‡ $
(
‡‡$ %
kvp
‡‡% (
.
‡‡( )
Key
‡‡) ,
,
‡‡, -
out
‡‡. 1
var
‡‡2 5
fileName
‡‡6 >
)
‡‡> ?
;
‡‡? @
var
·· 
path
·· 
=
·· 
Path
·· 
.
··  
Combine
··  '
(
··' (
_dataDirectory
··( 6
,
··6 7
fileName
··8 @
??
··@ B
$str
··B D
)
··D E
;
··E F
if
‚‚ 
(
‚‚ 
File
‚‚ 
.
‚‚ 
Exists
‚‚ 
(
‚‚  
path
‚‚  $
)
‚‚$ %
)
‚‚% &
{
„„ 
await
‰‰ 
File
‰‰ 
.
‰‰ 
WriteAllTextAsync
‰‰ 0
(
‰‰0 1
path
‰‰1 5
,
‰‰5 6
state
‰‰7 <
.
‰‰< =
Root
‰‰= A
.
‰‰A B
ToJsonString
‰‰B N
(
‰‰N O
new
‰‰O R#
JsonSerializerOptions
‰‰S h
{
ÂÂ 
WriteIndented
ÊÊ %
=
ÊÊ& '
true
ÊÊ( ,
}
ÁÁ 
)
ÁÁ 
)
ÁÁ 
;
ÁÁ 
}
ËË 
}
ÈÈ 
}
ÍÍ 	
}
ÎÎ 
}ÏÏ 